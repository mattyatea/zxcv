name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.0, v1.2.0-beta.1, v1.2.0-alpha.1)'
        required: true
        type: string

# Prevent multiple release preparations from running simultaneously
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare-release:
    name: Prepare Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: |
          # Set Prisma engine download timeout and retry
          export PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1
          export PRISMA_ENGINES_MIRROR=https://binaries.prisma.sh
          
          # Retry mechanism for network issues
          n=0
          until [ "$n" -ge 3 ]
          do
             pnpm run prisma:generate && break
             n=$((n+1))
             echo "Attempt $n failed, retrying in 5 seconds..."
             sleep 5
          done
          
          if [ "$n" -ge 3 ]; then
            echo "Failed to generate Prisma Client after 3 attempts"
            exit 1
          fi

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch
        id: branch
        run: |
          BRANCH_NAME="release/${{ inputs.version }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Ensure we're starting from the correct base
          git checkout dev
          git pull origin dev
          
          # Check if branch already exists locally
          if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
            echo "âš ï¸ Local branch $BRANCH_NAME already exists, deleting it"
            git branch -D "$BRANCH_NAME"
          fi
          
          # Check if branch exists on remote
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ Remote branch $BRANCH_NAME already exists"
            echo "This might be from a previous release attempt"
            echo "Deleting remote branch and creating fresh one"
            git push origin --delete "$BRANCH_NAME" || true
          fi
          
          # Create fresh branch from dev
          git checkout -b "$BRANCH_NAME"
          echo "Created new release branch: $BRANCH_NAME from dev"

      - name: Update package versions
        id: versions
        run: |
          VERSION="${{ inputs.version }}"
          # Remove 'v' prefix if present
          VERSION_NUMBER=${VERSION#v}
          
          echo "Updating versions to $VERSION_NUMBER"
          
          # Update server package.json if it exists
          if [ -f "server/package.json" ]; then
            jq ".version = \"$VERSION_NUMBER\"" server/package.json > server/package.json.tmp
            mv server/package.json.tmp server/package.json
            echo "âœ… Updated server/package.json to $VERSION_NUMBER"
          fi
          
          # Update CLI package.json - always included
          if [ -f "cli/package.json" ]; then
            jq ".version = \"$VERSION_NUMBER\"" cli/package.json > cli/package.json.tmp
            mv cli/package.json.tmp cli/package.json
            echo "âœ… Updated cli/package.json to $VERSION_NUMBER"
          fi
          
          # Update root package.json if it exists
          if [ -f "package.json" ]; then
            jq ".version = \"$VERSION_NUMBER\"" package.json > package.json.tmp
            mv package.json.tmp package.json
            echo "âœ… Updated root package.json to $VERSION_NUMBER"
          fi
          
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          echo "Generating changelog for ${{ inputs.version }}"
          
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog since $LATEST_TAG"
            CHANGELOG=$(git log $LATEST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Create changelog content
          cat > CHANGELOG_TEMP.md << EOF
          # Release ${{ inputs.version }}
          
          ## Changes
          
          $CHANGELOG
          
          ## Release Notes

          This release includes:
          - Server application updates
          - CLI tool updates
          - Bug fixes and improvements
          - Performance optimizations
          
          ## Deployment
          
          - **Staging**: Automatically deployed when merged to \`dev\`
          - **Production**: Automatically deployed when merged to \`main\`
          
          EOF
          
          # Save changelog content for PR body
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG_TEMP.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and verify
        run: |
          echo "ğŸ”¨ Building applications..."
          
          # Build server application
          if ! pnpm run build:server; then
            echo "âŒ Server build failed!"
            echo "Please check server code and dependencies before creating release."
            exit 1
          fi
          
          echo "âœ… Server build successful!"

          # Build CLI - always included
          echo "ğŸ”¨ Building CLI application..."
            
            # Setup Bun for CLI builds with error handling
            if ! curl -fsSL https://bun.sh/install | bash; then
              echo "âŒ Failed to install Bun runtime!"
              echo "CLI build cannot proceed without Bun."
              exit 1
            fi
            
            export PATH="$HOME/.bun/bin:$PATH"
            
            # Verify Bun installation
            if ! command -v bun >/dev/null 2>&1; then
              echo "âŒ Bun command not found after installation!"
              exit 1
            fi
            
            cd cli || {
              echo "âŒ CLI directory not found!"
              exit 1
            }
            
            # Install CLI dependencies with retry
            RETRY_COUNT=0
            MAX_RETRIES=3
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if bun install; then
                echo "âœ… CLI dependencies installed successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸ CLI dependency installation failed (attempt $RETRY_COUNT/$MAX_RETRIES)"
                if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                  echo "âŒ Failed to install CLI dependencies after $MAX_RETRIES attempts!"
                  cd ..
                  exit 1
                fi
                sleep 5
              fi
            done
            
            # Build CLI with detailed error reporting
            if ! bun run build; then
              echo "âŒ CLI build failed!"
              echo "Build logs:"
              echo "---"
              bun run build 2>&1 || true
              echo "---"
              echo "Please check CLI code and build configuration."
              cd ..
              exit 1
            fi
            
            # Verify CLI binary was created
            if [ ! -f "dist/zxcv" ]; then
              echo "âŒ CLI binary not found after build!"
              echo "Expected: cli/dist/zxcv"
              ls -la dist/ || echo "dist/ directory not found"
              cd ..
              exit 1
            fi

            cd ..
            echo "âœ… CLI build successful!"

          echo "âœ… All builds completed successfully!"

      - name: Run tests after build
        run: |
          echo "ğŸ§ª Running tests after build..."
          pnpm run test:server || {
            echo "âŒ Tests failed! Cannot create release PR."
            exit 1
          }
          echo "âœ… All tests passed!"

      - name: Commit version updates
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bump version to ${{ inputs.version }}

          - Update package.json versions
          - Include CLI release

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
            
            echo "âœ… Committed version updates"
          fi

      - name: Push release branch
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          
          # Try normal push first
          if git push -u origin "$BRANCH_NAME"; then
            echo "âœ… Pushed release branch to origin"
          else
            echo "âš ï¸ Normal push failed, attempting force push to update existing branch"
            echo "This will overwrite any existing remote branch with the same name"
            
            if ! git push --force-with-lease origin "$BRANCH_NAME"; then
              echo "âŒ Force push also failed"
              echo "This might be due to network issues or permission problems"
              
              # Clean up local branch
              git checkout dev 2>/dev/null || git checkout main 2>/dev/null || true
              git branch -D "$BRANCH_NAME" 2>/dev/null || true
              
              exit 1
            fi
            
            echo "âœ… Force pushed release branch to origin"
          fi

      - name: Create Release PR
        id: pr
        continue-on-error: true
        run: |
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "${{ steps.branch.outputs.branch_name }}" --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âš ï¸ PR already exists for branch ${{ steps.branch.outputs.branch_name }}: #$EXISTING_PR"
            PR_URL=$(gh pr view "$EXISTING_PR" --json url --jq '.url')
            echo "ğŸ“‹ Updating existing PR instead of creating new one"
            
            # Update the existing PR
            if gh pr edit "$EXISTING_PR" \
              --title "ğŸš€ Release ${{ inputs.version }}" \
              --body "$(cat <<'EOF'
          ## ğŸš€ Release ${{ inputs.version }} (Updated)
          
          This PR prepares the release of version ${{ inputs.version }}.
          
          **Note**: This PR was updated from a previous release attempt.
          
          ### ğŸ“‹ Release Checklist
          
          - [x] Version numbers updated in package.json files
          - [x] Builds are successful
          - [x] Tests are passing
          - [ ] Review and approve this PR
          - [ ] Merge to main for production deployment
          
          ### ğŸ“ Changelog
          
          ${{ steps.changelog.outputs.changelog_content }}
          
          ### ğŸ”„ Deployment Flow
          
          1. **Review**: Review this PR for any issues
          2. **Merge**: Merge this PR to \`main\` branch
          3. **Deploy**: Production deployment will trigger automatically
          4. **Tag**: GitHub release will be created after successful deployment
          
          ### ğŸ› ï¸ Release Contents

          - **Server**: âœ… Included
          - **CLI**: âœ… Included
          $(if [[ "${{ inputs.version }}" =~ -[a-zA-Z]+ ]]; then echo "- **Prerelease**: This is a prerelease version"; fi)

          ---

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          /cc @${{ github.actor }}
          EOF
          )"
            then
              echo "âœ… Updated existing PR: $PR_URL"
            else
              echo "âŒ Failed to update existing PR"
              PR_URL=$(gh pr view "$EXISTING_PR" --json url --jq '.url')
            fi
          else
            echo "ğŸ“‹ Creating new PR for release ${{ inputs.version }}"
            if PR_URL=$(gh pr create \
            --title "ğŸš€ Release ${{ inputs.version }}" \
            --body "$(cat <<'EOF'
          ## ğŸš€ Release ${{ inputs.version }}
          
          This PR prepares the release of version ${{ inputs.version }}.
          
          ### ğŸ“‹ Release Checklist
          
          - [x] Version numbers updated in package.json files
          - [x] Builds are successful
          - [x] Tests are passing
          - [ ] Review and approve this PR
          - [ ] Merge to main for production deployment
          
          ### ğŸ“ Changelog
          
          ${{ steps.changelog.outputs.changelog_content }}
          
          ### ğŸ”„ Deployment Flow
          
          1. **Review**: Review this PR for any issues
          2. **Merge**: Merge this PR to \`main\` branch
          3. **Deploy**: Production deployment will trigger automatically
          4. **Tag**: GitHub release will be created after successful deployment
          
          ### ğŸ› ï¸ Release Contents

          - **Server**: âœ… Included
          - **CLI**: âœ… Included
          $(if [[ "${{ inputs.version }}" =~ -[a-zA-Z]+ ]]; then echo "- **Prerelease**: This is a prerelease version"; fi)

          ---

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          /cc @${{ github.actor }}
          EOF
          )" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }})
            then
              echo "âœ… Created new PR: $PR_URL"
            else
              echo "âŒ Failed to create PR automatically"
              echo "This is likely due to GitHub Actions not having permission to create PRs"
              PR_URL="https://github.com/${{ github.repository }}/compare/main...${{ steps.branch.outputs.branch_name }}"
              echo "ğŸ“‹ Manual PR creation URL: $PR_URL"
            fi
          fi
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          if [[ "$PR_URL" == *"compare"* ]]; then
            echo "âš ï¸ PR needs to be created manually: $PR_URL"
          else
            echo "âœ… Release PR ready: $PR_URL"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "ğŸ¯ Release preparation completed!"
          echo "ğŸ“‹ PR URL: ${{ steps.pr.outputs.pr_url }}"
          echo "ğŸ·ï¸ Version: ${{ inputs.version }}"
          echo "ğŸ› ï¸ CLI Included: Always"
          
          echo "### Next Steps:"
          if [[ "${{ steps.pr.outputs.pr_url }}" == *"compare"* ]]; then
            echo "1. ğŸ”§ **Create PR manually**: ${{ steps.pr.outputs.pr_url }}"
            echo "2. ğŸ“ **Copy title**: ğŸš€ Release ${{ inputs.version }}"
            echo "3. ğŸ“‹ **Copy description from changelog above**"
            echo "4. âœ… **Review and merge** to main for production release"
            echo "5. ğŸ“Š **Monitor deployment** in the Actions tab"
            echo ""
            echo "âš ï¸  **Note**: Automatic PR creation failed due to GitHub Actions permissions."
            echo "The release branch has been created and pushed successfully."
          else
            echo "1. Review the PR: ${{ steps.pr.outputs.pr_url }}"
            echo "2. Approve and merge to main for production release"
            echo "3. Monitor deployment in the Actions tab"
          fi

      - name: Create draft GitHub release
        run: |
          # Determine if this is a prerelease
          PRERELEASE_FLAG=""
          if [[ "${{ inputs.version }}" =~ -[a-zA-Z]+ ]]; then
            PRERELEASE_FLAG="--prerelease"
            echo "ğŸ“‹ Creating prerelease for ${{ inputs.version }}"
          else
            PRERELEASE_FLAG="--latest"
            echo "ğŸ“‹ Creating stable release for ${{ inputs.version }}"
          fi
          
          gh release create "${{ inputs.version }}" \
            --title "ğŸš€ Release ${{ inputs.version }}" \
            --notes "$(cat <<'EOF'
          ${{ steps.changelog.outputs.changelog_content }}
          
          ## Installation
          
          ### Web Application
          - **Production**: https://zxcv.nanasi-apps.xyz
          - **Staging**: https://zxcv-staging.mattyatea.me
          
          ### CLI Tool

          Download the appropriate binary for your platform from the assets below.
          
          $(if [[ "${{ inputs.version }}" =~ -[a-zA-Z]+ ]]; then echo ""; echo "âš ï¸ **This is a prerelease version** - Use for testing purposes only."; fi)
          EOF
          )" \
            --draft \
            $PRERELEASE_FLAG \
            --target ${{ steps.branch.outputs.branch_name }}
          
          echo "âœ… Created draft GitHub release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}