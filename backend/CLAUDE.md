# CLAUDE.md - プロジェクト開発ガイドライン

## 重要：必ず厳守する事項

### Linear タスク管理のルール

1. **タスクの作成**
   - 実装する機能や作業は必ずLinearにタスクを作成する
   - タイトルの最初に `[Task]` を必ず付ける
   - 例: `[Task] ユーザー認証APIの実装`

2. **タスクの詳細記載**
   - タスクの詳細には、やることをチェックリスト形式で必ず記載する
   - 各チェックリスト項目は具体的かつ実行可能な単位にする
   - 例:
     ```
     - [ ] JWT生成ロジックの実装
     - [ ] ログインエンドポイントの作成
     - [ ] パスワード検証の実装
     - [ ] リフレッシュトークンの仕組み構築
     ```

3. **設計や質問事項**
   - 設計で困ったことや質問がある場合もLinearに起票する
   - タイトルの最初に `[QA]` を必ず付ける
   - 例: `[QA] マルチテナント対応のDB設計について`

4. **ステータス管理**
   - タスクの状態変更を忘れずに行う
   - Todo → In Progress → In Review → Done
   - **作業開始時は必ず「In Progress」に変更**
   - **完了時は必ず「Done」に変更**

5. **タスクの作成義務**
   - **タスクにないような作業に取り掛かる場合は、必ずLinearにタスクを作成してから取り掛かる**
   - 既存のタスクがない場合は、新規タスクを作成する
   - 作業内容が明確でない場合は、調査タスクを作成する

## プロジェクト: zxcv

### 概要
コーディングルール共有ツール。組織やチームでコーディングルール（ESLint設定など）を共有・管理できるプラットフォーム。

### 技術スタック
- **バックエンド**: Cloudflare Workers + Hono
- **データベース**: Cloudflare D1 (SQLite) + Prisma ORM
- **ストレージ**: Cloudflare R2
- **認証**: JWT
- **バリデーション**: Zod
- **API仕様**: OpenAPI (chanfana)

### プロジェクト構造
```
zxcv/
├── backend/           # バックエンドAPI
│   ├── src/          # ソースコード
│   │   ├── handlers/ # APIハンドラー
│   │   ├── services/ # ビジネスロジック
│   │   ├── utils/    # ユーティリティ
│   │   └── types/    # 型定義
│   ├── prisma/       # Prismaスキーマ・マイグレーション
│   └── tests/        # テストコード
└── frontend/         # フロントエンド（未実装）
```

### 開発コマンド

```bash
# 開発サーバー起動
pnpm dev

# テスト実行
pnpm test
pnpm test:watch  # ウォッチモード

# リント・フォーマット
pnpm lint
pnpm lint:fix
pnpm format
pnpm format:check

# 型チェック
pnpm typecheck

# データベースマイグレーション
pnpm migrate:local  # ローカル環境
pnpm migrate:prod   # 本番環境

# OpenAPIスキーマ生成
pnpm schema
```

### API設計

#### エンドポイント構造
- `/auth/*` - 認証関連
- `/rules/*` - ルール管理
- `/rules/@:org/:rulename` - 組織ルール
- `/rules/:id/versions` - バージョン管理
- `/teams/*` - チーム管理
- `/search` - 検索機能

#### 認証方式
- JWT Bearer Token
- リフレッシュトークン対応
- APIキー認証（将来実装）

### データベース設計

主要テーブル:
- `users` - ユーザー情報
- `rules` - ルール基本情報
- `rule_versions` - ルールのバージョン履歴
- `teams` - チーム情報
- `team_members` - チームメンバー
- `api_keys` - APIキー
- `rate_limits` - レート制限

### 実装済み機能

1. **データベーススキーマ** ✅
   - Prismaスキーマ定義完了
   - 全テーブル設計完了

2. **プロジェクト基本設定** ✅
   - Cloudflare Workers設定
   - TypeScript設定
   - ESLint/Prettier設定
   - Vitest設定

3. **Prisma統合** ✅
   - Prismaクライアント設定
   - D1アダプター設定

### 未実装機能（Linearで管理）

- JWT認証システム
- ルール管理API
- バージョン管理システム
- 検索機能
- レート制限
- チーム機能
- CI/CDパイプライン

### 開発時の注意事項

1. **必読ドキュメント**
   - **CODING_GUIDELINES.md** を必ず読んでから開発を開始すること
   - コーディング規約、命名規則、設計方針などの重要な情報が記載されている
   - TODOコメントの管理方法についても記載されている

2. **コミット前チェック**
   - `pnpm typecheck` で型エラーがないことを確認
   - `pnpm check` でBiomeのlint/formatチェックが通ることを確認
   - `pnpm test` でテストが通ることを確認

3. **API実装時**
   - 必ずOpenAPI定義を更新する
   - エラーレスポンスは統一フォーマットを使用
   - 適切なHTTPステータスコードを返す

4. **データベース変更時**
   - Prismaスキーマを更新
   - マイグレーションファイルを生成
   - ローカルでテスト後、本番に適用

### セキュリティ考慮事項

- 入力値は必ずZodでバリデーション
- SQLインジェクション対策（Prisma使用）
- XSS対策（フロントエンド実装時）
- レート制限の実装
- 適切な認証・認可チェック

### パフォーマンス考慮事項

- N+1クエリの回避
- 適切なインデックス設計
- キャッシュ戦略（Cloudflare Cache）
- R2への大きなファイルの保存