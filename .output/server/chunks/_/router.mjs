import{i as e,v as r,h as n,O as i,f as a,k as o}from"./client.DwfV9Oyl.mjs";import{Buffer as s}from"node:buffer";import{h as u,m as d}from"../nitro/nitro.mjs";class ValidationError extends Error{issues;constructor(e){super(e.message,e),this.issues=e.issues}}function mergeErrorMap(e,r){return{...e,...r}}function mergeMeta(e,r){return{...e,...r}}class ContractProcedure{"~orpc";constructor(r){if(r.route?.successStatus&&e(r.route.successStatus))throw new Error("[ContractProcedure] Invalid successStatus.");if(Object.values(r.errorMap).some(r=>r&&r.status&&!e(r.status)))throw new Error("[ContractProcedure] Invalid error status code.");this["~orpc"]=r}}function isContractProcedure(e){return e instanceof ContractProcedure||("object"==typeof e||"function"==typeof e)&&null!==e&&"~orpc"in e&&"object"==typeof e["~orpc"]&&null!==e["~orpc"]&&"errorMap"in e["~orpc"]&&"route"in e["~orpc"]&&"meta"in e["~orpc"]}function mergeRoute(e,r){return{...e,...r}}function mergePrefix(e,r){return e?`${e}${r}`:r}function mergeTags(e,r){return e?[...e,...r]:r}function enhanceRoute(e,r){let n=e;return r.prefix&&(n=function(e,r){return e.path?{...e,path:`${r}${e.path}`}:e}(n,r.prefix)),r.tags?.length&&(n=function(e,r){return{...e,tags:[...r,...e.tags??[]]}}(n,r.tags)),n}function enhanceContractRouter(e,r){if(isContractProcedure(e)){return new ContractProcedure({...e["~orpc"],errorMap:mergeErrorMap(r.errorMap,e["~orpc"].errorMap),route:enhanceRoute(e["~orpc"].route,r)})}const n={};for(const i in e)n[i]=enhanceContractRouter(e[i],r);return n}class ContractBuilder extends ContractProcedure{constructor(e){super(e),this["~orpc"].prefix=e.prefix,this["~orpc"].tags=e.tags}$meta(e){return new ContractBuilder({...this["~orpc"],meta:e})}$route(e){return new ContractBuilder({...this["~orpc"],route:e})}errors(e){return new ContractBuilder({...this["~orpc"],errorMap:mergeErrorMap(this["~orpc"].errorMap,e)})}meta(e){return new ContractBuilder({...this["~orpc"],meta:mergeMeta(this["~orpc"].meta,e)})}route(e){return new ContractBuilder({...this["~orpc"],route:mergeRoute(this["~orpc"].route,e)})}input(e){return new ContractBuilder({...this["~orpc"],inputSchema:e})}output(e){return new ContractBuilder({...this["~orpc"],outputSchema:e})}prefix(e){return new ContractBuilder({...this["~orpc"],prefix:mergePrefix(this["~orpc"].prefix,e)})}tag(...e){return new ContractBuilder({...this["~orpc"],tags:mergeTags(this["~orpc"].tags,e)})}router(e){return enhanceContractRouter(e,this["~orpc"])}}const c=new ContractBuilder({errorMap:{},route:{},meta:{}}),l={defaultMethod:"POST",defaultSuccessStatus:200,defaultSuccessDescription:"OK",defaultInputStructure:"compact",defaultOutputStructure:"compact"};function fallbackContractConfig(e,r){return void 0===r?l[e]:r}const p=Symbol("ORPC_EVENT_ITERATOR_DETAILS");function getEventIteratorSchemaDetails(e){if(void 0!==e)return e["~standard"][p]}const m=Symbol("ORPC_LAZY_SYMBOL");function lazy(e,r={}){return{[m]:{loader:e,meta:r}}}function isLazy(e){return("object"==typeof e||"function"==typeof e)&&null!==e&&m in e}function getLazyMeta(e){return e[m].meta}function unlazy(e){return isLazy(e)?e[m].loader():Promise.resolve({default:e})}function addMiddleware(e,r){return[...e,r]}class Procedure{"~orpc";constructor(e){this["~orpc"]=e}}function isProcedure(e){return e instanceof Procedure||isContractProcedure(e)&&"middlewares"in e["~orpc"]&&"inputValidationIndex"in e["~orpc"]&&"outputValidationIndex"in e["~orpc"]&&"handler"in e["~orpc"]}function mergeCurrentContext(e,r){return{...e,...r}}function middlewareOutputFn(e){return{output:e,context:{}}}function createProcedureClient(e,...[o]){return async(...[s,u])=>{const d=o?.path??[],{default:c}=await unlazy(e),l=u?.context??{},p=await r(o?.context??{},l),m=function(e){const r=new Proxy(e,{get:(r,n)=>"string"!=typeof n?Reflect.get(r,n):(...[r])=>{const a=e[n];return new i(n,{defined:Boolean(a),status:a?.status,message:r?.message??a?.message,data:r?.data,cause:r?.cause})}});return r}(c["~orpc"].errorMap);try{return await n(o?.interceptors??[],{context:p,input:s,errors:m,path:d,procedure:c,signal:u?.signal,lastEventId:u?.lastEventId},e=>async function(e,r){const n=e["~orpc"].middlewares,a=Math.min(Math.max(0,e["~orpc"].inputValidationIndex),n.length),o=Math.min(Math.max(0,e["~orpc"].outputValidationIndex),n.length),next=async(s,u,d)=>{let c=d;s===a&&(c=await async function(e,r){const n=e["~orpc"].inputSchema;if(!n)return r;const a=await n["~standard"].validate(r);if(a.issues)throw new i("BAD_REQUEST",{message:"Input validation failed",data:{issues:a.issues},cause:new ValidationError({message:"Input validation failed",issues:a.issues})});return a.value}(e,c));const l=n[s],p=l?(await l({...r,context:u,next:async(...[e])=>{const r=e?.context??{};return{output:await next(s+1,mergeCurrentContext(u,r),c),context:r}}},c,middlewareOutputFn)).output:await e["~orpc"].handler({...r,context:u,input:c});return s===o?await async function(e,r){const n=e["~orpc"].outputSchema;if(!n)return r;const a=await n["~standard"].validate(r);if(a.issues)throw new i("INTERNAL_SERVER_ERROR",{message:"Output validation failed",cause:new ValidationError({message:"Output validation failed",issues:a.issues})});return a.value}(e,p):p};return next(0,r.context,r.input)}(e.procedure,e))}catch(e){if(!(e instanceof i))throw e;const r=await async function(e,r){const{code:n,status:o,message:s,data:u,cause:d,defined:c}=r,l=e?.[r.code];if(!l||a(r.code,l.status)!==r.status)return c?new i(n,{defined:!1,status:o,message:s,data:u,cause:d}):r;if(!l.data)return c?r:new i(n,{defined:!0,status:o,message:s,data:u,cause:d});const p=await l.data["~standard"].validate(r.data);return p.issues?c?new i(n,{defined:!1,status:o,message:s,data:u,cause:d}):r:new i(n,{defined:!0,status:o,message:s,data:p.value,cause:d})}(c["~orpc"].errorMap,e);throw r}}}const h=Symbol("ORPC_HIDDEN_ROUTER_CONTRACT");function setHiddenRouterContract(e,r){return new Proxy(e,{get:(e,n)=>n===h?r:Reflect.get(e,n)})}function getRouter(e,r){let n=e;for(let e=0;e<r.length;e++){const i=r[e];if(!n)return;if(isProcedure(n))return;if(!isLazy(n)){n=n[i];continue}const a=n,o=r.slice(e);return lazy(async()=>{const e=await unlazy(a);return unlazy(getRouter(e.default,o))},getLazyMeta(a))}return n}function createAccessibleLazyRouter(e){return new Proxy(e,{get(r,n){if("string"!=typeof n)return Reflect.get(r,n);return createAccessibleLazyRouter(getRouter(e,[n]))}})}function enhanceRouter(e,r){if(isLazy(e)){const n=getLazyMeta(e),i=n?.prefix?mergePrefix(r.prefix,n?.prefix):r.prefix;return createAccessibleLazyRouter(lazy(async()=>{const{default:n}=await unlazy(e);return unlazy(enhanceRouter(n,r))},{...n,prefix:i}))}if(isProcedure(e)){const n=function(e,r,n){return n.dedupeLeading&&function(e,r){if(r.length>e.length)return!1;for(let n=0;n<e.length;n++){if(void 0===r[n])return!0;if(e[n]!==r[n])return!1}return!0}(r,e)?r:[...e,...r]}(r.middlewares,e["~orpc"].middlewares,{dedupeLeading:r.dedupeLeadingMiddlewares}),i=n.length-e["~orpc"].middlewares.length;return new Procedure({...e["~orpc"],route:enhanceRoute(e["~orpc"].route,r),errorMap:mergeErrorMap(r.errorMap,e["~orpc"].errorMap),middlewares:n,inputValidationIndex:e["~orpc"].inputValidationIndex+i,outputValidationIndex:e["~orpc"].outputValidationIndex+i})}const n={};for(const i in e)n[i]=enhanceRouter(e[i],r);return n}function traverseContractProcedures(e,r,n=[]){let i=e.router;const a=function(e){return e[h]}(e.router);if(void 0!==a&&(i=a),isLazy(i))n.push({router:i,path:e.path});else if(isContractProcedure(i))r({contract:i,path:e.path});else for(const a in i)traverseContractProcedures({router:i[a],path:[...e.path,a]},r,n);return n}async function resolveContractProcedures(e,r){const n=[e];for(const e of n){const i=traverseContractProcedures(e,r);for(const e of i){const{default:r}=await unlazy(e.router);n.push({router:r,path:e.path})}}}function createContractedProcedure(e,r){return new Procedure({...e["~orpc"],errorMap:r["~orpc"].errorMap,route:r["~orpc"].route,meta:r["~orpc"].meta})}const g={initialInputValidationIndex:0,initialOutputValidationIndex:0,dedupeLeadingMiddlewares:!0};function fallbackConfig(e,r){return void 0===r?g[e]:r}function decorateMiddleware(e){const decorated=(...r)=>e(...r);return decorated.mapInput=r=>decorateMiddleware((n,i,...a)=>e(n,r(i),...a)),decorated.concat=(r,n)=>{const i=n?decorateMiddleware(r).mapInput(n):r;return decorateMiddleware((r,n,a,...o)=>e({...r,next:(...[e])=>i({...r,context:{...r.context,...e?.context},next:(...[n])=>r.next({context:{...e?.context,...n?.context}})},n,a,...o)},n,a,...o))},decorated}class DecoratedProcedure extends Procedure{errors(e){return new DecoratedProcedure({...this["~orpc"],errorMap:mergeErrorMap(this["~orpc"].errorMap,e)})}meta(e){return new DecoratedProcedure({...this["~orpc"],meta:mergeMeta(this["~orpc"].meta,e)})}route(e){return new DecoratedProcedure({...this["~orpc"],route:mergeRoute(this["~orpc"].route,e)})}use(e,r){const n=r?decorateMiddleware(e).mapInput(r):e;return new DecoratedProcedure({...this["~orpc"],middlewares:addMiddleware(this["~orpc"].middlewares,n)})}callable(...e){const r=createProcedureClient(this,...e);return new Proxy(r,{get:(e,r)=>Reflect.has(this,r)?Reflect.get(this,r):Reflect.get(e,r),has:(e,r)=>Reflect.has(this,r)||Reflect.has(e,r)})}actionable(...e){const r=(n=createProcedureClient(this,...e),async e=>{try{return[null,await n(e)]}catch(e){if(e instanceof Error&&"digest"in e&&"string"==typeof e.digest&&e.digest.startsWith("NEXT_"))throw e;return[o(e).toJSON(),void 0]}});var n;return new Proxy(r,{get:(e,r)=>Reflect.has(this,r)?Reflect.get(this,r):Reflect.get(e,r),has:(e,r)=>Reflect.has(this,r)||Reflect.has(e,r)})}}class Builder{"~orpc";constructor(e){this["~orpc"]=e}$config(e){const r=this["~orpc"].inputValidationIndex-fallbackConfig("initialInputValidationIndex",this["~orpc"].config.initialInputValidationIndex),n=this["~orpc"].outputValidationIndex-fallbackConfig("initialOutputValidationIndex",this["~orpc"].config.initialOutputValidationIndex);return new Builder({...this["~orpc"],config:e,dedupeLeadingMiddlewares:fallbackConfig("dedupeLeadingMiddlewares",e.dedupeLeadingMiddlewares),inputValidationIndex:fallbackConfig("initialInputValidationIndex",e.initialInputValidationIndex)+r,outputValidationIndex:fallbackConfig("initialOutputValidationIndex",e.initialOutputValidationIndex)+n})}$context(){return new Builder({...this["~orpc"],middlewares:[],inputValidationIndex:fallbackConfig("initialInputValidationIndex",this["~orpc"].config.initialInputValidationIndex),outputValidationIndex:fallbackConfig("initialOutputValidationIndex",this["~orpc"].config.initialOutputValidationIndex)})}$meta(e){return new Builder({...this["~orpc"],meta:e})}$route(e){return new Builder({...this["~orpc"],route:e})}$input(e){return new Builder({...this["~orpc"],inputSchema:e})}middleware(e){return decorateMiddleware(e)}errors(e){return new Builder({...this["~orpc"],errorMap:mergeErrorMap(this["~orpc"].errorMap,e)})}use(e,r){const n=r?decorateMiddleware(e).mapInput(r):e;return new Builder({...this["~orpc"],middlewares:addMiddleware(this["~orpc"].middlewares,n)})}meta(e){return new Builder({...this["~orpc"],meta:mergeMeta(this["~orpc"].meta,e)})}route(e){return new Builder({...this["~orpc"],route:mergeRoute(this["~orpc"].route,e)})}input(e){return new Builder({...this["~orpc"],inputSchema:e,inputValidationIndex:fallbackConfig("initialInputValidationIndex",this["~orpc"].config.initialInputValidationIndex)+this["~orpc"].middlewares.length})}output(e){return new Builder({...this["~orpc"],outputSchema:e,outputValidationIndex:fallbackConfig("initialOutputValidationIndex",this["~orpc"].config.initialOutputValidationIndex)+this["~orpc"].middlewares.length})}handler(e){return new DecoratedProcedure({...this["~orpc"],handler:e})}prefix(e){return new Builder({...this["~orpc"],prefix:mergePrefix(this["~orpc"].prefix,e)})}tag(...e){return new Builder({...this["~orpc"],tags:mergeTags(this["~orpc"].tags,e)})}router(e){return enhanceRouter(e,this["~orpc"])}lazy(e){return enhanceRouter(lazy(e),this["~orpc"])}}function implementerInternal(e,r,n){if(isContractProcedure(e)){return new Builder({...e["~orpc"],config:r,middlewares:n,inputValidationIndex:fallbackConfig("initialInputValidationIndex",r?.initialInputValidationIndex)+n.length,outputValidationIndex:fallbackConfig("initialOutputValidationIndex",r?.initialOutputValidationIndex)+n.length,dedupeLeadingMiddlewares:fallbackConfig("dedupeLeadingMiddlewares",r.dedupeLeadingMiddlewares)})}const i=new Proxy(e,{get:(i,a)=>{if("string"!=typeof a)return Reflect.get(i,a);let o;"middleware"===a?o=e=>decorateMiddleware(e):"use"===a?o=i=>implementerInternal(e,r,addMiddleware(n,i)):"router"===a?o=i=>setHiddenRouterContract(enhanceRouter(i,{middlewares:n,errorMap:{},prefix:void 0,tags:void 0,dedupeLeadingMiddlewares:fallbackConfig("dedupeLeadingMiddlewares",r.dedupeLeadingMiddlewares)}),e):"lazy"===a&&(o=i=>setHiddenRouterContract(enhanceRouter(lazy(i),{middlewares:n,errorMap:{},prefix:void 0,tags:void 0,dedupeLeadingMiddlewares:fallbackConfig("dedupeLeadingMiddlewares",r.dedupeLeadingMiddlewares)}),e));const s=function(e,r){let n=e;for(let e=0;e<r.length;e++){const i=r[e];if(!n)return;if(isContractProcedure(n))return;n=n[i]}return n}(i,[a]);if(!s)return o??s;const u=implementerInternal(s,r,n);return o?new Proxy(o,{get:(e,r)=>Reflect.get(u,r)}):u}});return i}function implement(e,r={}){const n=implementerInternal(e,r,[]),i=new Proxy(n,{get:(r,n)=>{let a;"$context"===n?a=()=>i:"$config"===n&&(a=r=>implement(e,r));const o=Reflect.get(r,n);return!a||!o||"function"!=typeof o&&"object"!=typeof o?a||o:new Proxy(a,{get:(e,r)=>Reflect.get(o,r)})}});return i}function $constructor(e,r,n){function init(n,i){var a;Object.defineProperty(n,"_zod",{value:n._zod??{},enumerable:!1}),(a=n._zod).traits??(a.traits=new Set),n._zod.traits.add(e),r(n,i);for(const e in _.prototype)e in n||Object.defineProperty(n,e,{value:_.prototype[e].bind(n)});n._zod.constr=_,n._zod.def=i}const i=n?.Parent??Object;class Definition extends i{}function _(e){var r;const i=n?.Parent?new Definition:this;init(i,e),(r=i._zod).deferred??(r.deferred=[]);for(const e of i._zod.deferred)e();return i}return Object.defineProperty(Definition,"name",{value:e}),Object.defineProperty(_,"init",{value:init}),Object.defineProperty(_,Symbol.hasInstance,{value:r=>!!(n?.Parent&&r instanceof n.Parent)||r?._zod?.traits?.has(e)}),Object.defineProperty(_,"name",{value:e}),_}class $ZodAsyncError extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const f={};function config(e){return f}function jsonStringifyReplacer(e,r){return"bigint"==typeof r?r.toString():r}function cached(e){return{get value(){{const r=e();return Object.defineProperty(this,"value",{value:r}),r}}}}function nullish(e){return null==e}function cleanRegex(e){const r=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(r,n)}function defineLazy(e,r,n){Object.defineProperty(e,r,{get(){{const i=n();return e[r]=i,i}},set(n){Object.defineProperty(e,r,{value:n})},configurable:!0})}function assignProp(e,r,n){Object.defineProperty(e,r,{value:n,writable:!0,enumerable:!0,configurable:!0})}function esc(e){return JSON.stringify(e)}const w=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function isObject$1(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const y=cached(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function isPlainObject(e){if(!1===isObject$1(e))return!1;const r=e.constructor;if(void 0===r)return!0;const n=r.prototype;return!1!==isObject$1(n)&&!1!==Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")}const b=new Set(["string","number","symbol"]);function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function clone(e,r,n){const i=new e._zod.constr(r??e._zod.def);return r&&!n?.parent||(i._zod.parent=e),i}function normalizeParams(e){const r=e;if(!r)return{};if("string"==typeof r)return{error:()=>r};if(void 0!==r?.message){if(void 0!==r?.error)throw new Error("Cannot specify both `message` and `error` params");r.error=r.message}return delete r.message,"string"==typeof r.error?{...r,error:()=>r.error}:r}const v={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function aborted(e,r=0){for(let n=r;n<e.issues.length;n++)if(!0!==e.issues[n]?.continue)return!0;return!1}function prefixIssues(e,r){return r.map(r=>{var n;return(n=r).path??(n.path=[]),r.path.unshift(e),r})}function unwrapMessage(e){return"string"==typeof e?e:e?.message}function finalizeIssue(e,r,n){const i={...e,path:e.path??[]};if(!e.message){const a=unwrapMessage(e.inst?._zod.def?.error?.(e))??unwrapMessage(r?.error?.(e))??unwrapMessage(n.customError?.(e))??unwrapMessage(n.localeError?.(e))??"Invalid input";i.message=a}return delete i.inst,delete i.continue,r?.reportInput||delete i.input,i}function getLengthableOrigin(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function issue(...e){const[r,n,i]=e;return"string"==typeof r?{message:r,code:"custom",input:n,inst:i}:{...r}}const initializer$1=(e,r)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:r,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(r,jsonStringifyReplacer,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},z=$constructor("$ZodError",initializer$1),R=$constructor("$ZodError",initializer$1,{Parent:Error});const _parse=e=>(r,n,i,a)=>{const o=i?Object.assign(i,{async:!1}):{async:!1},s=r._zod.run({value:n,issues:[]},o);if(s instanceof Promise)throw new $ZodAsyncError;if(s.issues.length){const r=new(a?.Err??e)(s.issues.map(e=>finalizeIssue(e,o,config())));throw w(r,a?.callee),r}return s.value},_parseAsync=e=>async(r,n,i,a)=>{const o=i?Object.assign(i,{async:!0}):{async:!0};let s=r._zod.run({value:n,issues:[]},o);if(s instanceof Promise&&(s=await s),s.issues.length){const r=new(a?.Err??e)(s.issues.map(e=>finalizeIssue(e,o,config())));throw w(r,a?.callee),r}return s.value},_safeParse=e=>(r,n,i)=>{const a=i?{...i,async:!1}:{async:!1},o=r._zod.run({value:n,issues:[]},a);if(o instanceof Promise)throw new $ZodAsyncError;return o.issues.length?{success:!1,error:new(e??z)(o.issues.map(e=>finalizeIssue(e,a,config())))}:{success:!0,data:o.value}},I=_safeParse(R),_safeParseAsync=e=>async(r,n,i)=>{const a=i?Object.assign(i,{async:!0}):{async:!0};let o=r._zod.run({value:n,issues:[]},a);return o instanceof Promise&&(o=await o),o.issues.length?{success:!1,error:new e(o.issues.map(e=>finalizeIssue(e,a,config())))}:{success:!0,data:o.value}},E=_safeParseAsync(R),x=/^[cC][^\s-]{8,}$/,A=/^[0-9a-z]+$/,S=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,k=/^[0-9a-vA-V]{20}$/,T=/^[A-Za-z0-9]{27}$/,P=/^[a-zA-Z0-9_-]{21}$/,O=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,C=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,uuid=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,$=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;const j=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,N=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,D=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,U=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,M=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,L=/^[A-Za-z0-9_-]*$/,V=/^([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+$/,F=/^\+(?:[0-9]){6,14}[0-9]$/,B="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",W=new RegExp(`^${B}$`);function timeSource(e){const r="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${r}`:0===e.precision?`${r}:[0-5]\\d`:`${r}:[0-5]\\d\\.\\d{${e.precision}}`:`${r}(?::[0-5]\\d(?:\\.\\d+)?)?`}const J=/^\d+$/,H=/^-?\d+(?:\.\d+)?/i,Z=/true|false/i,q=/^[^A-Z]*$/,K=/^[^a-z]*$/,G=$constructor("$ZodCheck",(e,r)=>{var n;e._zod??(e._zod={}),e._zod.def=r,(n=e._zod).onattach??(n.onattach=[])}),Q={number:"number",bigint:"bigint",object:"date"},Y=$constructor("$ZodCheckLessThan",(e,r)=>{G.init(e,r);const n=Q[typeof r.value];e._zod.onattach.push(e=>{const n=e._zod.bag,i=(r.inclusive?n.maximum:n.exclusiveMaximum)??Number.POSITIVE_INFINITY;r.value<i&&(r.inclusive?n.maximum=r.value:n.exclusiveMaximum=r.value)}),e._zod.check=i=>{(r.inclusive?i.value<=r.value:i.value<r.value)||i.issues.push({origin:n,code:"too_big",maximum:r.value,input:i.value,inclusive:r.inclusive,inst:e,continue:!r.abort})}}),X=$constructor("$ZodCheckGreaterThan",(e,r)=>{G.init(e,r);const n=Q[typeof r.value];e._zod.onattach.push(e=>{const n=e._zod.bag,i=(r.inclusive?n.minimum:n.exclusiveMinimum)??Number.NEGATIVE_INFINITY;r.value>i&&(r.inclusive?n.minimum=r.value:n.exclusiveMinimum=r.value)}),e._zod.check=i=>{(r.inclusive?i.value>=r.value:i.value>r.value)||i.issues.push({origin:n,code:"too_small",minimum:r.value,input:i.value,inclusive:r.inclusive,inst:e,continue:!r.abort})}}),ee=$constructor("$ZodCheckMultipleOf",(e,r)=>{G.init(e,r),e._zod.onattach.push(e=>{var n;(n=e._zod.bag).multipleOf??(n.multipleOf=r.value)}),e._zod.check=n=>{if(typeof n.value!=typeof r.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof n.value?n.value%r.value===BigInt(0):0===function(e,r){const n=(e.toString().split(".")[1]||"").length,i=(r.toString().split(".")[1]||"").length,a=n>i?n:i;return Number.parseInt(e.toFixed(a).replace(".",""))%Number.parseInt(r.toFixed(a).replace(".",""))/10**a}(n.value,r.value))||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:r.value,input:n.value,inst:e,continue:!r.abort})}}),te=$constructor("$ZodCheckNumberFormat",(e,r)=>{G.init(e,r),r.format=r.format||"float64";const n=r.format?.includes("int"),i=n?"int":"number",[a,o]=v[r.format];e._zod.onattach.push(e=>{const i=e._zod.bag;i.format=r.format,i.minimum=a,i.maximum=o,n&&(i.pattern=J)}),e._zod.check=s=>{const u=s.value;if(n){if(!Number.isInteger(u))return void s.issues.push({expected:i,format:r.format,code:"invalid_type",input:u,inst:e});if(!Number.isSafeInteger(u))return void(u>0?s.issues.push({input:u,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:i,continue:!r.abort}):s.issues.push({input:u,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:i,continue:!r.abort}))}u<a&&s.issues.push({origin:"number",input:u,code:"too_small",minimum:a,inclusive:!0,inst:e,continue:!r.abort}),u>o&&s.issues.push({origin:"number",input:u,code:"too_big",maximum:o,inst:e})}}),re=$constructor("$ZodCheckMaxLength",(e,r)=>{var n;G.init(e,r),(n=e._zod.def).when??(n.when=e=>{const r=e.value;return!nullish(r)&&void 0!==r.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.maximum??Number.POSITIVE_INFINITY;r.maximum<n&&(e._zod.bag.maximum=r.maximum)}),e._zod.check=n=>{const i=n.value;if(i.length<=r.maximum)return;const a=getLengthableOrigin(i);n.issues.push({origin:a,code:"too_big",maximum:r.maximum,inclusive:!0,input:i,inst:e,continue:!r.abort})}}),ne=$constructor("$ZodCheckMinLength",(e,r)=>{var n;G.init(e,r),(n=e._zod.def).when??(n.when=e=>{const r=e.value;return!nullish(r)&&void 0!==r.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;r.minimum>n&&(e._zod.bag.minimum=r.minimum)}),e._zod.check=n=>{const i=n.value;if(i.length>=r.minimum)return;const a=getLengthableOrigin(i);n.issues.push({origin:a,code:"too_small",minimum:r.minimum,inclusive:!0,input:i,inst:e,continue:!r.abort})}}),ie=$constructor("$ZodCheckLengthEquals",(e,r)=>{var n;G.init(e,r),(n=e._zod.def).when??(n.when=e=>{const r=e.value;return!nullish(r)&&void 0!==r.length}),e._zod.onattach.push(e=>{const n=e._zod.bag;n.minimum=r.length,n.maximum=r.length,n.length=r.length}),e._zod.check=n=>{const i=n.value,a=i.length;if(a===r.length)return;const o=getLengthableOrigin(i),s=a>r.length;n.issues.push({origin:o,...s?{code:"too_big",maximum:r.length}:{code:"too_small",minimum:r.length},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!r.abort})}}),ae=$constructor("$ZodCheckStringFormat",(e,r)=>{var n,i;G.init(e,r),e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=r.format,r.pattern&&(n.patterns??(n.patterns=new Set),n.patterns.add(r.pattern))}),r.pattern?(n=e._zod).check??(n.check=n=>{r.pattern.lastIndex=0,r.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:r.format,input:n.value,...r.pattern?{pattern:r.pattern.toString()}:{},inst:e,continue:!r.abort})}):(i=e._zod).check??(i.check=()=>{})}),oe=$constructor("$ZodCheckRegex",(e,r)=>{ae.init(e,r),e._zod.check=n=>{r.pattern.lastIndex=0,r.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:r.pattern.toString(),inst:e,continue:!r.abort})}}),se=$constructor("$ZodCheckLowerCase",(e,r)=>{r.pattern??(r.pattern=q),ae.init(e,r)}),ue=$constructor("$ZodCheckUpperCase",(e,r)=>{r.pattern??(r.pattern=K),ae.init(e,r)}),de=$constructor("$ZodCheckIncludes",(e,r)=>{G.init(e,r);const n=escapeRegex(r.includes),i=new RegExp("number"==typeof r.position?`^.{${r.position}}${n}`:n);r.pattern=i,e._zod.onattach.push(e=>{const r=e._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(i)}),e._zod.check=n=>{n.value.includes(r.includes,r.position)||n.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:r.includes,input:n.value,inst:e,continue:!r.abort})}}),ce=$constructor("$ZodCheckStartsWith",(e,r)=>{G.init(e,r);const n=new RegExp(`^${escapeRegex(r.prefix)}.*`);r.pattern??(r.pattern=n),e._zod.onattach.push(e=>{const r=e._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(n)}),e._zod.check=n=>{n.value.startsWith(r.prefix)||n.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:r.prefix,input:n.value,inst:e,continue:!r.abort})}}),le=$constructor("$ZodCheckEndsWith",(e,r)=>{G.init(e,r);const n=new RegExp(`.*${escapeRegex(r.suffix)}$`);r.pattern??(r.pattern=n),e._zod.onattach.push(e=>{const r=e._zod.bag;r.patterns??(r.patterns=new Set),r.patterns.add(n)}),e._zod.check=n=>{n.value.endsWith(r.suffix)||n.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:r.suffix,input:n.value,inst:e,continue:!r.abort})}}),pe=$constructor("$ZodCheckOverwrite",(e,r)=>{G.init(e,r),e._zod.check=e=>{e.value=r.tx(e.value)}});class Doc{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const r=e.split("\n").filter(e=>e),n=Math.min(...r.map(e=>e.length-e.trimStart().length)),i=r.map(e=>e.slice(n)).map(e=>" ".repeat(2*this.indent)+e);for(const e of i)this.content.push(e)}compile(){const e=Function,r=this?.args;return new e(...r,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}const me={major:4,minor:0,patch:5},he=$constructor("$ZodType",(e,r)=>{var n;e??(e={}),e._zod.def=r,e._zod.bag=e._zod.bag||{},e._zod.version=me;const i=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&i.unshift(e);for(const r of i)for(const n of r._zod.onattach)n(e);if(0===i.length)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const runChecks=(e,r,n)=>{let i,a=aborted(e);for(const o of r){if(o._zod.def.when){if(!o._zod.def.when(e))continue}else if(a)continue;const r=e.issues.length,s=o._zod.check(e);if(s instanceof Promise&&!1===n?.async)throw new $ZodAsyncError;if(i||s instanceof Promise)i=(i??Promise.resolve()).then(async()=>{await s;e.issues.length!==r&&(a||(a=aborted(e,r)))});else{if(e.issues.length===r)continue;a||(a=aborted(e,r))}}return i?i.then(()=>e):e};e._zod.run=(r,n)=>{const a=e._zod.parse(r,n);if(a instanceof Promise){if(!1===n.async)throw new $ZodAsyncError;return a.then(e=>runChecks(e,i,n))}return runChecks(a,i,n)}}e["~standard"]={validate:r=>{try{const n=I(e,r);return n.success?{value:n.data}:{issues:n.error?.issues}}catch(n){return E(e,r).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),ge=$constructor("$ZodString",(e,r)=>{var n;he.init(e,r),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(n=e._zod.bag,new RegExp(`^${n?`[\\s\\S]{${n?.minimum??0},${n?.maximum??""}}`:"[\\s\\S]*"}$`)),e._zod.parse=(n,i)=>{if(r.coerce)try{n.value=String(n.value)}catch(i){}return"string"==typeof n.value||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),fe=$constructor("$ZodStringFormat",(e,r)=>{ae.init(e,r),ge.init(e,r)}),we=$constructor("$ZodGUID",(e,r)=>{r.pattern??(r.pattern=C),fe.init(e,r)}),ye=$constructor("$ZodUUID",(e,r)=>{if(r.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[r.version];if(void 0===e)throw new Error(`Invalid UUID version: "${r.version}"`);r.pattern??(r.pattern=uuid(e))}else r.pattern??(r.pattern=uuid());fe.init(e,r)}),be=$constructor("$ZodEmail",(e,r)=>{r.pattern??(r.pattern=$),fe.init(e,r)}),ve=$constructor("$ZodURL",(e,r)=>{fe.init(e,r),e._zod.check=n=>{try{const i=n.value,a=new URL(i),o=a.href;return r.hostname&&(r.hostname.lastIndex=0,r.hostname.test(a.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:V.source,input:n.value,inst:e,continue:!r.abort})),r.protocol&&(r.protocol.lastIndex=0,r.protocol.test(a.protocol.endsWith(":")?a.protocol.slice(0,-1):a.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:r.protocol.source,input:n.value,inst:e,continue:!r.abort})),void(!i.endsWith("/")&&o.endsWith("/")?n.value=o.slice(0,-1):n.value=o)}catch(i){n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!r.abort})}}}),ze=$constructor("$ZodEmoji",(e,r)=>{r.pattern??(r.pattern=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),fe.init(e,r)}),Re=$constructor("$ZodNanoID",(e,r)=>{r.pattern??(r.pattern=P),fe.init(e,r)}),Ie=$constructor("$ZodCUID",(e,r)=>{r.pattern??(r.pattern=x),fe.init(e,r)}),Ee=$constructor("$ZodCUID2",(e,r)=>{r.pattern??(r.pattern=A),fe.init(e,r)}),xe=$constructor("$ZodULID",(e,r)=>{r.pattern??(r.pattern=S),fe.init(e,r)}),_e=$constructor("$ZodXID",(e,r)=>{r.pattern??(r.pattern=k),fe.init(e,r)}),Ae=$constructor("$ZodKSUID",(e,r)=>{r.pattern??(r.pattern=T),fe.init(e,r)}),Se=$constructor("$ZodISODateTime",(e,r)=>{r.pattern??(r.pattern=function(e){const r=timeSource({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-]\\d{2}:\\d{2})");const i=`${r}(?:${n.join("|")})`;return new RegExp(`^${B}T(?:${i})$`)}(r)),fe.init(e,r)}),ke=$constructor("$ZodISODate",(e,r)=>{r.pattern??(r.pattern=W),fe.init(e,r)}),Te=$constructor("$ZodISOTime",(e,r)=>{r.pattern??(r.pattern=new RegExp(`^${timeSource(r)}$`)),fe.init(e,r)}),Pe=$constructor("$ZodISODuration",(e,r)=>{r.pattern??(r.pattern=O),fe.init(e,r)}),Oe=$constructor("$ZodIPv4",(e,r)=>{r.pattern??(r.pattern=j),fe.init(e,r),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),Ce=$constructor("$ZodIPv6",(e,r)=>{r.pattern??(r.pattern=N),fe.init(e,r),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!r.abort})}}}),$e=$constructor("$ZodCIDRv4",(e,r)=>{r.pattern??(r.pattern=D),fe.init(e,r)}),je=$constructor("$ZodCIDRv6",(e,r)=>{r.pattern??(r.pattern=U),fe.init(e,r),e._zod.check=n=>{const[i,a]=n.value.split("/");try{if(!a)throw new Error;const e=Number(a);if(`${e}`!==a)throw new Error;if(e<0||e>128)throw new Error;new URL(`http://[${i}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!r.abort})}}});function isValidBase64(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const Ne=$constructor("$ZodBase64",(e,r)=>{r.pattern??(r.pattern=M),fe.init(e,r),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=n=>{isValidBase64(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!r.abort})}});const De=$constructor("$ZodBase64URL",(e,r)=>{r.pattern??(r.pattern=L),fe.init(e,r),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=n=>{(function(e){if(!L.test(e))return!1;const r=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return isValidBase64(r.padEnd(4*Math.ceil(r.length/4),"="))})(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!r.abort})}}),Ue=$constructor("$ZodE164",(e,r)=>{r.pattern??(r.pattern=F),fe.init(e,r)});const Me=$constructor("$ZodJWT",(e,r)=>{fe.init(e,r),e._zod.check=n=>{(function(e,r=null){try{const n=e.split(".");if(3!==n.length)return!1;const[i]=n;if(!i)return!1;const a=JSON.parse(atob(i));return!("typ"in a&&"JWT"!==a?.typ||!a.alg||r&&(!("alg"in a)||a.alg!==r))}catch{return!1}})(n.value,r.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!r.abort})}}),Le=$constructor("$ZodNumber",(e,r)=>{he.init(e,r),e._zod.pattern=e._zod.bag.pattern??H,e._zod.parse=(n,i)=>{if(r.coerce)try{n.value=Number(n.value)}catch(e){}const a=n.value;if("number"==typeof a&&!Number.isNaN(a)&&Number.isFinite(a))return n;const o="number"==typeof a?Number.isNaN(a)?"NaN":Number.isFinite(a)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:a,inst:e,...o?{received:o}:{}}),n}}),Ve=$constructor("$ZodNumber",(e,r)=>{te.init(e,r),Le.init(e,r)}),Fe=$constructor("$ZodBoolean",(e,r)=>{he.init(e,r),e._zod.pattern=Z,e._zod.parse=(n,i)=>{if(r.coerce)try{n.value=Boolean(n.value)}catch(e){}const a=n.value;return"boolean"==typeof a||n.issues.push({expected:"boolean",code:"invalid_type",input:a,inst:e}),n}}),Be=$constructor("$ZodUnknown",(e,r)=>{he.init(e,r),e._zod.parse=e=>e}),We=$constructor("$ZodNever",(e,r)=>{he.init(e,r),e._zod.parse=(r,n)=>(r.issues.push({expected:"never",code:"invalid_type",input:r.value,inst:e}),r)});function handleArrayResult(e,r,n){e.issues.length&&r.issues.push(...prefixIssues(n,e.issues)),r.value[n]=e.value}const Je=$constructor("$ZodArray",(e,r)=>{he.init(e,r),e._zod.parse=(n,i)=>{const a=n.value;if(!Array.isArray(a))return n.issues.push({expected:"array",code:"invalid_type",input:a,inst:e}),n;n.value=Array(a.length);const o=[];for(let e=0;e<a.length;e++){const s=a[e],u=r.element._zod.run({value:s,issues:[]},i);u instanceof Promise?o.push(u.then(r=>handleArrayResult(r,n,e))):handleArrayResult(u,n,e)}return o.length?Promise.all(o).then(()=>n):n}});function handleObjectResult(e,r,n){e.issues.length&&r.issues.push(...prefixIssues(n,e.issues)),r.value[n]=e.value}function handleOptionalObjectResult(e,r,n,i){e.issues.length?void 0===i[n]?r.value[n]=n in i?void 0:e.value:r.issues.push(...prefixIssues(n,e.issues)):void 0===e.value?n in i&&(r.value[n]=void 0):r.value[n]=e.value}const He=$constructor("$ZodObject",(e,r)=>{he.init(e,r);const n=cached(()=>{const e=Object.keys(r.shape);for(const n of e)if(!(r.shape[n]instanceof he))throw new Error(`Invalid element at key "${n}": expected a Zod schema`);const n=(i=r.shape,Object.keys(i).filter(e=>"optional"===i[e]._zod.optin&&"optional"===i[e]._zod.optout));var i;return{shape:r.shape,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(n)}});defineLazy(e._zod,"propValues",()=>{const e=r.shape,n={};for(const r in e){const i=e[r]._zod;if(i.values){n[r]??(n[r]=new Set);for(const e of i.values)n[r].add(e)}}return n});let i;const a=isObject$1,o=!f.jitless,s=o&&y.value,u=r.catchall;let d;e._zod.parse=(c,l)=>{d??(d=n.value);const p=c.value;if(!a(p))return c.issues.push({expected:"object",code:"invalid_type",input:p,inst:e}),c;const m=[];if(o&&s&&!1===l?.async&&!0!==l.jitless)i||(i=(e=>{const r=new Doc(["shape","payload","ctx"]),i=n.value,parseStr=e=>{const r=esc(e);return`shape[${r}]._zod.run({ value: input[${r}], issues: [] }, ctx)`};r.write("const input = payload.value;");const a=Object.create(null);let o=0;for(const e of i.keys)a[e]="key_"+o++;r.write("const newResult = {}");for(const e of i.keys)if(i.optionalKeys.has(e)){const n=a[e];r.write(`const ${n} = ${parseStr(e)};`);const i=esc(e);r.write(`\n        if (${n}.issues.length) {\n          if (input[${i}] === undefined) {\n            if (${i} in input) {\n              newResult[${i}] = undefined;\n            }\n          } else {\n            payload.issues = payload.issues.concat(\n              ${n}.issues.map((iss) => ({\n                ...iss,\n                path: iss.path ? [${i}, ...iss.path] : [${i}],\n              }))\n            );\n          }\n        } else if (${n}.value === undefined) {\n          if (${i} in input) newResult[${i}] = undefined;\n        } else {\n          newResult[${i}] = ${n}.value;\n        }\n        `)}else{const n=a[e];r.write(`const ${n} = ${parseStr(e)};`),r.write(`\n          if (${n}.issues.length) payload.issues = payload.issues.concat(${n}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${esc(e)}, ...iss.path] : [${esc(e)}]\n          })));`),r.write(`newResult[${esc(e)}] = ${n}.value`)}r.write("payload.value = newResult;"),r.write("return payload;");const s=r.compile();return(r,n)=>s(e,r,n)})(r.shape)),c=i(c,l);else{c.value={};const e=d.shape;for(const r of d.keys){const n=e[r],i=n._zod.run({value:p[r],issues:[]},l),a="optional"===n._zod.optin&&"optional"===n._zod.optout;i instanceof Promise?m.push(i.then(e=>a?handleOptionalObjectResult(e,c,r,p):handleObjectResult(e,c,r))):a?handleOptionalObjectResult(i,c,r,p):handleObjectResult(i,c,r)}}if(!u)return m.length?Promise.all(m).then(()=>c):c;const h=[],g=d.keySet,f=u._zod,w=f.def.type;for(const e of Object.keys(p)){if(g.has(e))continue;if("never"===w){h.push(e);continue}const r=f.run({value:p[e],issues:[]},l);r instanceof Promise?m.push(r.then(r=>handleObjectResult(r,c,e))):handleObjectResult(r,c,e)}return h.length&&c.issues.push({code:"unrecognized_keys",keys:h,input:p,inst:e}),m.length?Promise.all(m).then(()=>c):c}});function handleUnionResults(e,r,n,i){for(const n of e)if(0===n.issues.length)return r.value=n.value,r;return r.issues.push({code:"invalid_union",input:r.value,inst:n,errors:e.map(e=>e.issues.map(e=>finalizeIssue(e,i,config())))}),r}const Ze=$constructor("$ZodUnion",(e,r)=>{he.init(e,r),defineLazy(e._zod,"optin",()=>r.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),defineLazy(e._zod,"optout",()=>r.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),defineLazy(e._zod,"values",()=>{if(r.options.every(e=>e._zod.values))return new Set(r.options.flatMap(e=>Array.from(e._zod.values)))}),defineLazy(e._zod,"pattern",()=>{if(r.options.every(e=>e._zod.pattern)){const e=r.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>cleanRegex(e.source)).join("|")})$`)}}),e._zod.parse=(n,i)=>{let a=!1;const o=[];for(const e of r.options){const r=e._zod.run({value:n.value,issues:[]},i);if(r instanceof Promise)o.push(r),a=!0;else{if(0===r.issues.length)return r;o.push(r)}}return a?Promise.all(o).then(r=>handleUnionResults(r,n,e,i)):handleUnionResults(o,n,e,i)}}),qe=$constructor("$ZodIntersection",(e,r)=>{he.init(e,r),e._zod.parse=(e,n)=>{const i=e.value,a=r.left._zod.run({value:i,issues:[]},n),o=r.right._zod.run({value:i,issues:[]},n);return a instanceof Promise||o instanceof Promise?Promise.all([a,o]).then(([r,n])=>handleIntersectionResults(e,r,n)):handleIntersectionResults(e,a,o)}});function mergeValues(e,r){if(e===r)return{valid:!0,data:e};if(e instanceof Date&&r instanceof Date&&+e===+r)return{valid:!0,data:e};if(isPlainObject(e)&&isPlainObject(r)){const n=Object.keys(r),i=Object.keys(e).filter(e=>-1!==n.indexOf(e)),a={...e,...r};for(const n of i){const i=mergeValues(e[n],r[n]);if(!i.valid)return{valid:!1,mergeErrorPath:[n,...i.mergeErrorPath]};a[n]=i.data}return{valid:!0,data:a}}if(Array.isArray(e)&&Array.isArray(r)){if(e.length!==r.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let i=0;i<e.length;i++){const a=mergeValues(e[i],r[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};n.push(a.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function handleIntersectionResults(e,r,n){if(r.issues.length&&e.issues.push(...r.issues),n.issues.length&&e.issues.push(...n.issues),aborted(e))return e;const i=mergeValues(r.value,n.value);if(!i.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(i.mergeErrorPath)}`);return e.value=i.data,e}const Ke=$constructor("$ZodEnum",(e,r)=>{he.init(e,r);const n=function(e){const r=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,n])=>-1===r.indexOf(+e)).map(([e,r])=>r)}(r.entries);e._zod.values=new Set(n),e._zod.pattern=new RegExp(`^(${n.filter(e=>b.has(typeof e)).map(e=>"string"==typeof e?escapeRegex(e):e.toString()).join("|")})$`),e._zod.parse=(r,i)=>{const a=r.value;return e._zod.values.has(a)||r.issues.push({code:"invalid_value",values:n,input:a,inst:e}),r}}),Ge=$constructor("$ZodLiteral",(e,r)=>{he.init(e,r),e._zod.values=new Set(r.values),e._zod.pattern=new RegExp(`^(${r.values.map(e=>"string"==typeof e?escapeRegex(e):e?e.toString():String(e)).join("|")})$`),e._zod.parse=(n,i)=>{const a=n.value;return e._zod.values.has(a)||n.issues.push({code:"invalid_value",values:r.values,input:a,inst:e}),n}}),Qe=$constructor("$ZodTransform",(e,r)=>{he.init(e,r),e._zod.parse=(e,n)=>{const i=r.transform(e.value,e);if(n.async){return(i instanceof Promise?i:Promise.resolve(i)).then(r=>(e.value=r,e))}if(i instanceof Promise)throw new $ZodAsyncError;return e.value=i,e}}),Ye=$constructor("$ZodOptional",(e,r)=>{he.init(e,r),e._zod.optin="optional",e._zod.optout="optional",defineLazy(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,void 0]):void 0),defineLazy(e._zod,"pattern",()=>{const e=r.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)})?$`):void 0}),e._zod.parse=(e,n)=>"optional"===r.innerType._zod.optin?r.innerType._zod.run(e,n):void 0===e.value?e:r.innerType._zod.run(e,n)}),Xe=$constructor("$ZodNullable",(e,r)=>{he.init(e,r),defineLazy(e._zod,"optin",()=>r.innerType._zod.optin),defineLazy(e._zod,"optout",()=>r.innerType._zod.optout),defineLazy(e._zod,"pattern",()=>{const e=r.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)}|null)$`):void 0}),defineLazy(e._zod,"values",()=>r.innerType._zod.values?new Set([...r.innerType._zod.values,null]):void 0),e._zod.parse=(e,n)=>null===e.value?e:r.innerType._zod.run(e,n)}),et=$constructor("$ZodDefault",(e,r)=>{he.init(e,r),e._zod.optin="optional",defineLazy(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(e,n)=>{if(void 0===e.value)return e.value=r.defaultValue,e;const i=r.innerType._zod.run(e,n);return i instanceof Promise?i.then(e=>handleDefaultResult(e,r)):handleDefaultResult(i,r)}});function handleDefaultResult(e,r){return void 0===e.value&&(e.value=r.defaultValue),e}const tt=$constructor("$ZodPrefault",(e,r)=>{he.init(e,r),e._zod.optin="optional",defineLazy(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(e,n)=>(void 0===e.value&&(e.value=r.defaultValue),r.innerType._zod.run(e,n))}),rt=$constructor("$ZodNonOptional",(e,r)=>{he.init(e,r),defineLazy(e._zod,"values",()=>{const e=r.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(n,i)=>{const a=r.innerType._zod.run(n,i);return a instanceof Promise?a.then(r=>handleNonOptionalResult(r,e)):handleNonOptionalResult(a,e)}});function handleNonOptionalResult(e,r){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:r}),e}const nt=$constructor("$ZodCatch",(e,r)=>{he.init(e,r),e._zod.optin="optional",defineLazy(e._zod,"optout",()=>r.innerType._zod.optout),defineLazy(e._zod,"values",()=>r.innerType._zod.values),e._zod.parse=(e,n)=>{const i=r.innerType._zod.run(e,n);return i instanceof Promise?i.then(i=>(e.value=i.value,i.issues.length&&(e.value=r.catchValue({...e,error:{issues:i.issues.map(e=>finalizeIssue(e,n,config()))},input:e.value}),e.issues=[]),e)):(e.value=i.value,i.issues.length&&(e.value=r.catchValue({...e,error:{issues:i.issues.map(e=>finalizeIssue(e,n,config()))},input:e.value}),e.issues=[]),e)}}),it=$constructor("$ZodPipe",(e,r)=>{he.init(e,r),defineLazy(e._zod,"values",()=>r.in._zod.values),defineLazy(e._zod,"optin",()=>r.in._zod.optin),defineLazy(e._zod,"optout",()=>r.out._zod.optout),defineLazy(e._zod,"propValues",()=>r.in._zod.propValues),e._zod.parse=(e,n)=>{const i=r.in._zod.run(e,n);return i instanceof Promise?i.then(e=>handlePipeResult(e,r,n)):handlePipeResult(i,r,n)}});function handlePipeResult(e,r,n){return aborted(e)?e:r.out._zod.run({value:e.value,issues:e.issues},n)}const at=$constructor("$ZodReadonly",(e,r)=>{he.init(e,r),defineLazy(e._zod,"propValues",()=>r.innerType._zod.propValues),defineLazy(e._zod,"values",()=>r.innerType._zod.values),defineLazy(e._zod,"optin",()=>r.innerType._zod.optin),defineLazy(e._zod,"optout",()=>r.innerType._zod.optout),e._zod.parse=(e,n)=>{const i=r.innerType._zod.run(e,n);return i instanceof Promise?i.then(handleReadonlyResult):handleReadonlyResult(i)}});function handleReadonlyResult(e){return e.value=Object.freeze(e.value),e}const ot=$constructor("$ZodCustom",(e,r)=>{G.init(e,r),he.init(e,r),e._zod.parse=(e,r)=>e,e._zod.check=n=>{const i=n.value,a=r.fn(i);if(a instanceof Promise)return a.then(r=>handleRefineResult(r,n,i,e));handleRefineResult(a,n,i,e)}});function handleRefineResult(e,r,n,i){if(!e){const e={code:"custom",input:n,inst:i,path:[...i._zod.def.path??[]],continue:!i._zod.def.abort};i._zod.def.params&&(e.params=i._zod.def.params),r.issues.push(issue(e))}}class $ZodRegistry{constructor(){this._map=new Map,this._idmap=new Map}add(e,...r){const n=r[0];if(this._map.set(e,n),n&&"object"==typeof n&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const r=this._map.get(e);return r&&"object"==typeof r&&"id"in r&&this._idmap.delete(r.id),this._map.delete(e),this}get(e){const r=e._zod.parent;if(r){const n={...this.get(r)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function registry(){return new $ZodRegistry}const st=registry();function _guid(e,r){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...normalizeParams(r)})}function _lt(e,r){return new Y({check:"less_than",...normalizeParams(r),value:e,inclusive:!1})}function _lte(e,r){return new Y({check:"less_than",...normalizeParams(r),value:e,inclusive:!0})}function _gt(e,r){return new X({check:"greater_than",...normalizeParams(r),value:e,inclusive:!1})}function _gte(e,r){return new X({check:"greater_than",...normalizeParams(r),value:e,inclusive:!0})}function _multipleOf(e,r){return new ee({check:"multiple_of",...normalizeParams(r),value:e})}function _maxLength(e,r){return new re({check:"max_length",...normalizeParams(r),maximum:e})}function _minLength(e,r){return new ne({check:"min_length",...normalizeParams(r),minimum:e})}function _length(e,r){return new ie({check:"length_equals",...normalizeParams(r),length:e})}function _overwrite(e){return new pe({check:"overwrite",tx:e})}const ut=$constructor("ZodISODateTime",(e,r)=>{Se.init(e,r),vt.init(e,r)});function datetime(e){return function(e,r){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...normalizeParams(r)})}(ut,e)}const dt=$constructor("ZodISODate",(e,r)=>{ke.init(e,r),vt.init(e,r)});function date(e){return function(e,r){return new e({type:"string",format:"date",check:"string_format",...normalizeParams(r)})}(dt,e)}const ct=$constructor("ZodISOTime",(e,r)=>{Te.init(e,r),vt.init(e,r)});function time(e){return function(e,r){return new e({type:"string",format:"time",check:"string_format",precision:null,...normalizeParams(r)})}(ct,e)}const lt=$constructor("ZodISODuration",(e,r)=>{Pe.init(e,r),vt.init(e,r)});function duration(e){return function(e,r){return new e({type:"string",format:"duration",check:"string_format",...normalizeParams(r)})}(lt,e)}const pt=$constructor("ZodError",(e,r)=>{z.init(e,r),e.name="ZodError",Object.defineProperties(e,{format:{value:r=>function(e,r){const n=r||function(e){return e.message},i={_errors:[]},processError=e=>{for(const r of e.issues)if("invalid_union"===r.code&&r.errors.length)r.errors.map(e=>processError({issues:e}));else if("invalid_key"===r.code)processError({issues:r.issues});else if("invalid_element"===r.code)processError({issues:r.issues});else if(0===r.path.length)i._errors.push(n(r));else{let e=i,a=0;for(;a<r.path.length;){const i=r.path[a];a===r.path.length-1?(e[i]=e[i]||{_errors:[]},e[i]._errors.push(n(r))):e[i]=e[i]||{_errors:[]},e=e[i],a++}}};return processError(e),i}(e,r)},flatten:{value:r=>function(e,r=e=>e.message){const n={},i=[];for(const a of e.issues)a.path.length>0?(n[a.path[0]]=n[a.path[0]]||[],n[a.path[0]].push(r(a))):i.push(r(a));return{formErrors:i,fieldErrors:n}}(e,r)},addIssue:{value:r=>e.issues.push(r)},addIssues:{value:r=>e.issues.push(...r)},isEmpty:{get:()=>0===e.issues.length}})},{Parent:Error}),mt=_parse(pt),ht=_parseAsync(pt),gt=_safeParse(pt),ft=_safeParseAsync(pt),wt=$constructor("ZodType",(e,r)=>(he.init(e,r),e.def=r,Object.defineProperty(e,"_def",{value:r}),e.check=(...n)=>e.clone({...r,checks:[...r.checks??[],...n.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]}),e.clone=(r,n)=>clone(e,r,n),e.brand=()=>e,e.register=(r,n)=>(r.add(e,n),e),e.parse=(r,n)=>mt(e,r,n,{callee:e.parse}),e.safeParse=(r,n)=>gt(e,r,n),e.parseAsync=async(r,n)=>ht(e,r,n,{callee:e.parseAsync}),e.safeParseAsync=async(r,n)=>ft(e,r,n),e.spa=e.safeParseAsync,e.refine=(r,n)=>e.check(function(e,r={}){return function(e,r,n){return new e({type:"custom",check:"custom",fn:r,...normalizeParams(n)})}(or,e,r)}(r,n)),e.superRefine=r=>e.check(function(e){const r=function(e){const r=new G({check:"custom"});return r._zod.check=e,r}(n=>(n.addIssue=e=>{if("string"==typeof e)n.issues.push(issue(e,n.value,r._zod.def));else{const i=e;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=r),i.continue??(i.continue=!r._zod.def.abort),n.issues.push(issue(i))}},e(n.value,n)));return r}(r)),e.overwrite=r=>e.check(_overwrite(r)),e.optional=()=>optional(e),e.nullable=()=>nullable(e),e.nullish=()=>optional(nullable(e)),e.nonoptional=r=>function(e,r){return new rr({type:"nonoptional",innerType:e,...normalizeParams(r)})}(e,r),e.array=()=>array(e),e.or=r=>{return new Zt({type:"union",options:[e,r],...normalizeParams(n)});var n},e.and=r=>new qt({type:"intersection",left:e,right:r}),e.transform=r=>pipe(e,new Qt({type:"transform",transform:r})),e.default=r=>{return n=r,new er({type:"default",innerType:e,get defaultValue(){return"function"==typeof n?n():n}});var n},e.prefault=r=>{return n=r,new tr({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof n?n():n}});var n},e.catch=r=>{return new nr({type:"catch",innerType:e,catchValue:"function"==typeof(n=r)?n:()=>n});var n},e.pipe=r=>pipe(e,r),e.readonly=()=>new ar({type:"readonly",innerType:e}),e.describe=r=>{const n=e.clone();return st.add(n,{description:r}),n},Object.defineProperty(e,"description",{get:()=>st.get(e)?.description,configurable:!0}),e.meta=(...r)=>{if(0===r.length)return st.get(e);const n=e.clone();return st.add(n,r[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),yt=$constructor("_ZodString",(e,r)=>{ge.init(e,r),wt.init(e,r);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...r)=>e.check(function(e,r){return new oe({check:"string_format",format:"regex",...normalizeParams(r),pattern:e})}(...r)),e.includes=(...r)=>e.check(function(e,r){return new de({check:"string_format",format:"includes",...normalizeParams(r),includes:e})}(...r)),e.startsWith=(...r)=>e.check(function(e,r){return new ce({check:"string_format",format:"starts_with",...normalizeParams(r),prefix:e})}(...r)),e.endsWith=(...r)=>e.check(function(e,r){return new le({check:"string_format",format:"ends_with",...normalizeParams(r),suffix:e})}(...r)),e.min=(...r)=>e.check(_minLength(...r)),e.max=(...r)=>e.check(_maxLength(...r)),e.length=(...r)=>e.check(_length(...r)),e.nonempty=(...r)=>e.check(_minLength(1,...r)),e.lowercase=r=>e.check(function(e){return new se({check:"string_format",format:"lowercase",...normalizeParams(e)})}(r)),e.uppercase=r=>e.check(function(e){return new ue({check:"string_format",format:"uppercase",...normalizeParams(e)})}(r)),e.trim=()=>e.check(_overwrite(e=>e.trim())),e.normalize=(...r)=>e.check(function(e){return _overwrite(r=>r.normalize(e))}(...r)),e.toLowerCase=()=>e.check(_overwrite(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(_overwrite(e=>e.toUpperCase()))}),bt=$constructor("ZodString",(e,r)=>{ge.init(e,r),yt.init(e,r),e.email=r=>e.check(function(e,r){return new e({type:"string",format:"email",check:"string_format",abort:!1,...normalizeParams(r)})}(zt,r)),e.url=r=>e.check(function(e,r){return new e({type:"string",format:"url",check:"string_format",abort:!1,...normalizeParams(r)})}(Et,r)),e.jwt=r=>e.check(function(e,r){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...normalizeParams(r)})}(Mt,r)),e.emoji=r=>e.check(function(e,r){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...normalizeParams(r)})}(xt,r)),e.guid=r=>e.check(_guid(Rt,r)),e.uuid=r=>e.check(function(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...normalizeParams(r)})}(It,r)),e.uuidv4=r=>e.check(function(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...normalizeParams(r)})}(It,r)),e.uuidv6=r=>e.check(function(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...normalizeParams(r)})}(It,r)),e.uuidv7=r=>e.check(function(e,r){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...normalizeParams(r)})}(It,r)),e.nanoid=r=>e.check(function(e,r){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...normalizeParams(r)})}(_t,r)),e.guid=r=>e.check(_guid(Rt,r)),e.cuid=r=>e.check(function(e,r){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...normalizeParams(r)})}(At,r)),e.cuid2=r=>e.check(function(e,r){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...normalizeParams(r)})}(St,r)),e.ulid=r=>e.check(function(e,r){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...normalizeParams(r)})}(kt,r)),e.base64=r=>e.check(function(e,r){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...normalizeParams(r)})}(Nt,r)),e.base64url=r=>e.check(function(e,r){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...normalizeParams(r)})}(Dt,r)),e.xid=r=>e.check(function(e,r){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...normalizeParams(r)})}(Tt,r)),e.ksuid=r=>e.check(function(e,r){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...normalizeParams(r)})}(Pt,r)),e.ipv4=r=>e.check(function(e,r){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...normalizeParams(r)})}(Ot,r)),e.ipv6=r=>e.check(function(e,r){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...normalizeParams(r)})}(Ct,r)),e.cidrv4=r=>e.check(function(e,r){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...normalizeParams(r)})}($t,r)),e.cidrv6=r=>e.check(function(e,r){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...normalizeParams(r)})}(jt,r)),e.e164=r=>e.check(function(e,r){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...normalizeParams(r)})}(Ut,r)),e.datetime=r=>e.check(datetime(r)),e.date=r=>e.check(date(r)),e.time=r=>e.check(time(r)),e.duration=r=>e.check(duration(r))});function string(e){return function(e,r){return new e({type:"string",...normalizeParams(r)})}(bt,e)}const vt=$constructor("ZodStringFormat",(e,r)=>{fe.init(e,r),yt.init(e,r)}),zt=$constructor("ZodEmail",(e,r)=>{be.init(e,r),vt.init(e,r)}),Rt=$constructor("ZodGUID",(e,r)=>{we.init(e,r),vt.init(e,r)}),It=$constructor("ZodUUID",(e,r)=>{ye.init(e,r),vt.init(e,r)}),Et=$constructor("ZodURL",(e,r)=>{ve.init(e,r),vt.init(e,r)}),xt=$constructor("ZodEmoji",(e,r)=>{ze.init(e,r),vt.init(e,r)}),_t=$constructor("ZodNanoID",(e,r)=>{Re.init(e,r),vt.init(e,r)}),At=$constructor("ZodCUID",(e,r)=>{Ie.init(e,r),vt.init(e,r)}),St=$constructor("ZodCUID2",(e,r)=>{Ee.init(e,r),vt.init(e,r)}),kt=$constructor("ZodULID",(e,r)=>{xe.init(e,r),vt.init(e,r)}),Tt=$constructor("ZodXID",(e,r)=>{_e.init(e,r),vt.init(e,r)}),Pt=$constructor("ZodKSUID",(e,r)=>{Ae.init(e,r),vt.init(e,r)}),Ot=$constructor("ZodIPv4",(e,r)=>{Oe.init(e,r),vt.init(e,r)}),Ct=$constructor("ZodIPv6",(e,r)=>{Ce.init(e,r),vt.init(e,r)}),$t=$constructor("ZodCIDRv4",(e,r)=>{$e.init(e,r),vt.init(e,r)}),jt=$constructor("ZodCIDRv6",(e,r)=>{je.init(e,r),vt.init(e,r)}),Nt=$constructor("ZodBase64",(e,r)=>{Ne.init(e,r),vt.init(e,r)}),Dt=$constructor("ZodBase64URL",(e,r)=>{De.init(e,r),vt.init(e,r)}),Ut=$constructor("ZodE164",(e,r)=>{Ue.init(e,r),vt.init(e,r)}),Mt=$constructor("ZodJWT",(e,r)=>{Me.init(e,r),vt.init(e,r)}),Lt=$constructor("ZodNumber",(e,r)=>{Le.init(e,r),wt.init(e,r),e.gt=(r,n)=>e.check(_gt(r,n)),e.gte=(r,n)=>e.check(_gte(r,n)),e.min=(r,n)=>e.check(_gte(r,n)),e.lt=(r,n)=>e.check(_lt(r,n)),e.lte=(r,n)=>e.check(_lte(r,n)),e.max=(r,n)=>e.check(_lte(r,n)),e.int=r=>e.check(int(r)),e.safe=r=>e.check(int(r)),e.positive=r=>e.check(_gt(0,r)),e.nonnegative=r=>e.check(_gte(0,r)),e.negative=r=>e.check(_lt(0,r)),e.nonpositive=r=>e.check(_lte(0,r)),e.multipleOf=(r,n)=>e.check(_multipleOf(r,n)),e.step=(r,n)=>e.check(_multipleOf(r,n)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function number(e){return function(e,r){return new e({type:"number",checks:[],...normalizeParams(r)})}(Lt,e)}const Vt=$constructor("ZodNumberFormat",(e,r)=>{Ve.init(e,r),Lt.init(e,r)});function int(e){return function(e,r){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...normalizeParams(r)})}(Vt,e)}const Ft=$constructor("ZodBoolean",(e,r)=>{Fe.init(e,r),wt.init(e,r)});function boolean(e){return function(e,r){return new e({type:"boolean",...normalizeParams(r)})}(Ft,e)}const Bt=$constructor("ZodUnknown",(e,r)=>{Be.init(e,r),wt.init(e,r)});function unknown(){return new Bt({type:"unknown"})}const Wt=$constructor("ZodNever",(e,r)=>{We.init(e,r),wt.init(e,r)});function never(e){return function(e,r){return new e({type:"never",...normalizeParams(r)})}(Wt,e)}const Jt=$constructor("ZodArray",(e,r)=>{Je.init(e,r),wt.init(e,r),e.element=r.element,e.min=(r,n)=>e.check(_minLength(r,n)),e.nonempty=r=>e.check(_minLength(1,r)),e.max=(r,n)=>e.check(_maxLength(r,n)),e.length=(r,n)=>e.check(_length(r,n)),e.unwrap=()=>e.element});function array(e,r){return function(e,r,n){return new e({type:"array",element:r,...normalizeParams(n)})}(Jt,e,r)}const Ht=$constructor("ZodObject",(e,r)=>{He.init(e,r),wt.init(e,r),defineLazy(e,"shape",()=>r.shape),e.keyof=()=>_enum(Object.keys(e._zod.def.shape)),e.catchall=r=>e.clone({...e._zod.def,catchall:r}),e.passthrough=()=>e.clone({...e._zod.def,catchall:unknown()}),e.loose=()=>e.clone({...e._zod.def,catchall:unknown()}),e.strict=()=>e.clone({...e._zod.def,catchall:never()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=r=>function(e,r){if(!isPlainObject(r))throw new Error("Invalid input to extend: expected a plain object");const n={...e._zod.def,get shape(){const n={...e._zod.def.shape,...r};return assignProp(this,"shape",n),n},checks:[]};return clone(e,n)}(e,r),e.merge=r=>{return i=r,clone(n=e,{...n._zod.def,get shape(){const e={...n._zod.def.shape,...i._zod.def.shape};return assignProp(this,"shape",e),e},catchall:i._zod.def.catchall,checks:[]});var n,i},e.pick=r=>function(e,r){const n={},i=e._zod.def;for(const e in r){if(!(e in i.shape))throw new Error(`Unrecognized key: "${e}"`);r[e]&&(n[e]=i.shape[e])}return clone(e,{...e._zod.def,shape:n,checks:[]})}(e,r),e.omit=r=>function(e,r){const n={...e._zod.def.shape},i=e._zod.def;for(const e in r){if(!(e in i.shape))throw new Error(`Unrecognized key: "${e}"`);r[e]&&delete n[e]}return clone(e,{...e._zod.def,shape:n,checks:[]})}(e,r),e.partial=(...r)=>function(e,r,n){const i=r._zod.def.shape,a={...i};if(n)for(const r in n){if(!(r in i))throw new Error(`Unrecognized key: "${r}"`);n[r]&&(a[r]=e?new e({type:"optional",innerType:i[r]}):i[r])}else for(const r in i)a[r]=e?new e({type:"optional",innerType:i[r]}):i[r];return clone(r,{...r._zod.def,shape:a,checks:[]})}(Yt,e,r[0]),e.required=(...r)=>function(e,r,n){const i=r._zod.def.shape,a={...i};if(n)for(const r in n){if(!(r in a))throw new Error(`Unrecognized key: "${r}"`);n[r]&&(a[r]=new e({type:"nonoptional",innerType:i[r]}))}else for(const r in i)a[r]=new e({type:"nonoptional",innerType:i[r]});return clone(r,{...r._zod.def,shape:a,checks:[]})}(rr,e,r[0])});function object(e,r){const n={type:"object",get shape(){return assignProp(this,"shape",{...e}),this.shape},...normalizeParams(r)};return new Ht(n)}const Zt=$constructor("ZodUnion",(e,r)=>{Ze.init(e,r),wt.init(e,r),e.options=r.options});const qt=$constructor("ZodIntersection",(e,r)=>{qe.init(e,r),wt.init(e,r)});const Kt=$constructor("ZodEnum",(e,r)=>{Ke.init(e,r),wt.init(e,r),e.enum=r.entries,e.options=Object.values(r.entries);const n=new Set(Object.keys(r.entries));e.extract=(e,i)=>{const a={};for(const i of e){if(!n.has(i))throw new Error(`Key ${i} not found in enum`);a[i]=r.entries[i]}return new Kt({...r,checks:[],...normalizeParams(i),entries:a})},e.exclude=(e,i)=>{const a={...r.entries};for(const r of e){if(!n.has(r))throw new Error(`Key ${r} not found in enum`);delete a[r]}return new Kt({...r,checks:[],...normalizeParams(i),entries:a})}});function _enum(e,r){const n=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new Kt({type:"enum",entries:n,...normalizeParams(r)})}const Gt=$constructor("ZodLiteral",(e,r)=>{Ge.init(e,r),wt.init(e,r),e.values=new Set(r.values),Object.defineProperty(e,"value",{get(){if(r.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return r.values[0]}})});function literal(e,r){return new Gt({type:"literal",values:Array.isArray(e)?e:[e],...normalizeParams(r)})}const Qt=$constructor("ZodTransform",(e,r)=>{Qe.init(e,r),wt.init(e,r),e._zod.parse=(n,i)=>{n.addIssue=i=>{if("string"==typeof i)n.issues.push(issue(i,n.value,r));else{const r=i;r.fatal&&(r.continue=!1),r.code??(r.code="custom"),r.input??(r.input=n.value),r.inst??(r.inst=e),r.continue??(r.continue=!0),n.issues.push(issue(r))}};const a=r.transform(n.value,n);return a instanceof Promise?a.then(e=>(n.value=e,n)):(n.value=a,n)}});const Yt=$constructor("ZodOptional",(e,r)=>{Ye.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType});function optional(e){return new Yt({type:"optional",innerType:e})}const Xt=$constructor("ZodNullable",(e,r)=>{Xe.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType});function nullable(e){return new Xt({type:"nullable",innerType:e})}const er=$constructor("ZodDefault",(e,r)=>{et.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});const tr=$constructor("ZodPrefault",(e,r)=>{tt.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType});const rr=$constructor("ZodNonOptional",(e,r)=>{rt.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType});const nr=$constructor("ZodCatch",(e,r)=>{nt.init(e,r),wt.init(e,r),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});const ir=$constructor("ZodPipe",(e,r)=>{it.init(e,r),wt.init(e,r),e.in=r.in,e.out=r.out});function pipe(e,r){return new ir({type:"pipe",in:e,out:r})}const ar=$constructor("ZodReadonly",(e,r)=>{at.init(e,r),wt.init(e,r)});const or=$constructor("ZodCustom",(e,r)=>{ot.init(e,r),wt.init(e,r)});object({id:string().describe("Unique identifier")});const sr=object({id:string(),email:string().email(),username:string(),emailVerified:boolean()}),ur=sr.extend({createdAt:number(),updatedAt:number()}),dr=sr.pick({id:!0,email:!0,username:!0,emailVerified:!0}),cr=object({id:string(),name:string(),displayName:string(),description:string().nullable(),ownerId:string(),createdAt:number(),updatedAt:number()}),lr=object({id:string(),username:string(),email:string(),role:_enum(["owner","member"]),joinedAt:number()});object({id:string(),name:string(),description:string().nullable(),content:string(),tags:array(string()),visibility:_enum(["public","private"]),publishedAt:number().nullable(),createdAt:number(),updatedAt:number(),owner:object({id:string(),username:string(),type:_enum(["user","organization"])})});const pr=object({version:string(),changelog:string(),created_at:number(),createdBy:object({id:string(),username:string()})}),mr=object({success:boolean(),message:string().optional()});object({page:number().min(1).default(1),limit:number().min(1).max(100).default(20)});const hr=object({accessToken:string(),refreshToken:string()}),gr=string().min(1).regex(/^[a-zA-Z0-9_-]+$/).describe("Username (alphanumeric, underscores, and hyphens only)"),fr=string().email().describe("Email address"),wr=string().min(8).describe("Password (minimum 8 characters)"),yr=string().regex(/^[a-zA-Z0-9_-]+$/).describe("Rule name (alphanumeric, underscores, and hyphens only)"),br=string().min(1).max(50).regex(/^[a-zA-Z0-9-]+$/).describe("Organization name (alphanumeric and hyphens only)"),vr={register:c.route({method:"POST",path:"/auth/register",description:"Register a new user account"}).input(object({username:gr,email:fr,password:wr})).output(object({success:boolean(),message:string(),user:sr.pick({id:!0,username:!0,email:!0})})),login:c.route({method:"POST",path:"/auth/login",description:"Login with email and password"}).input(object({email:fr,password:wr.describe("User password"),rememberMe:boolean().optional().describe("Remember login session")})).output(hr.extend({user:dr,message:string().optional()})),refresh:c.route({method:"POST",path:"/auth/refresh",description:"Refresh access token"}).input(object({refreshToken:string()})).output(hr.extend({user:dr})),verifyEmail:c.route({method:"POST",path:"/auth/verifyEmail",description:"Verify email address"}).input(object({token:string()})).output(mr),sendPasswordReset:c.route({method:"POST",path:"/auth/sendPasswordReset",description:"Send password reset email"}).input(object({email:fr})).output(mr),resetPassword:c.route({method:"POST",path:"/auth/resetPassword",description:"Reset password with token"}).input(object({token:string(),newPassword:wr})).output(mr),sendVerification:c.route({method:"POST",path:"/auth/sendVerification",description:"Resend verification email"}).input(object({email:fr,locale:string().optional()})).output(mr),logout:c.route({method:"POST",path:"/auth/logout",description:"Logout user"}).input(object({refreshToken:string()})).output(mr),oauthInitialize:c.route({method:"POST",path:"/auth/oauthInitialize",description:"Initialize OAuth flow"}).input(object({provider:_enum(["google","github"]),redirectUrl:string().optional(),action:_enum(["login","register"]).optional().default("login")})).output(object({authorizationUrl:string()})),oauthCallback:c.route({method:"POST",path:"/auth/oauthCallback",description:"Handle OAuth callback"}).input(object({provider:_enum(["google","github"]),code:string(),state:string()})).output(hr.extend({user:dr,redirectUrl:string()}))},zr={check:c.route({method:"GET",path:"/health",description:"Check the health status of the API"}).output(object({status:literal("healthy"),timestamp:number()}))},Rr={list:c.route({method:"GET",path:"/organizations/list",description:"List organizations the authenticated user belongs to"}).output(array(object({id:string(),name:string(),displayName:string(),owner:object({id:string(),username:string(),email:string()}),memberCount:number(),ruleCount:number()}))),create:c.route({method:"POST",path:"/organizations",description:"Create a new organization"}).input(object({name:br,displayName:string().min(1).max(100).optional().describe("Display name"),description:string().max(500).optional().describe("Organization description"),inviteEmails:array(string().email()).optional().describe("Email addresses to invite")})).output(cr),get:c.route({method:"GET",path:"/organizations/:id",description:"Get organization details"}).input(object({id:string()})).output(object({id:string(),name:string(),displayName:string(),description:string().nullable(),owner:object({id:string(),username:string(),email:string()}),role:_enum(["owner","member"]),memberCount:number(),ruleCount:number(),createdAt:number()})),members:c.route({method:"GET",path:"/organizations/:organizationId/members/summary",description:"Get organization members summary"}).input(object({organizationId:string()})).output(array(lr)),rules:c.route({method:"GET",path:"/organizations/:organizationId/rules/summary",description:"Get organization rules summary"}).input(object({organizationId:string()})).output(array(object({id:string(),name:string(),description:string().nullable(),version:string(),updatedAt:number(),author:object({id:string(),username:string()})}))),acceptInvitation:c.route({method:"POST",path:"/organizations/accept-invitation",description:"Accept organization invitation"}).input(object({token:string()})).output(mr.extend({organization:object({id:string(),name:string(),displayName:string(),description:string().nullable(),ownerId:string(),createdAt:number(),updatedAt:number(),owner:object({id:string(),username:string(),email:string()})})})),update:c.route({method:"PATCH",path:"/organizations/:id",description:"Update organization"}).input(object({id:string(),name:br.optional(),displayName:string().min(1).max(100).optional(),description:string().max(500).optional()})).output(mr.extend({organization:cr})),delete:c.route({method:"DELETE",path:"/organizations/:id",description:"Delete organization"}).input(object({id:string()})).output(mr),removeMember:c.route({method:"DELETE",path:"/organizations/:organizationId/members/:userId",description:"Remove member from organization"}).input(object({organizationId:string(),userId:string()})).output(mr),inviteMember:c.route({method:"POST",path:"/organizations/:organizationId/invite",description:"Invite member to organization"}).input(object({organizationId:string(),email:string().email(),locale:_enum(["ja","en"]).optional()})).output(mr),leave:c.route({method:"POST",path:"/organizations/:organizationId/leave",description:"Leave organization"}).input(object({organizationId:string()})).output(mr),updateMemberRole:c.route({method:"PATCH",path:"/organizations/:orgId/members/:memberId/role",description:"Update member role in organization"}).input(object({orgId:string(),memberId:string(),role:_enum(["owner","member"])})).output(mr),listMembers:c.route({method:"GET",path:"/organizations/:orgId/members",description:"List organization members"}).input(object({orgId:string()})).output(object({members:array(object({id:string(),username:string(),email:string(),role:_enum(["owner","member"]),joinedAt:number()}))})),listRules:c.route({method:"GET",path:"/organizations/:orgId/rules",description:"List organization rules"}).input(object({orgId:string(),page:number().int().positive().default(1),pageSize:number().int().min(1).max(100).default(10)})).output(object({rules:array(object({id:string(),name:string(),description:string().nullable(),visibility:_enum(["public","private","team"]),isPublished:boolean(),downloadCount:number(),starCount:number(),createdAt:number(),updatedAt:number(),user:object({id:string(),username:string()}),latestVersion:string()})),total:number(),page:number(),pageSize:number(),totalPages:number()}))},Ir={auth:vr,health:zr,rules:{getByPath:c.route({method:"POST",path:"/rules/getByPath",description:"Get a rule by its path (@owner/rulename)"}).input(object({path:string().describe("Rule path in format @owner/rulename")})).output(object({id:string(),name:string(),userId:string().nullable(),visibility:string(),description:string().nullable(),tags:array(string()),createdAt:number(),updatedAt:number(),publishedAt:number().nullable(),version:string(),latestVersionId:string().nullable(),downloads:number(),stars:number(),organizationId:string().nullable(),user:object({id:string(),username:string(),email:string()}),organization:object({id:string(),name:string(),displayName:string()}).nullable(),author:object({id:string(),username:string(),email:string()})})),search:c.route({method:"POST",path:"/rules/search",description:"Search rules"}).input(object({query:string().optional(),tags:array(string()).optional(),author:string().optional(),visibility:string().optional(),sortBy:string().optional(),page:number().default(1),limit:number().default(20)})).output(object({rules:array(object({id:string(),name:string(),userId:string().nullable(),visibility:string(),description:string().nullable(),tags:array(string()),createdAt:number(),updatedAt:number(),publishedAt:number().nullable(),version:string(),latestVersionId:string().nullable(),downloads:number(),stars:number(),organizationId:string().nullable(),user:object({id:string(),username:string(),email:string()}),organization:object({id:string(),name:string(),displayName:string()}).nullable(),author:object({id:string(),username:string(),email:string()}),updated_at:number(),created_at:number()})),total:number(),page:number(),limit:number()})),get:c.route({method:"POST",path:"/rules/get",description:"Get a rule by ID"}).input(object({id:string()})).output(object({id:string(),name:string(),userId:string().nullable(),visibility:string(),description:string().nullable(),tags:array(string()),createdAt:number(),updatedAt:number(),publishedAt:number().nullable(),version:string(),latestVersionId:string().nullable(),downloads:number(),stars:number(),organizationId:string().nullable(),user:object({id:string(),username:string(),email:string()}),organization:object({id:string(),name:string(),displayName:string()}).nullable(),author:object({id:string(),username:string(),email:string()}),updated_at:number(),created_at:number()})),create:c.route({method:"POST",path:"/rules/create",description:"Create a new rule"}).input(object({name:yr,description:string().optional(),visibility:_enum(["public","private"]),organizationId:string().optional(),tags:array(string()),content:string()})).output(object({id:string()})),update:c.route({method:"POST",path:"/rules/update",description:"Update a rule"}).input(object({id:string(),name:yr.optional(),description:string().optional(),visibility:_enum(["public","private"]).optional(),organizationId:string().optional(),tags:array(string()).optional(),content:string().optional(),changelog:string().optional(),isMajorVersionUp:boolean().optional()})).output(mr),delete:c.route({method:"POST",path:"/rules/delete",description:"Delete a rule"}).input(object({id:string()})).output(mr),getContent:c.route({method:"POST",path:"/rules/getContent",description:"Get rule content"}).input(object({id:string(),version:string().optional()})).output(object({id:string(),name:string(),version:string(),content:string()})),versions:c.route({method:"POST",path:"/rules/versions",description:"Get rule versions"}).input(object({id:string()})).output(array(pr)),getVersion:c.route({method:"POST",path:"/rules/getVersion",description:"Get specific rule version"}).input(object({id:string(),version:string()})).output(object({id:string(),name:string(),description:string().nullable(),version:string(),content:string(),changelog:string(),visibility:string(),tags:array(string()),author:object({id:string(),username:string()}),organization:object({id:string(),name:string(),displayName:string()}).nullable().optional(),createdAt:number(),createdBy:object({id:string(),username:string()}),isLatest:boolean()})),related:c.route({method:"POST",path:"/rules/related",description:"Get related rules"}).input(object({id:string(),limit:number().min(1).max(10).default(5)})).output(array(object({id:string(),name:string(),description:string().nullable(),author:object({id:string(),username:string()}),visibility:_enum(["public","private","organization"]),tags:array(string()),version:string(),updated_at:number()}))),list:c.route({method:"POST",path:"/rules/list",description:"List rules"}).input(object({visibility:_enum(["public","private","all"]).optional().default("public"),tags:array(string()).optional(),author:string().optional(),limit:number().min(1).max(100).default(20),offset:number().min(0).default(0)})).output(object({rules:array(object({id:string(),name:string(),description:string().nullable(),author:object({id:string(),username:string()}),visibility:string(),tags:array(string()),version:string(),updated_at:number()})),total:number(),limit:number(),offset:number()})),like:c.route({method:"POST",path:"/rules/like",description:"Like a rule"}).input(object({ruleId:string()})).output(mr),unlike:c.route({method:"POST",path:"/rules/unlike",description:"Unlike a rule"}).input(object({ruleId:string()})).output(mr),view:c.route({method:"POST",path:"/rules/view",description:"Record rule view"}).input(object({ruleId:string()})).output(mr),listPublic:c.route({method:"POST",path:"/rules/listPublic",description:"List public rules"}).input(object({tags:array(string()).optional(),author:string().optional(),limit:number().min(1).max(100).default(20),offset:number().min(0).default(0)})).output(object({rules:array(object({id:string(),name:string(),description:string().nullable(),author:object({id:string(),username:string()}),visibility:string(),tags:array(string()),version:string(),updated_at:number()})),total:number(),limit:number(),offset:number()})),star:c.route({method:"POST",path:"/rules/star",description:"Star a rule"}).input(object({ruleId:string()})).output(mr),unstar:c.route({method:"POST",path:"/rules/unstar",description:"Unstar a rule"}).input(object({ruleId:string()})).output(mr),getVersionHistory:c.route({method:"POST",path:"/rules/getVersionHistory",description:"Get version history of a rule"}).input(object({ruleId:string()})).output(array(object({version:string(),changelog:string(),created_at:number(),createdBy:object({id:string(),username:string()})})))},users:{searchByUsername:c.input(object({username:string().min(1),limit:number().min(1).max(20).default(10)})).output(array(object({id:string(),username:string(),email:string()}))),getProfile:c.route({method:"POST",path:"/users/getProfile",description:"Get user profile by username"}).input(object({username:string().min(1)})).output(object({user:object({id:string(),username:string(),email:string(),emailVerified:boolean(),createdAt:number(),updatedAt:number()}),stats:object({rulesCount:number(),organizationsCount:number()}),recentRules:array(object({id:string(),name:string(),description:string(),visibility:string(),createdAt:number(),updatedAt:number(),organization:object({name:string()}).nullable()}))})),profile:c.route({method:"GET",path:"/users/me",description:"Get current user profile"}).output(object({id:string(),email:string(),username:string(),created_at:number(),updated_at:number()})),updateProfile:c.input(object({email:fr.optional(),username:gr.optional()})).output(object({user:ur})),changePassword:c.input(object({currentPassword:string(),newPassword:wr})).output(mr),settings:c.route({method:"GET",path:"/users/settings",description:"Get current user settings"}).output(object({id:string(),email:string(),username:string(),email_verified:boolean(),created_at:number(),updated_at:number()})),updateSettings:c.input(object({currentPassword:string().optional(),newPassword:wr.optional()})).output(mr),deleteAccount:c.input(object({password:string(),confirmation:literal("DELETE")})).output(mr)},organizations:Rr},Er=implement(Ir).$context(),xr=Er.middleware(async({context:e,next:r})=>{const n=e.db||u(e.env.DB);return r({context:{...e,db:n}})}),_r=Er.middleware(async({context:e,next:r})=>{const n=e.db||u(e.env.DB);if(!e.user)throw new i("UNAUTHORIZED",{message:"Authentication required"});return r({context:{...e,db:n,user:e.user}})}),Ar=Er.middleware(async({context:e,next:r})=>{const n=e.db||u(e.env.DB);return r({context:{...e,db:n,user:e.user}})}),Sr=Er.middleware(async({context:e,next:r})=>{const n=e.db||u(e.env.DB);if(!e.user)throw new i("UNAUTHORIZED",{message:"Authentication required"});return r({context:{...e,db:n,user:e.user}})});var kr=Object.defineProperty,__publicField$5=(e,r,n)=>((e,r,n)=>r in e?kr(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n),Tr=(e=>(e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e))(Tr||{});class Logger{constructor(e=1){__publicField$5(this,"minLevel"),__publicField$5(this,"context"),this.minLevel=e,this.context={}}shouldLog(e){return e>=this.minLevel}createLogEntry(e,r,n,i){const a={timestamp:(new Date).toISOString(),level:Tr[e],message:r,...this.context};return n&&(a.context=n),i&&(a.error={name:i.name,message:i.message,stack:i.stack}),a}log(e,r,n,i){if(!this.shouldLog(e))return;const a=this.createLogEntry(e,r,n,i);console.log(JSON.stringify(a))}debug(e,r){this.log(0,e,r)}info(e,r){this.log(1,e,r)}warn(e,r){this.log(2,e,r)}error(e,r,n){this.log(3,e,n,r)}child(e){const r=new Logger(this.minLevel);return r.context={...this.context,...e},r}setRequestContext(e){const r=e.req.header();this.context={...this.context,requestId:r["x-request-id"]||crypto.randomUUID(),method:e.req.method,url:e.req.url,userAgent:r["user-agent"],ip:r["cf-connecting-ip"]||r["x-forwarded-for"]}}setUserContext(e,r){this.context={...this.context,userId:e,username:r}}logApiRequest(e,r,n){const i=Date.now()-e;this.info("API request completed",{duration:i,status:r,...n})}logDatabaseQuery(e,r,n){this.debug("Database query executed",{query:e,duration:r,recordCount:n})}logAuthEvent(e,r,n){this.info(`Auth event: ${e}`,{userId:r,...n})}logRateLimit(e,r,n,i){this.warn(`Rate limit ${e}`,{identifier:r,limit:n,current:i})}}function createLogger(e){return new Logger(1)}function createRateLimitMiddleware(e){return Er.middleware(async({context:r,next:n})=>{const a=r.db||u(r.env.DB),{env:o}=r,{windowMs:s,maxRequests:d,keyPrefix:c}=e,l=function(e){var r;if("user"in e&&(null==(r=e.user)?void 0:r.id))return`user:${e.user.id}`;const n=e.request;if(n&&n.headers){const e=n.headers.get("CF-Connecting-IP");if(e)return`anonymous:${e}`;const r=n.headers.get("X-Forwarded-For");if(r){return`anonymous:${r.split(",")[0].trim()}`}}return"anonymous:default"}(r),p=`${c}:${l}`,m=Math.floor(Date.now()/1e3);try{const e=await a.rateLimit.findUnique({where:{key:p}});if(e)if(e.resetAt<=m)await a.rateLimit.update({where:{key:p},data:{count:1,resetAt:Math.floor((Date.now()+s)/1e3)}});else{if(e.count>=d){const r=e.resetAt-m;throw new i("TOO_MANY_REQUESTS",{message:`${r}`})}await a.rateLimit.update({where:{key:p},data:{count:{increment:1}}})}else await a.rateLimit.create({data:{key:p,count:1,resetAt:Math.floor((Date.now()+s)/1e3)}});return Math.random()<.01&&await a.rateLimit.deleteMany({where:{resetAt:{lt:m}}}),n({context:{...r,db:a}})}catch(e){if(e instanceof i)throw e;return createLogger().error("Rate limit middleware error",e),n({context:{...r,db:a}})}})}const Pr=createRateLimitMiddleware({windowMs:9e5,maxRequests:5,keyPrefix:"auth"}),Or=createRateLimitMiddleware({windowMs:36e5,maxRequests:3,keyPrefix:"auth:register"}),Cr=createRateLimitMiddleware({windowMs:9e5,maxRequests:3,keyPrefix:"auth:reset"});createRateLimitMiddleware({windowMs:6e4,maxRequests:60,keyPrefix:"api"});let nanoid=(e=21)=>{let r="",n=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)r+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return r};var $r=Object.defineProperty,__publicField$4=(e,r,n)=>((e,r,n)=>r in e?$r(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,r+"",n);class BaseRepository{constructor(e){__publicField$4(this,"db"),this.db=e}handleError(e,r){if(console.error("Database error:",e),e instanceof i)throw e;if(this.isPrismaError(e)){const r=e;if("P2002"===r.code)throw new i("CONFLICT",{message:""});if("P2025"===r.code)throw new i("NOT_FOUND",{message:""})}throw new i("INTERNAL_SERVER_ERROR",{message:r})}isPrismaError(e){return null!==e&&"object"==typeof e&&"code"in e&&"string"==typeof e.code&&e.code.startsWith("P")}isDuplicateError(e){return this.isPrismaError(e)&&"P2002"===e.code}getPaginationParams(e=1,r=10){return{skip:(e-1)*r,take:r}}getCurrentTimestamp(){return Math.floor(Date.now()/1e3)}}class UserRepository extends BaseRepository{async findById(e){try{return await this.db.user.findUnique({where:{id:e}})}catch(e){this.handleError(e,"")}}async findByEmail(e){try{return await this.db.user.findUnique({where:{email:e}})}catch(e){this.handleError(e,"")}}async findByUsername(e){try{return await this.db.user.findUnique({where:{username:e}})}catch(e){this.handleError(e,"")}}async create(e){try{const r={...e};return"password"in r&&(r.passwordHash=r.password,delete r.password),await this.db.user.create({data:{...r,createdAt:this.getCurrentTimestamp(),updatedAt:this.getCurrentTimestamp()}})}catch(e){if(this.isDuplicateError(e))throw new i("CONFLICT",{message:""});this.handleError(e,"")}}async update(e,r){try{return await this.db.user.update({where:{id:e},data:{...r,updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async delete(e){try{await this.db.user.delete({where:{id:e}})}catch(e){this.handleError(e,"")}}async verifyEmail(e){try{return await this.db.user.update({where:{id:e},data:{emailVerified:!0,updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async updatePassword(e,r){try{return await this.db.user.update({where:{id:e},data:{passwordHash:r,updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async updateLastLogin(e){try{await this.db.user.update({where:{id:e},data:{updatedAt:this.getCurrentTimestamp()}})}catch(e){console.error("Failed to update last login time:",e)}}isDuplicateError(e){return null!==e&&"object"==typeof e&&"code"in e&&"P2002"===e.code}}class EmailServiceError extends Error{constructor(e){super(e),this.name="EmailServiceError"}}async function hashPassword(e){const r=new TextEncoder,n=crypto.getRandomValues(new Uint8Array(16)),i=await crypto.subtle.importKey("raw",r.encode(e),{name:"PBKDF2"},!1,["deriveBits"]),a=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},i,256),o=new Uint8Array(a),s=new Uint8Array(n.length+o.length);return s.set(n),s.set(o,n.length),btoa(String.fromCharCode(...s))}async function verifyPassword(e,r){try{const n=new TextEncoder,i=new Uint8Array(atob(r).split("").map(e=>e.charCodeAt(0))),a=i.slice(0,16),o=i.slice(16),s=await crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveBits"]),u=await crypto.subtle.deriveBits({name:"PBKDF2",salt:a,iterations:1e5,hash:"SHA-256"},s,256),d=new Uint8Array(u);if(o.length!==d.length)return!1;for(let e=0;e<o.length;e++)if(o[e]!==d[e])return!1;return!0}catch{return!1}}function generateId(){return crypto.randomUUID()}const jr=Object.freeze(Object.defineProperty({__proto__:null,generateId:generateId,hashPassword:hashPassword,verifyPassword:verifyPassword},Symbol.toStringTag,{value:"Module"}));const Nr={ja:{common:{loading:"...",save:"",cancel:"",delete:"",edit:"",create:"",update:"",search:"",back:"",next:"",previous:"",confirm:"",yes:"",no:"",or:"",and:"",all:"",none:"",select:"",close:"",open:"",download:"",upload:"",share:"",copy:"",copied:"",error:"",success:"",warning:"",info:"",required:"",optional:"",providers:{google:"Google",github:"GitHub"}},nav:{home:"",rules:"",myRules:"",myOrganizations:"",quickAccess:"",organizations:"",profile:"",settings:"",logout:"",login:"",register:"",guides:""},auth:{login:{title:"",subtitle:"",email:"",password:"",rememberMe:"",forgotPassword:"",loginButton:"",loggingIn:"...",loginWith:"{provider}",errors:{invalidCredentials:"",emailNotVerified:"",generalError:""},validation:{emailRequired:"",emailInvalid:"",passwordRequired:""}},register:{title:"",subtitle:"",username:"",usernameHint:"",email:"",password:"",passwordHint:"8",confirmPassword:"",passwordStrength:{weak:"",fair:"",good:"",strong:""},agreeToTerms:"",and:"",privacyPolicy:"",agreeToTermsText:"",registerButton:"",registering:"...",registerWith:"{provider}",accountCreated:"",accountCreatedShort:"",errors:{emailExists:"",usernameExists:"",generalError:""},validation:{usernameRequired:"",usernameLength:"320",usernamePattern:"",emailRequired:"",emailInvalid:"",passwordRequired:"",passwordLength:"8",passwordMismatch:"",termsRequired:""},pageTitle:" - ZXCV"},forgotPassword:{title:"",subtitle:"",email:"",sendButton:"",sending:"...",backToLogin:"",success:"",emailSent:"",emailSentMessage:"",error:"",pageTitle:" - zxcv"},verifyEmail:{title:"",verifying:"...",success:"",successMessage:"",successDescription:"",error:"",errorMessage:"",invalidToken:"",invalidTokenDescription:"",goToLogin:"",resendEmail:"",resending:"...",noToken:"",noTokenMessage:"",noTokenDescription:"",enterEmail:":",emailResent:"",resendError:"",generalError:"",pageTitle:" - zxcv",register:""}},home:{hero:{badge:"AI",title:"",titleHighlight:"",description:"AI",viewRules:"",getStarted:""},features:{title:"FEATURES",subtitle:"",description:"",versionControl:{title:"",description:""},organizationCollaboration:{title:"",description:""},aiOptimized:{title:"AI",description:"AI"}},cta:{title:"",description:"",button:""}},rules:{title:"",myRules:"",publicRules:"",organizationRules:"",createRule:"",searchPlaceholder:"...",visibility:{public:"",private:"",organization:""},actions:{view:"",edit:"",delete:"",share:"",duplicate:"",download:"",version:""},form:{name:"",description:"",content:"",tags:"",visibility:"",team:""},messages:{created:"",updated:"",deleted:"",deleteConfirm:"",deleteError:""}},profile:{title:"",editProfile:"",username:"",email:"",bio:"",website:"",joined:"",backToHome:"",emailVerified:"",emailNotVerified:"",createdRules:"",belongingOrganizations:"",registrationDate:"",recentActivity:"",noActivityYet:"",changeAvatar:"",avatarChangeComingSoon:"",usernameHint:"",emailChangeWarning:"",changePassword:"",currentPassword:"",newPassword:"",newPasswordConfirm:"",passwordHint:"8",update:"",change:"",placeholders:{username:"username",email:"email@example.com",currentPassword:"",newPassword:"",newPasswordConfirm:""},errors:{noUsername:"",loadFailed:"",usernameRequired:"",usernameInvalid:"",usernameMinLength:"3",emailRequired:"",emailInvalid:"",passwordMinLength:"8",passwordMismatch:"",usernameOrEmailTaken:"",updateFailed:"",wrongCurrentPassword:"",passwordChangeFailed:""},success:{profileUpdated:"",passwordChanged:""},stats:{rules:"",organizations:"",contributions:""}},settings:{title:"",account:"",security:"",notifications:"",preferences:"",language:"",theme:"",changePassword:"",twoFactor:"",apiKeys:"API",deleteAccount:""},errors:{notFound:"",unauthorized:"",forbidden:"",serverError:"",networkError:"",unknownError:"",oauth:{authFailed:"OAuth",missingParams:"",invalidCode:"",invalidState:"state",accessDenied:"",invalidRequest:"",unauthorizedClient:"",unsupportedResponseType:"",invalidScope:"",serverError:"",temporarilyUnavailable:"",registrationFailed:"{provider}"}},footer:{copyright:" 2025 zxcv. All rights reserved.",about:"zxcv",terms:"",privacy:"",contact:"",tagline:"AI",product:"",features:"",pricing:"",enterprise:"",changelog:"",resources:"",docs:"",api:"API",blog:"",company:"",aboutUs:"",careers:"",partners:"",security:""},organizations:{title:"",subtitle:"",myOrganizations:"",createOrganization:"",joinOrganization:"",members:"",rules:"",owner:"",admin:"",member:"",noOrganizations:"",createFirstOrganization:"",noDescription:"",actions:{invite:"",leave:"",remove:"",edit:"",manageMembers:""},form:{name:"",namePlaceholder:": example-company",description:"",descriptionPlaceholder:"",inviteEmail:"",inviteMembers:"",addMember:""},validation:{nameRequired:"",nameFormat:"",invalidEmail:""},messages:{created:"",joined:"",left:"",invited:"",inviteAccepted:"",createError:"",fetchError:""},pageTitle:" - zxcv",newOrganizationTitle:" - zxcv",createNewOrganization:"",inviteAndCollaborate:"",join:{verifying:"...",failed:"",backToOrganizations:"",joined:"",welcome:"",goToOrganization:"",loginRequired:"",loginToJoinOrganization:"",login:"",noToken:"",invalidToken:""},detail:{settings:"",leaveOrganization:"",members:"",rules:"",createdAt:"",noRules:"",inviteMembers:"",notFound:"",backToList:"",removeMember:"",confirmRemoveMember:"{{username}}",memberRemoved:"{{username}}",removeMemberError:""},inviteMember:{title:"",usernameLabel:"",usernamePlaceholder:"...",invite:"",success:"{{username}}",error:"",alreadyMember:"",alreadyInvited:""}},test:{orpc:{title:"oRPC ",healthCheck:"",ruleCreate:""}},accessibility:{changeLanguage:"",socialLinks:{twitter:"Twitter",github:"GitHub",discord:"Discord"}},placeholders:{username:"johndoe",email:"john@example.com"},email:{subjects:{passwordReset:"zxcv",emailVerification:"zxcv",organizationInvite:"zxcv{organizationName}"}}},en:{common:{loading:"Loading...",save:"Save",cancel:"Cancel",delete:"Delete",edit:"Edit",create:"Create",update:"Update",search:"Search",back:"Back",next:"Next",previous:"Previous",confirm:"Confirm",yes:"Yes",no:"No",or:"or",and:"and",all:"All",none:"None",select:"Select",close:"Close",open:"Open",download:"Download",upload:"Upload",share:"Share",copy:"Copy",copied:"Copied",error:"Error",success:"Success",warning:"Warning",info:"Info",required:"Required",optional:"Optional",providers:{google:"Google",github:"GitHub"}},nav:{home:"Home",rules:"Rules",myRules:"My Rules",myOrganizations:"My Organizations",quickAccess:"Quick Access",organizations:"Organizations",profile:"Profile",settings:"Settings",logout:"Logout",login:"Login",register:"Sign up",guides:"Guides"},auth:{login:{title:"Sign in to your account",subtitle:"Don't have an account?",email:"Email address",password:"Password",rememberMe:"Remember me",forgotPassword:"Forgot your password?",loginButton:"Sign in",loggingIn:"Signing in...",loginWith:"Sign in with {provider}",errors:{invalidCredentials:"Invalid email or password",emailNotVerified:"Please verify your email address before signing in.",generalError:"Failed to sign in"},validation:{emailRequired:"Please enter your email address",emailInvalid:"Please enter a valid email address",passwordRequired:"Please enter your password"}},register:{title:"Create an account",subtitle:"Already have an account?",username:"Username",usernameHint:"Letters, numbers, underscores, and hyphens only",email:"Email address",password:"Password",passwordHint:"At least 8 characters",confirmPassword:"Confirm password",passwordStrength:{weak:"Weak",fair:"Fair",good:"Good",strong:"Strong"},agreeToTerms:"I agree to the",and:"and",privacyPolicy:"Privacy Policy",agreeToTermsText:"Terms of Service",registerButton:"Create account",registering:"Creating account...",registerWith:"Sign up with {provider}",accountCreated:"Account created! Please check your email to verify your account.",accountCreatedShort:"Account created successfully",errors:{emailExists:"This email address is already in use",usernameExists:"This username is already taken",generalError:"Failed to create account"},validation:{usernameRequired:"Please enter a username",usernameLength:"Username must be between 3 and 20 characters",usernamePattern:"Username can only contain letters, numbers, and underscores",emailRequired:"Please enter your email address",emailInvalid:"Please enter a valid email address",passwordRequired:"Please enter a password",passwordLength:"Password must be at least 8 characters long",passwordMismatch:"Passwords do not match",termsRequired:"Please agree to the terms and conditions"},pageTitle:"Create Account - ZXCV"},forgotPassword:{title:"Reset password",subtitle:"Enter your registered email address",email:"Email address",sendButton:"Send reset link",sending:"Sending...",backToLogin:"Back to login",success:"Password reset email sent",emailSent:"Email sent",emailSentMessage:"If an account exists with this email address, we've sent password reset instructions.",error:"Failed to send email. Please try again.",pageTitle:"Reset Password - zxcv"},verifyEmail:{title:"Verify email address",verifying:"Verifying your account...",success:"Verification complete",successMessage:"Email address verified successfully.",successDescription:"You can now access your account from the login page.",error:"Verification error",errorMessage:"Failed to verify email address.",invalidToken:"Invalid or expired verification token.",invalidTokenDescription:"The verification token is invalid or expired. Please request a new verification email.",goToLogin:"Go to login",resendEmail:"Resend verification email",resending:"Sending...",noToken:"No verification token",noTokenMessage:"Email verification requires a token.",noTokenDescription:"Please click the link in the email sent during registration.",enterEmail:"Please enter your email address:",emailResent:"Verification email sent. Please check your email.",resendError:"Failed to send verification email.",generalError:"An error occurred.",pageTitle:"Verify Email - zxcv",register:"Sign up"}},home:{hero:{badge:"The new standard for AI coding rule management",title:"Share, manage, and utilize",titleHighlight:"coding rules",description:"Unify coding standards across your organization. Maximize development efficiency with AI-optimized rule management.",viewRules:"View rules",getStarted:"Get started free"},features:{title:"FEATURES",subtitle:"All the features you need for organization development",description:"Providing features to improve development speed while maintaining code quality",versionControl:{title:"Version Control",description:"Automatically record rule change history. Revert to previous versions anytime."},organizationCollaboration:{title:"Organization Collaboration",description:"Easy sharing with organization members. Manage rules safely with permission control."},aiOptimized:{title:"AI Optimized",description:"Output rules in formats optimized for AI development tools. Improve development efficiency."}},cta:{title:"Get started today",description:"Create a free account and start managing your organization's coding rules",button:"Get started free"}},rules:{title:"Rules",myRules:"My Rules",publicRules:"Public Rules",organizationRules:"Organization Rules",createRule:"Create new rule",searchPlaceholder:"Search rules...",visibility:{public:"Public",private:"Private",organization:"Organization only"},actions:{view:"View",edit:"Edit",delete:"Delete",share:"Share",duplicate:"Duplicate",download:"Download",version:"Version"},form:{name:"Rule name",description:"Description",content:"Content",tags:"Tags",visibility:"Visibility",organization:"Organization"},messages:{created:"Rule created successfully",updated:"Rule updated successfully",deleted:"Rule deleted successfully",deleteConfirm:"Are you sure you want to delete this rule?",deleteError:"Failed to delete rule"}},organizations:{title:"Organizations",subtitle:"Create organizations and share rules with members",myOrganizations:"My Organizations",createOrganization:"New Organization",joinOrganization:"Join organization",members:"Members",rules:"Rules",owner:"Owner",admin:"Admin",member:"Member",noOrganizations:"No organizations yet",createFirstOrganization:"Create your first organization and start collaborating with members",noDescription:"No organization description",actions:{invite:"Invite",leave:"Leave",remove:"Remove",edit:"Edit",manageMembers:"Manage members"},form:{name:"Organization name",namePlaceholder:"e.g. example-company",description:"Description",descriptionPlaceholder:"Describe your organization's purpose and activities",inviteEmail:"Email address to invite",inviteMembers:"Invite initial members (optional)",addMember:"Add member"},validation:{nameRequired:"Organization name is required",nameFormat:"Organization name can only contain alphanumeric characters and hyphens",invalidEmail:"Please enter a valid email address"},messages:{created:"Organization created successfully",joined:"Joined organization successfully",left:"Left organization successfully",invited:"Invitation sent successfully",inviteAccepted:"Invitation accepted",createError:"Failed to create organization",fetchError:"Failed to fetch organizations"},pageTitle:"Organizations - zxcv",newOrganizationTitle:"Create New Organization - zxcv",createNewOrganization:"Create a new organization",inviteAndCollaborate:"Create a organization and invite members",join:{verifying:"Verifying invitation...",failed:"Failed to verify invitation",backToOrganizations:"Back to organizations",joined:"Joined organization successfully!",welcome:"Welcome to the organization",goToOrganization:"Go to organization page",loginRequired:"Login required",loginToJoin:"Please login to join the organization",login:"Login",noToken:"Invitation token not found",invalidToken:"Invalid invitation token"},detail:{settings:"Settings",leaveOrganization:"Leave organization",members:"Members",rules:"Rules",createdAt:"Created",noRules:"No rules yet",inviteMembers:"Invite members",notFound:"Organization not found",backToList:"Back to organizations",removeMember:"Remove member",confirmRemoveMember:"Are you sure you want to remove {{username}} from the organization?",memberRemoved:"{{username}} has been removed from the organization",removeMemberError:"Failed to remove member"},inviteMember:{title:"Invite Member",usernameLabel:"Username",usernamePlaceholder:"Enter username...",invite:"Send Invitation",success:"Invitation sent to {{username}}",error:"Failed to send invitation",alreadyMember:"This user is already a member",alreadyInvited:"An invitation has already been sent to this user"}},profile:{title:"Profile",editProfile:"Edit profile",username:"Username",email:"Email address",bio:"Bio",website:"Website",joined:"Joined",backToHome:"Back to Home",emailVerified:"Email verified",emailNotVerified:"Email not verified",createdRules:"Created Rules",belongingOrganizations:"Organizations",registrationDate:"Registration Date",recentActivity:"Recent Activity",noActivityYet:"No activity yet",changeAvatar:"Change avatar",avatarChangeComingSoon:"Avatar image change coming soon",usernameHint:"Letters, numbers, hyphens, and underscores only",emailChangeWarning:"Changing your email address will require re-verification",changePassword:"Change password",currentPassword:"Current password",newPassword:"New password",newPasswordConfirm:"New password (confirm)",passwordHint:"At least 8 characters",update:"Update",change:"Change",placeholders:{username:"username",email:"email@example.com",currentPassword:"Enter current password",newPassword:"Enter new password",newPasswordConfirm:"Re-enter new password"},errors:{noUsername:"Username not specified",loadFailed:"Failed to load profile",usernameRequired:"Username is required",usernameInvalid:"Only letters, numbers, hyphens, and underscores allowed",usernameMinLength:"Must be at least 3 characters",emailRequired:"Email address is required",emailInvalid:"Please enter a valid email address",passwordMinLength:"Password must be at least 8 characters",passwordMismatch:"Passwords do not match",usernameOrEmailTaken:"That username or email address is already taken",updateFailed:"Failed to update profile",wrongCurrentPassword:"Current password is incorrect",passwordChangeFailed:"Failed to change password"},success:{profileUpdated:"Profile updated successfully",passwordChanged:"Password changed successfully"},stats:{rules:"Rules",organizations:"Organizations",contributions:"Contributions"}},settings:{title:"Settings",account:"Account",security:"Security",notifications:"Notifications",preferences:"Preferences",language:"Language",theme:"Theme",changePassword:"Change password",twoFactor:"Two-factor authentication",apiKeys:"API Keys",deleteAccount:"Delete account"},errors:{notFound:"Page not found",unauthorized:"Authentication required",forbidden:"Access denied",serverError:"Server error occurred",networkError:"Network error occurred",unknownError:"An error occurred",oauth:{authFailed:"OAuth authentication failed",missingParams:"Required parameters are missing",invalidCode:"Invalid authentication code",invalidState:"Invalid state parameter",accessDenied:"User denied access",invalidRequest:"Invalid request",unauthorizedClient:"Unauthorized client",unsupportedResponseType:"Unsupported response type",invalidScope:"Invalid scope",serverError:"Authentication server error",temporarilyUnavailable:"Temporarily unavailable",registrationFailed:"Failed to create account with {provider}"}},footer:{copyright:" 2025 zxcv. All rights reserved.",about:"About zxcv",terms:"Terms of Service",privacy:"Privacy Policy",contact:"Contact",tagline:"Platform for sharing, managing, and utilizing AI coding rules",product:"Product",features:"Features",pricing:"Pricing",enterprise:"Enterprise",changelog:"Changelog",resources:"Resources",docs:"Documentation",api:"API",blog:"Blog",company:"Company",aboutUs:"About Us",careers:"Careers",partners:"Partners",security:"Security"},test:{orpc:{title:"oRPC Test Page",healthCheck:"Test Health Check",ruleCreate:"Test Rule Create (requires auth)"}},accessibility:{changeLanguage:"Change language",socialLinks:{twitter:"Twitter",github:"GitHub",discord:"Discord"}},placeholders:{username:"johndoe",email:"john@example.com"},email:{subjects:{passwordReset:"zxcv - Password Reset",emailVerification:"zxcv - Email Verification",organizationInvite:"zxcv - Invitation to {organizationName}"}}}};function t(e,r="ja",n){const i=e.split(".");let a=Nr[r];for(const r of i){if(!a||"object"!=typeof a||!(r in a))return e;a=a[r]}return"string"!=typeof a?e:n?a.replace(/\{(\w+)\}/g,(e,r)=>{var i;return(null==(i=n[r])?void 0:i.toString())||e}):a}const Dr={userExists:e=>t("auth.register.errors.emailExists",e),usernameExists:e=>t("auth.register.errors.usernameExists",e),usernameNotAvailable:e=>"ja"===e?"":"Username is already taken",invalidCredentials:e=>t("auth.login.errors.invalidCredentials",e),emailNotVerified:e=>t("auth.login.errors.emailNotVerified",e),generalError:e=>t("auth.login.errors.generalError",e),registrationFailed:e=>t("auth.register.errors.generalError",e),registrationFailedEmail:e=>"ja"===e?"":"Registration failed to send verification email. Please contact support if you do not receive it.",registrationSuccess:e=>"ja"===e?"":"Registration successful. Please check your email to verify your account.",loginFailed:e=>"ja"===e?"":"Login failed",rateLimit:(e,r)=>"ja"===e?r?`${r}`:"":r?`Rate limit exceeded. Please try again in ${r} seconds.`:"Too many requests. Please try again later.",invalidToken:e=>"ja"===e?"":"Invalid or expired token",invalidState:e=>"ja"===e?"":"Invalid or expired state",oauthFailed:(e,r)=>"ja"===e?`${r}`:`${r} authentication failed`,userNotFound:e=>"ja"===e?"":"User not found",emailVerificationSuccess:e=>"ja"===e?"":"Email verified successfully. You can now log in.",passwordResetEmailSent:e=>"ja"===e?"":"If an account exists with this email, a password reset link has been sent.",passwordResetSuccess:e=>"ja"===e?"":"Password reset successfully",logoutSuccess:e=>"ja"===e?"":"Successfully logged out",logoutFailed:e=>"ja"===e?"":"Logout failed",authRequired:e=>"ja"===e?"":"Authentication required",emailVerificationRequired:e=>"ja"===e?"":"Email verification required",internalServerError:e=>"ja"===e?"":"Internal server error",emailResendSuccess:e=>"ja"===e?"":"If this email address exists and is not already verified, a verification email has been sent.",emailResendFailed:e=>"ja"===e?"":"Failed to send verification email. Please try again.",oauthNoEmail:(e,r)=>"ja"===e?`${r}`:`No email address found in ${r} account`,oauthAuthFailed:(e,r)=>"ja"===e?`OAuth: ${r}`:`OAuth authentication failed: ${r}`,tooManyOAuthAttempts:e=>"ja"===e?"OAuth":"Too many OAuth authentication attempts. Please try again later.",emailAlreadyInUse:e=>"ja"===e?"":"Email already in use",usernameAlreadyInUse:e=>"ja"===e?"":"Username already in use",currentPasswordRequired:e=>"ja"===e?"":"Current password is required",invalidCurrentPassword:e=>"ja"===e?"":"Invalid current password",invalidConfirmation:e=>"ja"===e?"":"Invalid confirmation",invalidPassword:e=>"ja"===e?"":"Invalid password",passwordChangeNotAvailable:e=>"ja"===e?"OAuth":"Password change not available for OAuth accounts",transferOwnershipRequired:e=>"ja"===e?"":"You must transfer ownership of your organizations before deleting your account",useOAuthProviderToDelete:e=>"ja"===e?"OAuth":"Please use your OAuth provider to delete your account",accountDeletedSuccess:e=>"ja"===e?"":"Account deleted successfully",settingsUpdatedSuccess:e=>"ja"===e?"":"Settings updated successfully",passwordChangedSuccess:e=>"ja"===e?"":"Password changed successfully"};var Ur=Object.defineProperty,__publicField$3=(e,r,n)=>((e,r,n)=>r in e?Ur(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);async function sendEmail(e,r,n,i){const a=new EmailService(e);return await a.sendEmail({to:r,subject:n,html:i,text:i.replace(/<[^>]*>/g,"")})}class EmailService{constructor(e){__publicField$3(this,"fromEmail"),__publicField$3(this,"baseUrl"),__publicField$3(this,"env"),__publicField$3(this,"logger"),this.fromEmail=e.EMAIL_FROM||"noreply@prism-project.net",this.baseUrl=e.APP_URL||e.FRONTEND_URL||"https://zxcv.dev",this.env=e,this.logger=createLogger()}async sendEmail(e){try{if(this.isTestEnvironment())return console.log(`[TEST] Email would be sent to: ${e.to}`),console.log(`[TEST] Subject: ${e.subject}`),console.log(`[DEV] Text content: ${e.text}`),!0;if(!this.env.EMAIL_SENDER)return console.error("EMAIL_SENDER binding is not configured"),console.log(`[DEV] Email would be sent to: ${e.to}`),console.log(`[DEV] Subject: ${e.subject}`),console.log(`[DEV] Text content: ${e.text}`),!1;const{createMimeMessage:r}=await import("./mimetext.node.es.mjs"),n=r();n.setSender({name:"zxcv",addr:this.fromEmail}),n.setRecipient(e.to),n.setSubject(e.subject),n.addMessage({contentType:"text/plain",data:e.text}),n.addMessage({contentType:"text/html",data:e.html});const{EmailMessage:i}=await import("cloudflare:email"),a=new i(this.fromEmail,e.to,n.asRaw());return await this.env.EMAIL_SENDER.send(a),!0}catch(e){return console.error("Email sending error:",e),!1}}isTestEnvironment(){return"true"===d.env.VITEST||"test@example.com"===this.fromEmail||"http://localhost:3000"===this.baseUrl}generatePasswordResetEmail(e){const{email:r,resetToken:n,userLocale:i="en"}=e,a=`${this.baseUrl}/reset-password?token=${n}`,o=this.getPasswordResetContent(i,a);return{to:r,subject:o.subject,html:o.html,text:o.text}}generateEmailVerificationEmail(e){const{email:r,verificationToken:n,userLocale:i="en"}=e,a=`${this.baseUrl}/verifyemail?token=${n}`,o=this.getEmailVerificationContent(i,a);return{to:r,subject:o.subject,html:o.html,text:o.text}}generateOrganizationInvitationEmail(e){const{email:r,organizationName:n,inviterName:i,invitationToken:a,userLocale:o="ja"}=e,s=`${this.baseUrl}/organizations/join?token=${a}`,u=this.getOrganizationInvitationContent(o,n,i,s);return{to:r,subject:u.subject,html:u.html,text:u.text}}getPasswordResetContent(e,r){return"ja"===e||"ja-JP"===e?{subject:t("email.subjects.passwordReset","ja"),html:`\n\t\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t\t<p style="color: #666; font-size: 16px;"></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;"></h2>\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t\t<a href="${r}"\n\t\t\t\t\t\t\t   style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<p style="margin: 0; color: #856404;">\n\t\t\t\t\t\t\t\t<strong>:</strong> 1\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t\t<p>URL</p>\n\t\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${r}</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`,text:`\nzxcv - \n\n\n\n\n${r}\n\n: 1\n\n\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t\t`.trim()}:{subject:t("email.subjects.passwordReset","en"),html:`\n\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t<p style="color: #666; font-size: 16px;">Coding Rules Sharing Platform</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;">Password Reset</h2>\n\t\t\t\t\t\t<p>We received a request to reset your password.</p>\n\t\t\t\t\t\t<p>Click the button below to set a new password.</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t<a href="${r}"\n\t\t\t\t\t\t   style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\tReset Password\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t<p style="margin: 0; color: #856404;">\n\t\t\t\t\t\t\t<strong>Note:</strong> This link expires in 1 hour.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t<p>If you didn't request a password reset, please ignore this email.</p>\n\t\t\t\t\t\t<p>If the link doesn't work, copy and paste the following URL into your browser:</p>\n\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${r}</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`,text:`\nzxcv - Password Reset\n\nWe received a request to reset your password.\n\nClick the following link to set a new password:\n${r}\n\nNote: This link expires in 1 hour.\n\nIf you didn't request a password reset, please ignore this email.\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t`.trim()}}getEmailVerificationContent(e,r){return"ja"===e||"ja-JP"===e?{subject:t("email.subjects.emailVerification","ja"),html:`\n\t\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t\t<p style="color: #666; font-size: 16px;"></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;"></h2>\n\t\t\t\t\t\t\t<p>zxcv</p>\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t\t<a href="${r}"\n\t\t\t\t\t\t\t   style="background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<p style="margin: 0; color: #155724;">\n\t\t\t\t\t\t\t\t<strong>:</strong> 24\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t\t<p>URL</p>\n\t\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${r}</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`,text:`\nzxcv - \n\nzxcv\n\n\n${r}\n\n: 24\n\n\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t\t`.trim()}:{subject:t("email.subjects.emailVerification","en"),html:`\n\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t<p style="color: #666; font-size: 16px;">Coding Rules Sharing Platform</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;">Email Verification</h2>\n\t\t\t\t\t\t<p>Thank you for signing up for zxcv!</p>\n\t\t\t\t\t\t<p>To activate your account, please click the button below to verify your email address.</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t<a href="${r}"\n\t\t\t\t\t\t   style="background: #28a745; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\tVerify Email Address\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t<p style="margin: 0; color: #155724;">\n\t\t\t\t\t\t\t<strong>Note:</strong> This link expires in 24 hours.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t<p>If you didn't create this account, please ignore this email.</p>\n\t\t\t\t\t\t<p>If the link doesn't work, copy and paste the following URL into your browser:</p>\n\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${r}</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`,text:`\nzxcv - Email Verification\n\nThank you for signing up for zxcv!\n\nTo activate your account, please click the following link to verify your email address:\n${r}\n\nNote: This link expires in 24 hours.\n\nIf you didn't create this account, please ignore this email.\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t`.trim()}}getOrganizationInvitationContent(e,r,n,i){return"ja"===e||"ja-JP"===e?{subject:t("email.subjects.organizationInvite","ja",{organizationName:r}),html:`\n\t\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t\t<p style="color: #666; font-size: 16px;"></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;"></h2>\n\t\t\t\t\t\t\t<p>${n}${r}</p>\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t\t<a href="${i}"\n\t\t\t\t\t\t\t   style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t\t<p style="margin: 0; color: #856404;">\n\t\t\t\t\t\t\t\t<strong>:</strong> 7\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t\t<p></p>\n\t\t\t\t\t\t\t<p>URL</p>\n\t\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${i}</p>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`,text:`\nzxcv - \n\n${n}${r}\n\n\n${i}\n\n: 7\n\n\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t\t`.trim()}:{subject:t("email.subjects.organizationInvite","en",{organizationName:r}),html:`\n\t\t\t\t<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">\n\t\t\t\t\t<div style="text-align: center; margin-bottom: 30px;">\n\t\t\t\t\t\t<h1 style="color: #333; margin-bottom: 10px;">zxcv</h1>\n\t\t\t\t\t\t<p style="color: #666; font-size: 16px;">Coding Rules Sharing Platform</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">\n\t\t\t\t\t\t<h2 style="color: #333; margin-top: 0;">Organization Invitation</h2>\n\t\t\t\t\t\t<p>${n} has invited you to join the "${r}" organization.</p>\n\t\t\t\t\t\t<p>Click the button below to join the organization.</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin: 30px 0;">\n\t\t\t\t\t\t<a href="${i}"\n\t\t\t\t\t\t   style="background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">\n\t\t\t\t\t\t\tJoin Organization\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">\n\t\t\t\t\t\t<p style="margin: 0; color: #856404;">\n\t\t\t\t\t\t\t<strong>Note:</strong> This link expires in 7 days.\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="color: #666; font-size: 14px; margin-top: 30px;">\n\t\t\t\t\t\t<p>If you didn't expect this invitation, please ignore this email.</p>\n\t\t\t\t\t\t<p>If the link doesn't work, copy and paste the following URL into your browser:</p>\n\t\t\t\t\t\t<p style="word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 3px;">${i}</p>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #888; font-size: 12px;">\n\t\t\t\t\t\t<p> 2025 zxcv. All rights reserved.</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`,text:`\nzxcv - Organization Invitation\n\n${n} has invited you to join the "${r}" organization.\n\nClick the following link to join the organization:\n${i}\n\nNote: This link expires in 7 days.\n\nIf you didn't expect this invitation, please ignore this email.\n\n--\n 2025 zxcv. All rights reserved.\n\t\t\t`.trim()}}}const Mr=new TextEncoder,Lr=new TextDecoder;function concat(...e){const r=e.reduce((e,{length:r})=>e+r,0),n=new Uint8Array(r);let i=0;for(const r of e)n.set(r,i),i+=r.length;return n}function decode(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64("string"==typeof e?e:Lr.decode(e),{alphabet:"base64url"});let r=e;r instanceof Uint8Array&&(r=Lr.decode(r)),r=r.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return function(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);const r=atob(e),n=new Uint8Array(r.length);for(let e=0;e<r.length;e++)n[e]=r.charCodeAt(e);return n}(r)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}function encode(e){let r=e;return"string"==typeof r&&(r=Mr.encode(r)),Uint8Array.prototype.toBase64?r.toBase64({alphabet:"base64url",omitPadding:!0}):function(e){if(Uint8Array.prototype.toBase64)return e.toBase64();const r=[];for(let n=0;n<e.length;n+=32768)r.push(String.fromCharCode.apply(null,e.subarray(n,n+32768)));return btoa(r.join(""))}(r).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}class JOSEError extends Error{static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(e,r){super(e,r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class JWTClaimValidationFailed extends JOSEError{static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(e,r,n="unspecified",i="unspecified"){super(e,{cause:{claim:n,reason:i,payload:r}}),this.claim=n,this.reason=i,this.payload=r}}class JWTExpired extends JOSEError{static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(e,r,n="unspecified",i="unspecified"){super(e,{cause:{claim:n,reason:i,payload:r}}),this.claim=n,this.reason=i,this.payload=r}}class JOSEAlgNotAllowed extends JOSEError{static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"}class JOSENotSupported extends JOSEError{static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"}class JWSInvalid extends JOSEError{static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"}class JWTInvalid extends JOSEError{static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"}class JWSSignatureVerificationFailed extends JOSEError{static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(e="signature verification failed",r){super(e,r)}}function unusable(e,r="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${r} must be ${e}`)}function isAlgorithm(e,r){return e.name===r}function getHashLength(e){return parseInt(e.name.slice(4),10)}function checkSigCryptoKey(e,r,n){switch(r){case"HS256":case"HS384":case"HS512":{if(!isAlgorithm(e.algorithm,"HMAC"))throw unusable("HMAC");const n=parseInt(r.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!isAlgorithm(e.algorithm,"RSASSA-PKCS1-v1_5"))throw unusable("RSASSA-PKCS1-v1_5");const n=parseInt(r.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!isAlgorithm(e.algorithm,"RSA-PSS"))throw unusable("RSA-PSS");const n=parseInt(r.slice(2),10);if(getHashLength(e.algorithm.hash)!==n)throw unusable(`SHA-${n}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":if(!isAlgorithm(e.algorithm,"Ed25519"))throw unusable("Ed25519");break;case"ES256":case"ES384":case"ES512":{if(!isAlgorithm(e.algorithm,"ECDSA"))throw unusable("ECDSA");const n=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(r);if(e.algorithm.namedCurve!==n)throw unusable(n,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}!function(e,r){if(r&&!e.usages.includes(r))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${r}.`)}(e,n)}function message(e,r,...n){if((n=n.filter(Boolean)).length>2){const r=n.pop();e+=`one of type ${n.join(", ")}, or ${r}.`}else 2===n.length?e+=`one of type ${n[0]} or ${n[1]}.`:e+=`of type ${n[0]}.`;return null==r?e+=` Received ${r}`:"function"==typeof r&&r.name?e+=` Received function ${r.name}`:"object"==typeof r&&null!=r&&r.constructor?.name&&(e+=` Received an instance of ${r.constructor.name}`),e}function withAlg(e,r,...n){return message(`Key for the ${e} algorithm must be `,r,...n)}function isCryptoKey(e){return"CryptoKey"===e?.[Symbol.toStringTag]}function isKeyObject(e){return"KeyObject"===e?.[Symbol.toStringTag]}const isKeyLike=e=>isCryptoKey(e)||isKeyObject(e),isDisjoint=(...e)=>{const r=e.filter(Boolean);if(0===r.length||1===r.length)return!0;let n;for(const e of r){const r=Object.keys(e);if(n&&0!==n.size)for(const e of r){if(n.has(e))return!1;n.add(e)}else n=new Set(r)}return!0};const isObject=e=>{if(!function(e){return"object"==typeof e&&null!==e}(e)||"[object Object]"!==Object.prototype.toString.call(e))return!1;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r},checkKeyLength=(e,r)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:n}=r.algorithm;if("number"!=typeof n||n<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};const importJWK=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:r,keyUsages:n}=function(e){let r,n;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},n=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},n=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":r={name:"ECDSA",namedCurve:"P-256"},n=e.d?["sign"]:["verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},n=e.d?["sign"]:["verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":r={name:"ECDH",namedCurve:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"Ed25519":case"EdDSA":r={name:"Ed25519"},n=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":r={name:e.crv},n=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new JOSENotSupported('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:r,keyUsages:n}}(e),i={...e};return delete i.alg,delete i.use,crypto.subtle.importKey("jwk",i,r,e.ext??!e.d,e.key_ops??n)},validateCrit=(e,r,n,i,a)=>{if(void 0!==a.crit&&void 0===i?.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!i||void 0===i.crit)return new Set;if(!Array.isArray(i.crit)||0===i.crit.length||i.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let o;o=void 0!==n?new Map([...Object.entries(n),...r.entries()]):r;for(const r of i.crit){if(!o.has(r))throw new JOSENotSupported(`Extension Header Parameter "${r}" is not recognized`);if(void 0===a[r])throw new e(`Extension Header Parameter "${r}" is missing`);if(o.get(r)&&void 0===i[r])throw new e(`Extension Header Parameter "${r}" MUST be integrity protected`)}return new Set(i.crit)};function isJWK(e){return isObject(e)&&"string"==typeof e.kty}let Vr;const handleJWK=async(e,r,n,i=!1)=>{Vr||=new WeakMap;let a=Vr.get(e);if(a?.[n])return a[n];const o=await importJWK({...r,alg:n});return i&&Object.freeze(e),a?a[n]=o:Vr.set(e,{[n]:o}),o},normalizeKey=async(e,r)=>{if(e instanceof Uint8Array)return e;if(isCryptoKey(e))return e;if(isKeyObject(e)){if("secret"===e.type)return e.export();if("toCryptoKey"in e&&"function"==typeof e.toCryptoKey)try{return((e,r)=>{Vr||=new WeakMap;let n=Vr.get(e);if(n?.[r])return n[r];const i="public"===e.type,a=!!i;let o;if("x25519"===e.asymmetricKeyType){switch(r){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}o=e.toCryptoKey(e.asymmetricKeyType,a,i?[]:["deriveBits"])}if("ed25519"===e.asymmetricKeyType){if("EdDSA"!==r&&"Ed25519"!==r)throw new TypeError("given KeyObject instance cannot be used for this algorithm");o=e.toCryptoKey(e.asymmetricKeyType,a,[i?"verify":"sign"])}if("rsa"===e.asymmetricKeyType){let n;switch(r){case"RSA-OAEP":n="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":n="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":n="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":n="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(r.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:n},a,i?["encrypt"]:["decrypt"]);o=e.toCryptoKey({name:r.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:n},a,[i?"verify":"sign"])}if("ec"===e.asymmetricKeyType){const n=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(e.asymmetricKeyDetails?.namedCurve);if(!n)throw new TypeError("given KeyObject instance cannot be used for this algorithm");"ES256"===r&&"P-256"===n&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:n},a,[i?"verify":"sign"])),"ES384"===r&&"P-384"===n&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:n},a,[i?"verify":"sign"])),"ES512"===r&&"P-521"===n&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:n},a,[i?"verify":"sign"])),r.startsWith("ECDH-ES")&&(o=e.toCryptoKey({name:"ECDH",namedCurve:n},a,i?[]:["deriveBits"]))}if(!o)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return n?n[r]=o:Vr.set(e,{[r]:o}),o})(e,r)}catch(e){if(e instanceof TypeError)throw e}let n=e.export({format:"jwk"});return handleJWK(e,n,r)}if(isJWK(e))return e.k?decode(e.k):handleJWK(e,e,r,!0);throw new Error("unreachable")},tag=e=>e?.[Symbol.toStringTag],jwkMatchesOp=(e,r,n)=>{if(void 0!==r.use){let e;switch(n){case"sign":case"verify":e="sig";break;case"encrypt":case"decrypt":e="enc"}if(r.use!==e)throw new TypeError(`Invalid key for this operation, its "use" must be "${e}" when present`)}if(void 0!==r.alg&&r.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(r.key_ops)){let i;switch(!0){case"sign"===n||"verify"===n:case"dir"===e:case e.includes("CBC-HS"):i=n;break;case e.startsWith("PBES2"):i="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):i=!e.includes("GCM")&&e.endsWith("KW")?"encrypt"===n?"wrapKey":"unwrapKey":n;break;case"encrypt"===n&&e.startsWith("RSA"):i="wrapKey";break;case"decrypt"===n:i=e.startsWith("RSA")?"unwrapKey":"deriveBits"}if(i&&!1===r.key_ops?.includes?.(i))throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${i}" when present`)}return!0},checkKeyType=(e,r,n)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?((e,r,n)=>{if(!(r instanceof Uint8Array)){if(isJWK(r)){if(function(e){return"oct"===e.kty&&"string"==typeof e.k}(r)&&jwkMatchesOp(e,r,n))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!isKeyLike(r))throw new TypeError(withAlg(e,r,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if("secret"!==r.type)throw new TypeError(`${tag(r)} instances for symmetric algorithms must be of type "secret"`)}})(e,r,n):((e,r,n)=>{if(isJWK(r))switch(n){case"decrypt":case"sign":if(function(e){return"oct"!==e.kty&&"string"==typeof e.d}(r)&&jwkMatchesOp(e,r,n))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(function(e){return"oct"!==e.kty&&void 0===e.d}(r)&&jwkMatchesOp(e,r,n))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!isKeyLike(r))throw new TypeError(withAlg(e,r,"CryptoKey","KeyObject","JSON Web Key"));if("secret"===r.type)throw new TypeError(`${tag(r)} instances for asymmetric algorithms must not be of type "secret"`);if("public"===r.type)switch(n){case"sign":throw new TypeError(`${tag(r)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${tag(r)} instances for asymmetric algorithm decryption must be of type "private"`)}if("private"===r.type)switch(n){case"verify":throw new TypeError(`${tag(r)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${tag(r)} instances for asymmetric algorithm encryption must be of type "public"`)}})(e,r,n)},subtleAlgorithm=(e,r)=>{const n=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:n,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:n,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:n,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:n,name:"ECDSA",namedCurve:r.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};default:throw new JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}},getSignKey=async(e,r,n)=>{if(r instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(((e,...r)=>message("Key must be ",e,...r))(r,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",r,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[n])}return checkSigCryptoKey(r,e,n),r};async function flattenedVerify(e,r,n){if(!isObject(e))throw new JWSInvalid("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new JWSInvalid("JWS Protected Header incorrect type");if(void 0===e.payload)throw new JWSInvalid("JWS Payload missing");if("string"!=typeof e.signature)throw new JWSInvalid("JWS Signature missing or incorrect type");if(void 0!==e.header&&!isObject(e.header))throw new JWSInvalid("JWS Unprotected Header incorrect type");let i={};if(e.protected)try{const r=decode(e.protected);i=JSON.parse(Lr.decode(r))}catch{throw new JWSInvalid("JWS Protected Header is invalid")}if(!isDisjoint(i,e.header))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const a={...i,...e.header};let o=!0;if(validateCrit(JWSInvalid,new Map([["b64",!0]]),n?.crit,i,a).has("b64")&&(o=i.b64,"boolean"!=typeof o))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:s}=a;if("string"!=typeof s||!s)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');const u=n&&((e,r)=>{if(void 0!==r&&(!Array.isArray(r)||r.some(e=>"string"!=typeof e)))throw new TypeError(`"${e}" option must be an array of strings`);if(r)return new Set(r)})("algorithms",n.algorithms);if(u&&!u.has(s))throw new JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter value not allowed');if(o){if("string"!=typeof e.payload)throw new JWSInvalid("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let d=!1;"function"==typeof r&&(r=await r(i,e),d=!0),checkKeyType(s,r,"verify");const c=concat(Mr.encode(e.protected??""),Mr.encode("."),"string"==typeof e.payload?Mr.encode(e.payload):e.payload);let l;try{l=decode(e.signature)}catch{throw new JWSInvalid("Failed to base64url decode the signature")}const p=await normalizeKey(r,s),m=await(async(e,r,n,i)=>{const a=await getSignKey(e,r,"verify");checkKeyLength(e,a);const o=subtleAlgorithm(e,a.algorithm);try{return await crypto.subtle.verify(o,a,n,i)}catch{return!1}})(s,p,l,c);if(!m)throw new JWSSignatureVerificationFailed;let h;if(o)try{h=decode(e.payload)}catch{throw new JWSInvalid("Failed to base64url decode the payload")}else h="string"==typeof e.payload?Mr.encode(e.payload):e.payload;const g={payload:h};return void 0!==e.protected&&(g.protectedHeader=i),void 0!==e.header&&(g.unprotectedHeader=e.header),d?{...g,key:p}:g}const epoch=e=>Math.floor(e.getTime()/1e3),Fr=86400,Br=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,secs=e=>{const r=Br.exec(e);if(!r||r[4]&&r[1])throw new TypeError("Invalid time period format");const n=parseFloat(r[2]);let i;switch(r[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":i=Math.round(n);break;case"minute":case"minutes":case"min":case"mins":case"m":i=Math.round(60*n);break;case"hour":case"hours":case"hr":case"hrs":case"h":i=Math.round(3600*n);break;case"day":case"days":case"d":i=Math.round(n*Fr);break;case"week":case"weeks":case"w":i=Math.round(604800*n);break;default:i=Math.round(31557600*n)}return"-"===r[1]||"ago"===r[4]?-i:i};function validateInput(e,r){if(!Number.isFinite(r))throw new TypeError(`Invalid ${e} input`);return r}const normalizeTyp=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`;function validateClaimsSet(e,r,n={}){let i;try{i=JSON.parse(Lr.decode(r))}catch{}if(!isObject(i))throw new JWTInvalid("JWT Claims Set must be a top-level JSON object");const{typ:a}=n;if(a&&("string"!=typeof e.typ||normalizeTyp(e.typ)!==normalizeTyp(a)))throw new JWTClaimValidationFailed('unexpected "typ" JWT header value',i,"typ","check_failed");const{requiredClaims:o=[],issuer:s,subject:u,audience:d,maxTokenAge:c}=n,l=[...o];void 0!==c&&l.push("iat"),void 0!==d&&l.push("aud"),void 0!==u&&l.push("sub"),void 0!==s&&l.push("iss");for(const e of new Set(l.reverse()))if(!(e in i))throw new JWTClaimValidationFailed(`missing required "${e}" claim`,i,e,"missing");if(s&&!(Array.isArray(s)?s:[s]).includes(i.iss))throw new JWTClaimValidationFailed('unexpected "iss" claim value',i,"iss","check_failed");if(u&&i.sub!==u)throw new JWTClaimValidationFailed('unexpected "sub" claim value',i,"sub","check_failed");if(d&&(p=i.aud,m="string"==typeof d?[d]:d,!("string"==typeof p?m.includes(p):Array.isArray(p)&&m.some(Set.prototype.has.bind(new Set(p))))))throw new JWTClaimValidationFailed('unexpected "aud" claim value',i,"aud","check_failed");var p,m;let h;switch(typeof n.clockTolerance){case"string":h=secs(n.clockTolerance);break;case"number":h=n.clockTolerance;break;case"undefined":h=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:g}=n,f=epoch(g||new Date);if((void 0!==i.iat||c)&&"number"!=typeof i.iat)throw new JWTClaimValidationFailed('"iat" claim must be a number',i,"iat","invalid");if(void 0!==i.nbf){if("number"!=typeof i.nbf)throw new JWTClaimValidationFailed('"nbf" claim must be a number',i,"nbf","invalid");if(i.nbf>f+h)throw new JWTClaimValidationFailed('"nbf" claim timestamp check failed',i,"nbf","check_failed")}if(void 0!==i.exp){if("number"!=typeof i.exp)throw new JWTClaimValidationFailed('"exp" claim must be a number',i,"exp","invalid");if(i.exp<=f-h)throw new JWTExpired('"exp" claim timestamp check failed',i,"exp","check_failed")}if(c){const e=f-i.iat;if(e-h>("number"==typeof c?c:secs(c)))throw new JWTExpired('"iat" claim timestamp check failed (too far in the past)',i,"iat","check_failed");if(e<0-h)throw new JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',i,"iat","check_failed")}return i}class JWTClaimsBuilder{#e;constructor(e){if(!isObject(e))throw new TypeError("JWT Claims Set MUST be an object");this.#e=structuredClone(e)}data(){return Mr.encode(JSON.stringify(this.#e))}get iss(){return this.#e.iss}set iss(e){this.#e.iss=e}get sub(){return this.#e.sub}set sub(e){this.#e.sub=e}get aud(){return this.#e.aud}set aud(e){this.#e.aud=e}set jti(e){this.#e.jti=e}set nbf(e){"number"==typeof e?this.#e.nbf=validateInput("setNotBefore",e):e instanceof Date?this.#e.nbf=validateInput("setNotBefore",epoch(e)):this.#e.nbf=epoch(new Date)+secs(e)}set exp(e){"number"==typeof e?this.#e.exp=validateInput("setExpirationTime",e):e instanceof Date?this.#e.exp=validateInput("setExpirationTime",epoch(e)):this.#e.exp=epoch(new Date)+secs(e)}set iat(e){void 0===e?this.#e.iat=epoch(new Date):e instanceof Date?this.#e.iat=validateInput("setIssuedAt",epoch(e)):this.#e.iat=validateInput("setIssuedAt","string"==typeof e?epoch(new Date)+secs(e):e)}}async function jwtVerify(e,r,n){const i=await async function(e,r,n){if(e instanceof Uint8Array&&(e=Lr.decode(e)),"string"!=typeof e)throw new JWSInvalid("Compact JWS must be a string or Uint8Array");const{0:i,1:a,2:o,length:s}=e.split(".");if(3!==s)throw new JWSInvalid("Invalid Compact JWS");const u=await flattenedVerify({payload:a,protected:i,signature:o},r,n),d={payload:u.payload,protectedHeader:u.protectedHeader};return"function"==typeof r?{...d,key:u.key}:d}(e,r,n);if(i.protectedHeader.crit?.includes("b64")&&!1===i.protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");const a={payload:validateClaimsSet(i.protectedHeader,i.payload,n),protectedHeader:i.protectedHeader};return"function"==typeof r?{...a,key:i.key}:a}class FlattenedSign{#e;#t;#r;constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this.#e=e}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#r)throw new TypeError("setUnprotectedHeader can only be called once");return this.#r=e,this}async sign(e,r){if(!this.#t&&!this.#r)throw new JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!isDisjoint(this.#t,this.#r))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...this.#t,...this.#r};let i=!0;if(validateCrit(JWSInvalid,new Map([["b64",!0]]),r?.crit,this.#t,n).has("b64")&&(i=this.#t.b64,"boolean"!=typeof i))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=n;if("string"!=typeof a||!a)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');checkKeyType(a,e,"sign");let o,s=this.#e;i&&(s=Mr.encode(encode(s))),o=this.#t?Mr.encode(encode(JSON.stringify(this.#t))):Mr.encode("");const u=concat(o,Mr.encode("."),s),d=await normalizeKey(e,a),c=await(async(e,r,n)=>{const i=await getSignKey(e,r,"sign");checkKeyLength(e,i);const a=await crypto.subtle.sign(subtleAlgorithm(e,i.algorithm),i,n);return new Uint8Array(a)})(a,d,u),l={signature:encode(c),payload:""};return i&&(l.payload=Lr.decode(s)),this.#r&&(l.header=this.#r),this.#t&&(l.protected=Lr.decode(o)),l}}class CompactSign{#n;constructor(e){this.#n=new FlattenedSign(e)}setProtectedHeader(e){return this.#n.setProtectedHeader(e),this}async sign(e,r){const n=await this.#n.sign(e,r);if(void 0===n.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${n.protected}.${n.payload}.${n.signature}`}}class SignJWT{#t;#i;constructor(e={}){this.#i=new JWTClaimsBuilder(e)}setIssuer(e){return this.#i.iss=e,this}setSubject(e){return this.#i.sub=e,this}setAudience(e){return this.#i.aud=e,this}setJti(e){return this.#i.jti=e,this}setNotBefore(e){return this.#i.nbf=e,this}setExpirationTime(e){return this.#i.exp=e,this}setIssuedAt(e){return this.#i.iat=e,this}setProtectedHeader(e){return this.#t=e,this}async sign(e,r){const n=new CompactSign(this.#i.data());if(n.setProtectedHeader(this.#t),Array.isArray(this.#t?.crit)&&this.#t.crit.includes("b64")&&!1===this.#t.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");return n.sign(e,r)}}async function createJWT(e,r){const n=(new TextEncoder).encode(r.JWT_SECRET);return await new SignJWT(e).setProtectedHeader({alg:r.JWT_ALGORITHM}).setIssuedAt().setExpirationTime(r.JWT_EXPIRES_IN).sign(n)}async function verifyJWT(e,r){try{const n=(new TextEncoder).encode(r.JWT_SECRET),{payload:i}=await jwtVerify(e,n,{algorithms:[r.JWT_ALGORITHM]});return i.sub&&"string"==typeof i.email&&"string"==typeof i.username?{sub:i.sub,email:i.email,username:i.username,emailVerified:i.emailVerified,iat:i.iat,exp:i.exp}:null}catch{return null}}async function createRefreshToken(e,r){const n=(new TextEncoder).encode(r.JWT_SECRET);return await new SignJWT({sub:e,type:"refresh"}).setProtectedHeader({alg:r.JWT_ALGORITHM}).setIssuedAt().setExpirationTime("30d").sign(n)}async function generateToken(e,r,n){const i=(new TextEncoder).encode(r);return await new SignJWT(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(n).sign(i)}async function verifyToken(e,r){const n=(new TextEncoder).encode(r),{payload:i}=await jwtVerify(e,n,{algorithms:["HS256"]});return i}const Wr=Object.freeze(Object.defineProperty({__proto__:null,createJWT:createJWT,createRefreshToken:createRefreshToken,generateToken:generateToken,verifyJWT:verifyJWT,verifyRefreshToken:async function(e,r){try{const n=(new TextEncoder).encode(r.JWT_SECRET),{payload:i}=await jwtVerify(e,n,{algorithms:[r.JWT_ALGORITHM]});return"refresh"!==i.type?null:i.sub}catch{return null}},verifyToken:verifyToken},Symbol.toStringTag,{value:"Module"}));var Jr=Object.defineProperty,__publicField$2=(e,r,n)=>((e,r,n)=>r in e?Jr(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,r+"",n);class AuthService{constructor(e,r){this.db=e,this.env=r,__publicField$2(this,"userRepository"),this.userRepository=new UserRepository(e)}async register(e){if(await this.userRepository.findByEmail(e.email)){const r=e.locale||"ja";throw new i("CONFLICT",{message:Dr.emailAlreadyInUse(r)})}if(await this.userRepository.findByUsername(e.username)){const r=e.locale||"ja";throw new i("CONFLICT",{message:Dr.usernameAlreadyInUse(r)})}const r=await hashPassword(e.password),n=nanoid(),a=await this.userRepository.create({id:n,username:e.username,email:e.email,passwordHash:r,emailVerified:!1}),o=await generateToken({userId:a.id,email:a.email},this.env.JWT_SECRET,"1h");try{await this.sendVerificationEmail(a.email,o,e.locale||"ja")}catch(e){if(e instanceof EmailServiceError)throw e;throw new EmailServiceError("Failed to send verification email")}return{success:!0,message:"Registration successful. Please check your email to verify your account.",user:{id:a.id,username:a.username,email:a.email}}}async login(e,r,n="ja"){const a=await this.userRepository.findByEmail(e);if(!a)throw new i("UNAUTHORIZED",{message:Dr.invalidCredentials(n)});if(!a.passwordHash)throw new i("UNAUTHORIZED",{message:Dr.invalidCredentials(n)});if(!await verifyPassword(r,a.passwordHash))throw new i("UNAUTHORIZED",{message:Dr.invalidCredentials(n)});if(!a.emailVerified)throw new i("FORBIDDEN",{message:Dr.emailNotVerified(n)});await this.userRepository.updateLastLogin(a.id);return{accessToken:await createJWT({sub:a.id,email:a.email,username:a.username,emailVerified:a.emailVerified},this.env),refreshToken:await createRefreshToken(a.id,this.env),user:{id:a.id,username:a.username,email:a.email,emailVerified:a.emailVerified}}}async verifyEmail(e){try{const r=await verifyToken(e,this.env.JWT_SECRET),{userId:n,email:a}=r,o=await this.userRepository.findById(n);if(!o||o.email!==a)throw new i("BAD_REQUEST",{message:""});return o.emailVerified?{message:""}:(await this.userRepository.verifyEmail(n),{message:""})}catch(e){throw new i("BAD_REQUEST",{message:""})}}async requestPasswordReset(e,r="ja"){const n=await this.userRepository.findByEmail(e);if(!n)return{message:""};const i=await generateToken({userId:n.id,email:n.email},this.env.JWT_SECRET,"1h");try{await this.sendPasswordResetEmail(e,i,r)}catch(e){if(e instanceof EmailServiceError)throw e;throw new EmailServiceError("Failed to send password reset email")}return{message:""}}async resetPassword(e,r){try{const n=await verifyToken(e,this.env.JWT_SECRET),{userId:i}=n,a=await hashPassword(r);return await this.userRepository.updatePassword(i,a),{message:""}}catch(e){throw new i("BAD_REQUEST",{message:""})}}async resendVerificationEmail(e,r="ja"){const n=await this.userRepository.findById(e);if(!n)throw new i("NOT_FOUND",{message:""});if(n.emailVerified)throw new i("BAD_REQUEST",{message:""});const a=await generateToken({userId:n.id,email:n.email},this.env.JWT_SECRET,"1h");try{await this.sendVerificationEmail(n.email,a,r)}catch(e){if(e instanceof EmailServiceError)throw e;throw new EmailServiceError("Failed to send verification email")}return{message:""}}async sendVerificationEmail(e,r,n){const i=`${this.env.FRONTEND_URL}/verify-email?token=${r}`,a={ja:{subject:"",body:`\n\t\t\t\t\t<h2></h2>\n\t\t\t\t\t<p>zxcv</p>\n\t\t\t\t\t<p></p>\n\t\t\t\t\t<a href="${i}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"></a>\n\t\t\t\t\t<p>1</p>\n\t\t\t\t\t<p></p>\n\t\t\t\t`},en:{subject:"Verify your email address",body:`\n\t\t\t\t\t<h2>Verify your email address</h2>\n\t\t\t\t\t<p>Thank you for registering with zxcv.</p>\n\t\t\t\t\t<p>Please click the link below to verify your email address:</p>\n\t\t\t\t\t<a href="${i}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Verify Email</a>\n\t\t\t\t\t<p>This link will expire in 1 hour.</p>\n\t\t\t\t\t<p>If you didn't request this, please ignore this email.</p>\n\t\t\t\t`}},o=a[n]||a.ja;await sendEmail(this.env,e,o.subject,o.body)}async sendPasswordResetEmail(e,r,n){const i=`${this.env.FRONTEND_URL}/reset-password?token=${r}`,a={ja:{subject:"",body:`\n\t\t\t\t\t<h2></h2>\n\t\t\t\t\t<p></p>\n\t\t\t\t\t<p></p>\n\t\t\t\t\t<a href="${i}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"></a>\n\t\t\t\t\t<p>1</p>\n\t\t\t\t\t<p></p>\n\t\t\t\t`},en:{subject:"Reset your password",body:`\n\t\t\t\t\t<h2>Reset your password</h2>\n\t\t\t\t\t<p>We received a request to reset your password.</p>\n\t\t\t\t\t<p>Please click the link below to set a new password:</p>\n\t\t\t\t\t<a href="${i}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Reset Password</a>\n\t\t\t\t\t<p>This link will expire in 1 hour.</p>\n\t\t\t\t\t<p>If you didn't request this, please ignore this email.</p>\n\t\t\t\t`}},o=a[n]||a.ja;await sendEmail(this.env,e,o.subject,o.body)}async getUserById(e){return await this.userRepository.findById(e)}async handleOAuthLogin(e,r){const n=await this.db.oAuthAccount.findUnique({where:{provider_providerId:{provider:e,providerId:r.id}},include:{user:!0}});let i;if(n)i=n.user;else{const n=await this.userRepository.findByEmail(r.email);if(n)await this.db.oAuthAccount.create({data:{id:nanoid(),userId:n.id,provider:e,providerId:r.id,email:r.email,username:r.username,createdAt:Math.floor(Date.now()/1e3)}}),i=n;else{let n=(r.username||r.email.split("@")[0]).toLowerCase(),a=0;for(;await this.userRepository.findByUsername(n);)a++,n=`${(r.username||r.email.split("@")[0]).toLowerCase()}${a}`;i=await this.db.user.create({data:{id:nanoid(),email:r.email.toLowerCase(),username:n,passwordHash:null,emailVerified:!0,createdAt:Math.floor(Date.now()/1e3),updatedAt:Math.floor(Date.now()/1e3),oauthAccounts:{create:{id:nanoid(),provider:e,providerId:r.id,email:r.email,username:r.username,createdAt:Math.floor(Date.now()/1e3)}}}})}}await this.userRepository.updateLastLogin(i.id);return{accessToken:await generateToken({sub:i.id,email:i.email,username:i.username,emailVerified:i.emailVerified},this.env.JWT_SECRET,"1h"),refreshToken:await generateToken({sub:i.id,type:"refresh"},this.env.JWT_SECRET,"7d"),user:{id:i.id,username:i.username,email:i.email,emailVerified:i.emailVerified}}}}function getLocaleFromRequest(e){if(!e)return"ja";return function(e){if(!e)return"ja";const r=e.split(",").map(e=>{const[r,n]=e.trim().split(";q=");return{locale:r.toLowerCase(),quality:n?Number.parseFloat(n):1}}).sort((e,r)=>r.quality-e.quality);for(const{locale:e}of r){if(e.startsWith("ja"))return"ja";if(e.startsWith("en"))return"en"}return"ja"}(e.headers.get("Accept-Language"))}const Hr={register:Er.auth.register.use(Or).handler(async({input:e,context:r})=>{const{db:n,env:a,cloudflare:o}=r,s=new AuthService(n,a);getLocaleFromRequest(null==o?void 0:o.request);try{const r=await s.register(e);return{success:!0,message:"",user:{id:r.user.id,username:r.user.username,email:r.user.email}}}catch(e){if(e instanceof EmailServiceError)throw new i("INTERNAL_SERVER_ERROR",{message:""});throw e}}),login:Er.auth.login.use(Pr).handler(async({input:e,context:r})=>{const{db:n,env:i,cloudflare:a}=r,o=new AuthService(n,i),s=getLocaleFromRequest(null==a?void 0:a.request),u=await o.login(e.email,e.password,s);return{accessToken:u.accessToken,refreshToken:u.refreshToken,user:u.user,message:"ja"===s?"":"Login successful"}}),logout:Er.auth.logout.use(xr).handler(async({input:e,context:r})=>{const{refreshToken:n}=e,{env:a,cloudflare:o}=r;getLocaleFromRequest(null==o?void 0:o.request);try{const{verifyRefreshToken:e}=await Promise.resolve().then(function(){return Wr});if(!await e(n,a))throw new i("UNAUTHORIZED",{message:"Invalid token"});return{success:!0,message:"Logged out successfully"}}catch(e){if(e instanceof i)throw e;throw new i("INTERNAL_SERVER_ERROR",{message:"Logout failed"})}}),sendVerification:Er.auth.sendVerification.use(xr).handler(async({input:e,context:r})=>{const{db:n,env:a,cloudflare:o}=r,s=new AuthService(n,a);getLocaleFromRequest(null==o?void 0:o.request);const u=await n.user.findUnique({where:{email:e.email}});if(!u)throw new i("NOT_FOUND",{message:"User not found"});return await s.resendVerificationEmail(u.id,e.locale||"ja"),{success:!0,message:"Verification email sent"}}),verifyEmail:Er.auth.verifyEmail.use(xr).handler(async({input:e,context:r})=>{const{db:n,env:i,cloudflare:a}=r,o=new AuthService(n,i);return getLocaleFromRequest(null==a?void 0:a.request),await o.verifyEmail(e.token),{success:!0,message:"Email verified successfully"}}),sendPasswordReset:Er.auth.sendPasswordReset.use(Cr).handler(async({input:e,context:r})=>{const{db:n,env:i,cloudflare:a}=r,o=new AuthService(n,i),s=getLocaleFromRequest(null==a?void 0:a.request);return await o.requestPasswordReset(e.email,s),{success:!0,message:"Password reset email sent"}}),resetPassword:Er.auth.resetPassword.use(xr).handler(async({input:e,context:r})=>{const{db:n,env:i,cloudflare:a}=r,o=new AuthService(n,i);return getLocaleFromRequest(null==a?void 0:a.request),await o.resetPassword(e.token,e.newPassword),{success:!0,message:"Password reset successfully"}}),refresh:Er.auth.refresh.use(xr).handler(async({input:e,context:r})=>{const{refreshToken:n}=e,{db:a,env:o,cloudflare:s}=r;getLocaleFromRequest(null==s?void 0:s.request);const{verifyRefreshToken:u,createRefreshToken:d,createJWT:c}=await Promise.resolve().then(function(){return Wr}),l=await u(n,o);if(!l)throw new i("UNAUTHORIZED",{message:"Invalid token"});const p=await a.user.findUnique({where:{id:l}});if(!p)throw new i("UNAUTHORIZED",{message:"User not found"});const m={id:p.id,email:p.email,username:p.username,emailVerified:p.emailVerified};return{accessToken:await c({sub:m.id,email:m.email,username:m.username,emailVerified:m.emailVerified},o),refreshToken:await d(m.id,o),user:m}}),oauthInitialize:Er.auth.oauthInitialize.use(Pr).handler(async({input:e,context:r})=>{var n,a,o,u;const{provider:d,redirectUrl:c,action:l}=e,{db:p,env:m,cloudflare:h}=r,g=getLocaleFromRequest(null==h?void 0:h.request),{createOAuthProviders:f,generateState:w,generateCodeVerifier:y}=await import("./oauth.mjs"),b=f(m),{validateRedirectUrl:v,performOAuthSecurityChecks:z,generateNonce:R,OAUTH_CONFIG:I}=await import("./oauthSecurity.mjs"),E=(null==(a=null==(n=null==h?void 0:h.request)?void 0:n.headers)?void 0:a.get("CF-Connecting-IP"))||(null==(u=null==(o=null==h?void 0:h.request)?void 0:o.headers)?void 0:u.get("X-Forwarded-For"))||"unknown";await z(p,E,g);const x={random:w(),action:l,nonce:R()},A=s.from(JSON.stringify(x)).toString("base64url"),S="google"===d?y():void 0,{cleanupExpiredOAuthStates:k}=await import("./oauthCleanup.mjs");await k(p);const{generateId:T}=await Promise.resolve().then(function(){return jr}),P=Math.floor(Date.now()/1e3)+600;let O;if(await p.oAuthState.create({data:{id:T(),state:x.random,provider:d,codeVerifier:S,redirectUrl:c||"/",expiresAt:P,clientIp:E}}),"github"===d){O=b.github.createAuthorizationURL(A,["user:email"]).toString()}else{if("google"!==d)throw new i("BAD_REQUEST",{message:""});if(!S)throw new i("INTERNAL_SERVER_ERROR",{message:""});O=b.google.createAuthorizationURL(A,S,["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile"]).toString()}return{authorizationUrl:O}}),oauthCallback:Er.auth.oauthCallback.use(xr).handler(async({input:e,context:r})=>{var n,a,o,u,d,c;const{provider:l,code:p,state:m}=e,{db:h,env:g,cloudflare:f}=r,w=new AuthService(h,g),y=getLocaleFromRequest(null==f?void 0:f.request),b=createLogger();b.debug("OAuth callback started",{provider:l,code:`${null==p?void 0:p.substring(0,10)}...`,state:m});const{createOAuthProviders:v}=await import("./oauth.mjs"),z=v(g),{validateOAuthResponse:R}=await import("./oauthSecurity.mjs");let I;R({code:p,state:m},y);try{I=JSON.parse(s.from(m,"base64url").toString())}catch(e){throw b.error("Failed to decode state",e),new i("BAD_REQUEST",{message:""})}const E=await h.oAuthState.findUnique({where:{state:I.random}});if(b.debug("State record found",{stateRecord:E}),b.debug("Action from state",{action:I.action}),!E||E.provider!==l||E.expiresAt<Math.floor(Date.now()/1e3))throw b.error("State validation failed",void 0,{stateRecord:E,provider:l,currentTime:Math.floor(Date.now()/1e3)}),new i("BAD_REQUEST",{message:""});if(E.clientIp&&"unknown"!==E.clientIp){const e=(null==(a=null==(n=null==f?void 0:f.request)?void 0:n.headers)?void 0:a.get("CF-Connecting-IP"))||(null==(u=null==(o=null==f?void 0:f.request)?void 0:o.headers)?void 0:u.get("X-Forwarded-For"))||"unknown";E.clientIp!==e&&b.warn("OAuth callback IP mismatch",{stored:E.clientIp,current:e})}await h.oAuthState.delete({where:{id:E.id}});try{let e,r;if("github"===l){b.debug("Validating GitHub authorization code"),e=await z.github.validateAuthorizationCode(p),b.debug("GitHub token obtained");const[n,a]=await Promise.all([fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${e.accessToken()}`,"User-Agent":"zxcv-app"}}),fetch("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${e.accessToken()}`,"User-Agent":"zxcv-app"}})]);if(b.debug("GitHub API responses",{userStatus:n.status,emailStatus:a.status}),!n.ok||!a.ok)throw b.error("GitHub API error",void 0,{userStatus:n.status,userText:await n.text(),emailStatus:a.status,emailText:await a.text()}),new i("INTERNAL_SERVER_ERROR",{message:"GitHub"});const o=await n.json(),s=await a.json(),u=(null==(d=s.find(e=>e.primary))?void 0:d.email)||(null==(c=s[0])?void 0:c.email);if(!u)throw new i("BAD_REQUEST",{message:"GitHub"});r={id:o.id.toString(),email:u,username:o.login}}else{if("google"!==l)throw new i("BAD_REQUEST",{message:""});{if(b.debug("Validating Google authorization code"),!E.codeVerifier)throw new i("BAD_REQUEST",{message:"Code verifier not found for Google OAuth"});e=await z.google.validateAuthorizationCode(p,E.codeVerifier),b.debug("Google token obtained");const n=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e.accessToken()}`}});if(b.debug("Google API response",{status:n.status}),!n.ok)throw b.error("Google API error",void 0,{status:n.status,text:await n.text()}),new i("INTERNAL_SERVER_ERROR",{message:"Google"});const a=await n.json();if(!a.email)throw new i("BAD_REQUEST",{message:"Google"});r={id:a.id,email:a.email,username:a.email.split("@")[0]}}}const n=await w.handleOAuthLogin(l,r);return{accessToken:n.accessToken,refreshToken:n.refreshToken,user:n.user,redirectUrl:E.redirectUrl||"/"}}catch(e){if(b.error("OAuth callback error",e),e instanceof i)throw e;const r=e instanceof Error?e.message:"Unknown error";throw b.error("Detailed error",void 0,{message:r,stack:e instanceof Error?e.stack:void 0,error:e}),new i("INTERNAL_SERVER_ERROR",{message:`OAuth: ${r}`})}})},Zr={check:Er.health.check.handler(async()=>({status:"healthy",timestamp:Date.now()}))};class OrganizationRepository extends BaseRepository{async create(e){try{return await this.db.organization.create({data:{...e,createdAt:this.getCurrentTimestamp(),updatedAt:this.getCurrentTimestamp()}})}catch(e){if(this.isDuplicateError(e))throw new i("CONFLICT",{message:""});this.handleError(e,"")}}async findById(e,r=!1){try{return await this.db.organization.findUnique({where:{id:e},include:r?{members:!0}:void 0})}catch(e){this.handleError(e,"")}}async findByName(e){try{return await this.db.organization.findUnique({where:{name:e}})}catch(e){this.handleError(e,"")}}async findByUserId(e){try{return(await this.db.organizationMember.findMany({where:{userId:e},include:{organization:!0}})).map(e=>({...e.organization,role:e.role}))}catch(e){this.handleError(e,"")}}async addMember(e,r,n="member"){try{return await this.db.organizationMember.create({data:{id:nanoid(),organizationId:e,userId:r,role:n,joinedAt:this.getCurrentTimestamp()}})}catch(e){if(this.isDuplicateError(e))throw new i("CONFLICT",{message:""});this.handleError(e,"")}}async removeMember(e,r){try{await this.db.organizationMember.delete({where:{organizationId_userId:{organizationId:e,userId:r}}})}catch(e){this.handleError(e,"")}}async updateMemberRole(e,r,n){try{return await this.db.organizationMember.update({where:{organizationId_userId:{organizationId:e,userId:r}},data:{role:n}})}catch(e){this.handleError(e,"")}}async update(e,r){try{return await this.db.organization.update({where:{id:e},data:{...r,updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async delete(e){try{await this.db.organizationMember.deleteMany({where:{organizationId:e}}),await this.db.organization.delete({where:{id:e}})}catch(e){this.handleError(e,"")}}async isMember(e,r){try{return null!==await this.db.organizationMember.findUnique({where:{organizationId_userId:{organizationId:e,userId:r}}})}catch(e){this.handleError(e,"")}}async findMember(e,r){try{return await this.db.organizationMember.findUnique({where:{organizationId_userId:{organizationId:e,userId:r}}})}catch(e){this.handleError(e,"Failed to find member")}}async isOwner(e,r){try{const n=await this.db.organizationMember.findUnique({where:{organizationId_userId:{organizationId:e,userId:r}}});return"owner"===(null==n?void 0:n.role)}catch(e){this.handleError(e,"")}}isDuplicateError(e){return null!==e&&"object"==typeof e&&"code"in e&&"P2002"===e.code}}var qr=Object.defineProperty,__publicField$1=(e,r,n)=>((e,r,n)=>r in e?qr(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);class OrganizationService{constructor(e,r){this.env=r,__publicField$1(this,"organizationRepository"),__publicField$1(this,"userRepository"),__publicField$1(this,"db"),this.db=e,this.organizationRepository=new OrganizationRepository(e),this.userRepository=new UserRepository(e)}async createOrganization(e,r){if(!/^[a-z0-9-]+$/.test(r.name))throw new i("BAD_REQUEST",{message:""});const n=await this.organizationRepository.create({id:nanoid(),name:r.name,displayName:r.displayName,description:r.description||null,owner:{connect:{id:e}}});return await this.organizationRepository.addMember(n.id,e,"owner"),n}async getOrganization(e,r){let n=await this.organizationRepository.findById(e,!0);if(n||(n=await this.organizationRepository.findByName(e),n&&(n=await this.organizationRepository.findById(n.id,!0))),!n)throw new i("NOT_FOUND",{message:""});if(n.members&&r){await this.organizationRepository.isMember(n.id,r)||delete n.members}return n}async updateOrganization(e,r,n){if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:""});return await this.organizationRepository.update(e,n)}async deleteOrganization(e,r){if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:""});return await this.organizationRepository.delete(e),{success:!0,message:""}}async inviteMember(e,r,n,a="ja"){if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:""});const o=await this.userRepository.findByEmail(n);if(!o)throw new i("NOT_FOUND",{message:""});if(await this.organizationRepository.isMember(e,o.id))throw new i("CONFLICT",{message:""});const s=await generateToken({orgId:e,userId:o.id,inviterId:r},this.env.JWT_SECRET,"7d"),u=await this.organizationRepository.findById(e);if(!u)throw new i("NOT_FOUND",{message:""});return await this.sendInvitationEmail(n,u.displayName,s,a),{message:""}}async acceptInvitation(e,r){try{const n=await verifyToken(e,this.env.JWT_SECRET);if(r!==n.userId)throw new i("FORBIDDEN",{message:""});await this.organizationRepository.addMember(n.orgId,r,"member");const a=await this.organizationRepository.findById(n.orgId);if(!a)throw new i("NOT_FOUND",{message:""});const o=await this.db.user.findUnique({where:{id:a.ownerId},select:{id:!0,username:!0,email:!0}});if(!o)throw new i("NOT_FOUND",{message:""});return{...a,owner:o}}catch(e){throw new i("BAD_REQUEST",{message:""})}}async removeMember(e,r,n){var a;if(r===n){if(await this.organizationRepository.isOwner(e,r)){const r=await this.organizationRepository.findById(e,!0);if(((null==(a=null==r?void 0:r.members)?void 0:a.filter(e=>"owner"===e.role))||[]).length<=1)throw new i("BAD_REQUEST",{message:""})}}else{if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:""})}return await this.organizationRepository.removeMember(e,n),{message:""}}async updateMemberRole(e,r,n,a){var o;if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:""});if(r===n&&"member"===a){const r=await this.organizationRepository.findById(e,!0);if(((null==(o=null==r?void 0:r.members)?void 0:o.filter(e=>"owner"===e.role))||[]).length<=1)throw new i("BAD_REQUEST",{message:""})}return await this.organizationRepository.updateMemberRole(e,n,a),{message:""}}async getUserOrganizations(e){const r=await this.organizationRepository.findByUserId(e);return await Promise.all(r.map(async e=>{const r=await this.db.organizationMember.count({where:{organizationId:e.id}}),n=await this.db.rule.count({where:{organizationId:e.id}}),a=await this.db.user.findUnique({where:{id:e.ownerId},select:{id:!0,username:!0,email:!0}});if(!a)throw new i("NOT_FOUND",{message:""});return{id:e.id,name:e.name,displayName:e.displayName,owner:a,memberCount:r,ruleCount:n}}))}async sendInvitationEmail(e,r,n,i){const a=`${this.env.FRONTEND_URL}/organizations/accept-invite?token=${n}`,o={ja:{subject:`${r}`,body:`\n\t\t\t\t\t<h2>${r}</h2>\n\t\t\t\t\t<p>${r}</p>\n\t\t\t\t\t<p></p>\n\t\t\t\t\t<a href="${a}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"></a>\n\t\t\t\t\t<p>7</p>\n\t\t\t\t\t<p></p>\n\t\t\t\t`},en:{subject:`Invitation to ${r}`,body:`\n\t\t\t\t\t<h2>Invitation to ${r}</h2>\n\t\t\t\t\t<p>You have been invited to join ${r}.</p>\n\t\t\t\t\t<p>Please click the link below to accept the invitation:</p>\n\t\t\t\t\t<a href="${a}" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Accept Invitation</a>\n\t\t\t\t\t<p>This link will expire in 7 days.</p>\n\t\t\t\t\t<p>If you didn't expect this invitation, please ignore this email.</p>\n\t\t\t\t`}},s=o[i]||o.ja;await sendEmail(this.env,e,s.subject,s.body)}async leaveOrganization(e,r){const n=await this.organizationRepository.findMember(e,r);if(!n)throw new i("NOT_FOUND",{message:"You are not a member of this organization"});if("owner"===n.role)throw new i("FORBIDDEN",{message:"Organization owner cannot leave. Transfer ownership first."});return await this.organizationRepository.removeMember(e,r),{success:!0,message:"Left organization successfully"}}async inviteMemberByUsername(e,r,n){if(!await this.organizationRepository.isOwner(e,r))throw new i("FORBIDDEN",{message:"Only organization owners can invite members"});const a=await this.userRepository.findByUsername(n);if(!a)throw new i("NOT_FOUND",{message:"User not found"});if(await this.organizationRepository.findMember(e,a.id))throw new i("CONFLICT",{message:"User is already a member of this organization"});return await this.inviteMember(e,r,a.email,"ja")}}const Kr={create:Er.organizations.create.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return await o.createOrganization(i.id,{name:e.name,displayName:e.displayName||e.name,description:e.description})}),get:Er.organizations.get.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a),s=await o.getOrganization(e.id,null==i?void 0:i.id),u=await n.user.findUnique({where:{id:s.ownerId},select:{id:!0,username:!0,email:!0}}),d=await n.organizationMember.count({where:{organizationId:s.id}}),c=await n.rule.count({where:{organizationId:s.id}});let l="member";if(null==i?void 0:i.id){const e=await n.organizationMember.findFirst({where:{organizationId:s.id,userId:i.id}});e&&(l=e.role)}return{id:s.id,name:s.name,displayName:s.displayName||s.name,description:s.description,owner:u||{id:"",username:"Unknown",email:""},role:l,memberCount:d,ruleCount:c,createdAt:s.createdAt}}),update:Er.organizations.update.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a),{id:s,...u}=e;return{success:!0,message:"Organization updated successfully",organization:await o.updateOrganization(s,i.id,u)}}),delete:Er.organizations.delete.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return{success:!0,message:(await o.deleteOrganization(e.id,i.id)).message||"Organization deleted successfully"}}),inviteMember:Er.organizations.inviteMember.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return{success:!0,message:(await o.inviteMember(e.organizationId,i.id,e.email,e.locale||"ja")).message}}),acceptInvitation:Er.organizations.acceptInvitation.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return{success:!0,message:"Invitation accepted successfully",organization:await o.acceptInvitation(e.token,i.id)}}),removeMember:Er.organizations.removeMember.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return{success:!0,message:(await o.removeMember(e.organizationId,i.id,e.userId)).message}}),updateMemberRole:Er.organizations.updateMemberRole.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return{success:!0,message:(await o.updateMemberRole(e.orgId,i.id,e.memberId,e.role)).message}}),list:Er.organizations.list.use(_r).handler(async({context:e})=>{const{db:r,user:n,env:i}=e,a=new OrganizationService(r,i);return await a.getUserOrganizations(n.id)}),listMembers:Er.organizations.listMembers.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.organizationMember.findFirst({where:{organizationId:e.orgId,userId:a.id}}))throw new i("FORBIDDEN",{message:""});return{members:(await n.organizationMember.findMany({where:{organizationId:e.orgId},include:{user:{select:{id:!0,username:!0,email:!0}}},orderBy:[{role:"asc"},{joinedAt:"asc"}]})).map(e=>({id:e.user.id,username:e.user.username,email:e.user.email,role:e.role,joinedAt:e.joinedAt}))}}),listRules:Er.organizations.listRules.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.organizationMember.findFirst({where:{organizationId:e.orgId,userId:a.id}}))throw new i("FORBIDDEN",{message:""});const o=(e.page-1)*e.pageSize,[s,u]=await Promise.all([n.rule.findMany({where:{organizationId:e.orgId},include:{user:{select:{id:!0,username:!0}}},orderBy:{updatedAt:"desc"},skip:o,take:e.pageSize}),n.rule.count({where:{organizationId:e.orgId}})]);return{rules:s.map(e=>({id:e.id,name:e.name,description:e.description,visibility:e.visibility,isPublished:null!==e.publishedAt,downloadCount:e.downloads,starCount:e.stars,createdAt:e.createdAt,updatedAt:e.updatedAt,user:e.user,latestVersion:e.version||"1.0.0"})),total:u,page:e.page,pageSize:e.pageSize,totalPages:Math.ceil(u/e.pageSize)}}),members:Er.organizations.members.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.organizationMember.findFirst({where:{organizationId:e.organizationId,userId:a.id}}))throw new i("FORBIDDEN",{message:""});return(await n.organizationMember.findMany({where:{organizationId:e.organizationId},include:{user:{select:{id:!0,username:!0,email:!0}}}})).map(e=>({id:e.user.id,username:e.user.username,email:e.user.email,role:e.role,joinedAt:e.joinedAt}))}),rules:Er.organizations.rules.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.organizationMember.findFirst({where:{organizationId:e.organizationId,userId:a.id}}))throw new i("FORBIDDEN",{message:""});return(await n.rule.findMany({where:{organizationId:e.organizationId},select:{id:!0,name:!0,description:!0,version:!0,updatedAt:!0,user:{select:{id:!0,username:!0}}},orderBy:{updatedAt:"desc"}})).map(e=>({id:e.id,name:e.name,description:e.description,version:e.version||"1.0.0",updatedAt:e.updatedAt,author:e.user}))}),leave:Er.organizations.leave.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new OrganizationService(n,a);return await o.leaveOrganization(e.organizationId,i.id)})};class RuleRepository extends BaseRepository{async create(e){try{return await this.db.rule.create({data:{...e,createdAt:this.getCurrentTimestamp(),updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async findById(e,r=!1){try{return await this.db.rule.findUnique({where:{id:e},include:r?{user:{select:{id:!0,username:!0,email:!0}},organization:{select:{id:!0,name:!0,displayName:!0}}}:void 0})}catch(e){this.handleError(e,"")}}async findByName(e,r){try{return await this.db.rule.findFirst({where:{name:e,...r?{organizationId:r}:{}},include:{user:{select:{id:!0,username:!0,email:!0}},organization:{select:{id:!0,name:!0,displayName:!0}}}})}catch(e){this.handleError(e,"")}}async findByNameAndUserId(e,r){try{return await this.db.rule.findFirst({where:{name:e,userId:r},include:{user:{select:{id:!0,username:!0,email:!0}},organization:{select:{id:!0,name:!0,displayName:!0}}}})}catch(e){this.handleError(e,"")}}async findPublicRules(e=1,r=10,n){try{const i={publishedAt:{not:null},visibility:"public",...n?{OR:[{name:{contains:n}},{description:{contains:n}},{tags:{contains:n}}]}:{}},[a,o]=await Promise.all([this.db.rule.findMany({where:i,include:{user:{select:{id:!0,username:!0,email:!0}},organization:{select:{id:!0,name:!0,displayName:!0}}},orderBy:{updatedAt:"desc"},...this.getPaginationParams(e,r)}),this.db.rule.count({where:i})]);return{rules:a,total:o}}catch(e){this.handleError(e,"")}}async findByCreatorId(e,r=1,n=10){try{const i={userId:e},[a,o]=await Promise.all([this.db.rule.findMany({where:i,include:{organization:{select:{id:!0,name:!0,displayName:!0}}},orderBy:{updatedAt:"desc"},...this.getPaginationParams(r,n)}),this.db.rule.count({where:i})]);return{rules:a,total:o}}catch(e){this.handleError(e,"")}}async update(e,r){try{return await this.db.rule.update({where:{id:e},data:{...r,updatedAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async delete(e){try{await this.db.ruleVersion.deleteMany({where:{ruleId:e}}),await this.db.rule.delete({where:{id:e}})}catch(e){this.handleError(e,"")}}async incrementDownloadCount(e){try{await this.db.rule.update({where:{id:e},data:{downloads:{increment:1},updatedAt:this.getCurrentTimestamp()}})}catch(e){console.error("Failed to increment download count:",e)}}async createVersion(e){try{return await this.db.ruleVersion.create({data:{...e,createdAt:this.getCurrentTimestamp()}})}catch(e){this.handleError(e,"")}}async getLatestVersion(e){try{return await this.db.ruleVersion.findFirst({where:{ruleId:e},orderBy:{versionNumber:"desc"}})}catch(e){this.handleError(e,"")}}async getVersions(e){try{return await this.db.ruleVersion.findMany({where:{ruleId:e},orderBy:{createdAt:"desc"}})}catch(e){this.handleError(e,"Failed to get rule versions")}}async getVersion(e,r){try{return await this.db.ruleVersion.findFirst({where:{ruleId:e,versionNumber:r},include:{creator:{select:{id:!0,username:!0}}}})}catch(e){this.handleError(e,"Failed to get rule version")}}}var Gr=Object.defineProperty,__publicField=(e,r,n)=>((e,r,n)=>r in e?Gr(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);class RuleService{constructor(e,r,n){this.db=e,this.r2=r,__publicField(this,"ruleRepository"),__publicField(this,"organizationRepository"),__publicField(this,"logger"),this.ruleRepository=new RuleRepository(e),this.organizationRepository=new OrganizationRepository(e),this.logger=createLogger()}async createRule(e,r){this.logger.debug("Creating rule for userId",{userId:e});const n=await this.db.user.findUnique({where:{id:e}});if(this.logger.debug("User found",{user:n}),!n){console.error("User not found:",e);const r=await this.db.user.findMany({select:{id:!0,email:!0}});throw console.error("All users in DB:",r),new i("NOT_FOUND",{message:""})}if(r.organizationId){if(!await this.organizationRepository.isMember(r.organizationId,e))throw new i("FORBIDDEN",{message:""})}if(await this.ruleRepository.findByName(r.name,r.organizationId))throw new i("CONFLICT",{message:""});const a=nanoid(),o=await this.ruleRepository.create({id:a,name:r.name,userId:e,description:r.description||null,visibility:r.visibility,tags:r.tags?JSON.stringify(r.tags):null,publishedAt:null,downloads:0,stars:0,version:"1.0.0",latestVersionId:null,organizationId:r.organizationId||null}),s=await this.ruleRepository.createVersion({id:nanoid(),ruleId:a,versionNumber:"1.0.0",contentHash:await this.hashContent(r.content),changelog:"Initial version",r2ObjectKey:`rules/${a}/1.0.0`,createdBy:e});return await this.saveContentToR2(a,s.versionNumber,r.content),await this.ruleRepository.update(a,{latestVersionId:s.id}),{rule:o,version:s,content:r.content}}async getRule(e,r,n){this.logger.debug("getRule called with",{nameOrId:e,owner:r,userId:n});let a=null;if(r){this.logger.debug("Looking for owner",{owner:r});const n=await this.db.user.findUnique({where:{username:r},select:{id:!0}});if(n)this.logger.debug("Owner is a user",{user:n}),a=await this.ruleRepository.findByNameAndUserId(e,n.id);else{const n=await this.organizationRepository.findByName(r);if(!n)throw new i("NOT_FOUND",{message:` '${r}' `});this.logger.debug("Owner is an organization",{org:n}),a=await this.ruleRepository.findByName(e,n.id)}}else this.logger.debug("Looking for rule by ID or name",{nameOrId:e}),a=await this.ruleRepository.findById(e,!0),a||(a=await this.ruleRepository.findByName(e));if(!a)throw new i("NOT_FOUND",{message:""});await this.checkRuleAccess(a,n);const o=await this.ruleRepository.getLatestVersion(a.id);if(!o)throw new i("NOT_FOUND",{message:""});return{rule:a,version:o,content:await this.getContentFromR2(a.id,o.versionNumber)}}async updateRule(e,r,n){const a=await this.ruleRepository.findById(e);if(!a)throw new i("NOT_FOUND",{message:""});if(a.userId!==r)throw new i("FORBIDDEN",{message:""});if(void 0===n.description&&void 0===n.tags||await this.ruleRepository.update(e,{description:n.description,tags:n.tags?JSON.stringify(n.tags):void 0}),n.content){const i=await this.ruleRepository.getLatestVersion(e),o=(null==i?void 0:i.versionNumber)||"0.0.0",s=this.incrementVersion(o),u=await this.ruleRepository.createVersion({id:nanoid(),ruleId:e,versionNumber:s,contentHash:await this.hashContent(n.content),changelog:n.changelog||"Updated content",r2ObjectKey:`rules/${e}/${s}`,createdBy:r});return await this.saveContentToR2(e,s,n.content),await this.ruleRepository.update(e,{version:s,latestVersionId:u.id,updatedAt:this.getCurrentTimestamp()}),{rule:a,version:u}}return{rule:a}}async publishRule(e,r){const n=await this.ruleRepository.findById(e);if(!n)throw new i("NOT_FOUND",{message:""});if(n.userId!==r)throw new i("FORBIDDEN",{message:""});if("private"===n.visibility)throw new i("BAD_REQUEST",{message:""});return await this.ruleRepository.update(e,{publishedAt:this.getCurrentTimestamp()}),{message:""}}async deleteRule(e,r){const n=await this.ruleRepository.findById(e);if(!n)throw new i("NOT_FOUND",{message:""});if(!await this.canDeleteRule(n,r))throw new i("FORBIDDEN",{message:""});return await this.deleteRuleContents(e),await this.ruleRepository.delete(e),{message:""}}async pullRule(e,r){var n,a;const o=await this.ruleRepository.findById(e,!0);if(!o)throw new i("NOT_FOUND",{message:""});await this.checkRuleAccess(o,r),await this.ruleRepository.incrementDownloadCount(e);const s=await this.ruleRepository.getLatestVersion(e);if(!s)throw new i("NOT_FOUND",{message:""});const u=await this.getContentFromR2(e,s.versionNumber);return{name:o.name,description:o.description,content:u,version:s.versionNumber,tags:o.tags?JSON.parse(o.tags):[],organization:null==(n=o.organization)?void 0:n.name,creator:null==(a=o.user)?void 0:a.username}}async searchPublicRules(e){return await this.ruleRepository.findPublicRules(e.page,e.pageSize,e.query)}async getUserRules(e,r,n){return await this.ruleRepository.findByCreatorId(e,r,n)}async getRuleById(e,r){const n=await this.ruleRepository.findById(e);if(!n)throw new i("NOT_FOUND",{message:"Rule not found"});return await this.checkRuleAccess(n,r),n}async getRuleContent(e,r,n){const a=await this.ruleRepository.findById(e);if(!a)throw new i("NOT_FOUND",{message:"Rule not found"});await this.checkRuleAccess(a,n);let o=r;if(!o){const r=await this.ruleRepository.getLatestVersion(e);if(!r)throw new i("NOT_FOUND",{message:"No version found for this rule"});o=r.versionNumber}const s=await this.getContentFromR2(e,o);return{id:e,name:a.name,version:o,content:s}}async getRuleVersions(e,r){const n=await this.ruleRepository.findById(e);if(!n)throw new i("NOT_FOUND",{message:"Rule not found"});return await this.checkRuleAccess(n,r),this.ruleRepository.getVersions(e)}async getRuleVersion(e,r,n){const a=await this.ruleRepository.findById(e);if(!a)throw new i("NOT_FOUND",{message:"Rule not found"});await this.checkRuleAccess(a,n);const o=await this.ruleRepository.getVersion(e,r);if(!o)throw new i("NOT_FOUND",{message:"Version not found"});const s=await this.getContentFromR2(e,r);return{id:o.id,name:a.name,description:a.description,version:o.versionNumber,content:s,changelog:o.changelog,visibility:a.visibility,tags:a.tags?JSON.parse(a.tags):[],author:a.user,organization:a.organization,createdAt:o.createdAt,createdBy:o.creator,isLatest:o.id===a.latestVersionId}}async getRelatedRules(e,r,n){const a=await this.ruleRepository.findById(e);if(!a)throw new i("NOT_FOUND",{message:"Rule not found"});const o=a.tags?"string"==typeof a.tags?JSON.parse(a.tags):a.tags:[],s={AND:[{id:{not:e}},{publishedAt:{not:null}},{OR:[...o.length>0?o.map(e=>({tags:{contains:`"${e}"`}})):[],{userId:a.userId}]}]};n&&n===a.userId||s.AND.push({visibility:"public"});return(await this.db.rule.findMany({where:s,include:{user:{select:{id:!0,username:!0}}},orderBy:[{stars:"desc"},{downloads:"desc"},{updatedAt:"desc"}],take:r})).map(e=>({id:e.id,name:e.name,description:e.description,author:e.user||{id:e.userId||"",username:"Unknown"},visibility:e.visibility,tags:e.tags?"string"==typeof e.tags?JSON.parse(e.tags):e.tags:[],version:e.version||"1.0.0",updated_at:e.updatedAt}))}async recordView(e,r){if(!await this.ruleRepository.findById(e))throw new i("NOT_FOUND",{message:"Rule not found"});if(r){await this.db.ruleDownload.findFirst({where:{ruleId:e,userId:r}})||(await this.db.ruleDownload.create({data:{id:nanoid(),ruleId:e,userId:r,ipAddress:"0.0.0.0",userAgent:"Unknown",createdAt:this.getCurrentTimestamp()}}),await this.db.rule.update({where:{id:e},data:{downloads:{increment:1}}}))}return{success:!0,message:"View recorded"}}async listRules(e){const r={};"public"===e.visibility?r.AND=[{visibility:"public"},{publishedAt:{not:null}}]:"private"===e.visibility&&e.userId?r.AND=[{visibility:"private"},{userId:e.userId}]:"all"===e.visibility&&e.userId?r.OR=[{userId:e.userId},{AND:[{visibility:"public"},{publishedAt:{not:null}}]}]:r.AND=[{visibility:"public"},{publishedAt:{not:null}}],e.tags&&e.tags.length>0&&(r.AND=[...r.AND||[],{OR:e.tags.map(e=>({tags:{contains:`"${e}"`}}))}]),e.author&&(r.user={username:e.author});const[n,i]=await Promise.all([this.db.rule.findMany({where:r,include:{user:{select:{id:!0,username:!0}}},orderBy:{updatedAt:"desc"},skip:e.offset,take:e.limit}),this.db.rule.count({where:r})]);return{rules:n.map(e=>({id:e.id,name:e.name,description:e.description,author:e.user||{id:e.userId||"",username:"Unknown"},visibility:e.visibility,tags:e.tags?"string"==typeof e.tags?JSON.parse(e.tags):e.tags:[],version:e.version||"1.0.0",updated_at:e.updatedAt})),total:i,limit:e.limit,offset:e.offset}}async searchRules(e){const r={};e.visibility?r.visibility=e.visibility:e.userId?r.OR=[{userId:e.userId},{AND:[{visibility:"public"},{publishedAt:{not:null}}]}]:r.AND=[{visibility:"public"},{publishedAt:{not:null}}],e.query&&(r.AND=[...r.AND||[],{OR:[{name:{contains:e.query}},{description:{contains:e.query}}]}]),e.tags&&e.tags.length>0&&(r.AND=[...r.AND||[],{OR:e.tags.map(e=>({tags:{contains:`"${e}"`}}))}]),e.author&&(r.user={username:e.author});const n={};switch(e.sortBy){case"newest":n.createdAt="desc";break;case"updated":default:n.updatedAt="desc";break;case"downloads":n.downloads="desc";break;case"stars":n.stars="desc"}const i=(e.page-1)*e.limit,[a,o]=await Promise.all([this.db.rule.findMany({where:r,include:{user:{select:{id:!0,username:!0,email:!0}},organization:{select:{id:!0,name:!0,displayName:!0}}},orderBy:n,skip:i,take:e.limit}),this.db.rule.count({where:r})]);return{rules:a.map(e=>{const r=e.user||{id:e.userId||"",username:"Unknown",email:""};return{id:e.id,name:e.name,userId:e.userId,visibility:e.visibility,description:e.description,tags:e.tags?"string"==typeof e.tags?JSON.parse(e.tags):e.tags:[],createdAt:e.createdAt,updatedAt:e.updatedAt,publishedAt:e.publishedAt,version:e.version||"1.0.0",latestVersionId:e.latestVersionId,downloads:e.downloads,stars:e.stars,organizationId:e.organizationId,user:e.user||r,organization:e.organization,author:r,updated_at:e.updatedAt,created_at:e.createdAt}}),total:o,page:e.page,limit:e.limit}}async checkRuleAccess(e,r){if(!e.publishedAt||"public"!==e.visibility){if(!r)throw new i("UNAUTHORIZED",{message:""});if(e.userId!==r){if("private"===e.visibility)throw new i("FORBIDDEN",{message:""});if("team"===e.visibility&&e.organizationId){if(!await this.organizationRepository.isMember(e.organizationId,r))throw new i("FORBIDDEN",{message:""})}}}}async canDeleteRule(e,r){return e.userId===r||!!e.organizationId&&await this.organizationRepository.isOwner(e.organizationId,r)}async hashContent(e){const r=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}async saveContentToR2(e,r,n){const i=`rules/${e}/versions/${r}/content.md`;await this.r2.put(i,n)}async getContentFromR2(e,r){const n=`rules/${e}/versions/${r}/content.md`,a=await this.r2.get(n);if(!a)throw new i("NOT_FOUND",{message:""});return await a.text()}async deleteRuleContents(e){const r=`rules/${e}/`,n=(await this.r2.list({prefix:r})).objects.map(e=>this.r2.delete(e.key));await Promise.all(n)}getCurrentTimestamp(){return Math.floor(Date.now()/1e3)}incrementVersion(e){const r=e.split("."),n=Number.parseInt(r[2]||"0",10)+1;return`${r[0]}.${r[1]}.${n}`}}const Qr={getByPath:Er.rules.getByPath.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:a,env:o}=r,s=new RuleService(n,o.R2,o),u=function(e){if(!e||""===e.trim())return null;const r=(e.startsWith("@")?e.substring(1):e).split("/");return 1===r.length&&r[0]?{ruleName:r[0]}:2===r.length&&r[0]&&r[1]?{owner:r[0],ruleName:r[1]}:(r.length,null)}(e.path);if(!u)throw new i("BAD_REQUEST",{message:"Invalid rule path format. Expected @owner/rulename or rulename"});const{owner:d,ruleName:c}=u,l=await s.getRule(c,d,null==a?void 0:a.id),{rule:p,version:m,content:h}=l,g=p.user||{id:p.userId||"",username:"Unknown",email:""};return{id:p.id,name:p.name,userId:p.userId||null,visibility:p.visibility,description:p.description,tags:p.tags?"string"==typeof p.tags?JSON.parse(p.tags):p.tags:[],createdAt:p.createdAt,updatedAt:p.updatedAt,publishedAt:p.publishedAt,version:m.versionNumber||p.version||"1.0.0",latestVersionId:p.latestVersionId||m.id,downloads:p.downloads,stars:p.stars,organizationId:p.organizationId,user:p.user||g,organization:p.organization||null,author:g}}),create:Er.rules.create.use(Sr).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);createLogger().debug("Create rule handler - user",{user:i});return{id:(await o.createRule(i.id,e)).rule.id}}),update:Er.rules.update.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a),{id:s,...u}=e;return await o.updateRule(s,i.id,u),{success:!0,message:"Rule updated successfully"}}),list:Er.rules.list.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.listRules({visibility:e.visibility,tags:e.tags,author:e.author,limit:e.limit,offset:e.offset,userId:null==i?void 0:i.id})}),search:Er.rules.search.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.searchRules({query:e.query,tags:e.tags,author:e.author,visibility:e.visibility,sortBy:e.sortBy,page:e.page,limit:e.limit,userId:null==i?void 0:i.id})}),like:Er.rules.like.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.rule.findUnique({where:{id:e.ruleId}}))throw new i("NOT_FOUND",{message:"Rule not found"});if(await n.ruleStar.findUnique({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}))throw new i("CONFLICT",{message:"Already liked this rule"});return await n.ruleStar.create({data:{id:nanoid(),ruleId:e.ruleId,userId:a.id,createdAt:Math.floor(Date.now()/1e3)}}),await n.rule.update({where:{id:e.ruleId},data:{stars:{increment:1}}}),{success:!0,message:"Rule liked successfully"}}),unlike:Er.rules.unlike.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.ruleStar.findUnique({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}))throw new i("NOT_FOUND",{message:"Like not found"});return await n.ruleStar.delete({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}),await n.rule.update({where:{id:e.ruleId},data:{stars:{decrement:1}}}),{success:!0,message:"Rule unliked successfully"}}),get:Er.rules.get.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a),s=await o.getRuleById(e.id,null==i?void 0:i.id),u=s.user||{id:s.userId||"",username:"Unknown",email:""};return{id:s.id,name:s.name,userId:s.userId||null,visibility:s.visibility,description:s.description,tags:s.tags?"string"==typeof s.tags?JSON.parse(s.tags):s.tags:[],createdAt:s.createdAt,updatedAt:s.updatedAt,publishedAt:s.publishedAt,version:s.version||"1.0.0",latestVersionId:s.latestVersionId,downloads:s.downloads,stars:s.stars,organizationId:s.organizationId,user:s.user||u,organization:s.organization||null,author:u,created_at:s.createdAt,updated_at:s.updatedAt}}),getContent:Er.rules.getContent.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.getRuleContent(e.id,e.version,null==i?void 0:i.id)}),versions:Er.rules.versions.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a),s=await o.getRuleVersions(e.id,null==i?void 0:i.id);return await Promise.all(s.map(async e=>{const r=await n.user.findUnique({where:{id:e.createdBy},select:{id:!0,username:!0}});return{version:e.versionNumber,changelog:e.changelog||"",created_at:e.createdAt,createdBy:r||{id:e.createdBy,username:"Unknown"}}}))}),getVersion:Er.rules.getVersion.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a),s=await o.getRuleVersion(e.id,e.version,null==i?void 0:i.id),u=s.author?{id:s.author.id,username:s.author.username,email:s.author.email||""}:{id:"",username:"Unknown",email:""},d=s.createdBy?{id:s.createdBy.id,username:s.createdBy.username||"Unknown"}:{id:"",username:"Unknown"};return{...s,changelog:s.changelog||"",tags:Array.isArray(s.tags)?s.tags:[],author:u,createdBy:d}}),related:Er.rules.related.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.getRelatedRules(e.id,e.limit,null==i?void 0:i.id)}),view:Er.rules.view.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.recordView(e.ruleId,null==i?void 0:i.id)}),delete:Er.rules.delete.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return{success:!0,message:(await o.deleteRule(e.id,i.id)).message}}),listPublic:Er.rules.listPublic.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a);return await o.listRules({visibility:"public",tags:e.tags,author:e.author,limit:e.limit,offset:e.offset,userId:null==i?void 0:i.id})}),star:Er.rules.star.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.rule.findUnique({where:{id:e.ruleId}}))throw new i("NOT_FOUND",{message:"Rule not found"});if(await n.ruleStar.findUnique({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}))throw new i("CONFLICT",{message:"Already liked this rule"});return await n.ruleStar.create({data:{id:nanoid(),ruleId:e.ruleId,userId:a.id,createdAt:Math.floor(Date.now()/1e3)}}),await n.rule.update({where:{id:e.ruleId},data:{stars:{increment:1}}}),{success:!0,message:"Rule starred successfully"}}),unstar:Er.rules.unstar.use(_r).handler(async({input:e,context:r})=>{const{db:n,user:a}=r;if(!await n.ruleStar.findUnique({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}))throw new i("NOT_FOUND",{message:"Like not found"});return await n.ruleStar.delete({where:{ruleId_userId:{ruleId:e.ruleId,userId:a.id}}}),await n.rule.update({where:{id:e.ruleId},data:{stars:{decrement:1}}}),{success:!0,message:"Rule unstarred successfully"}}),getVersionHistory:Er.rules.getVersionHistory.use(Ar).handler(async({input:e,context:r})=>{const{db:n,user:i,env:a}=r,o=new RuleService(n,a.R2,a),s=await o.getRuleVersions(e.ruleId,null==i?void 0:i.id);return await Promise.all(s.map(async e=>{const r=await n.user.findUnique({where:{id:e.createdBy},select:{id:!0,username:!0}});return{version:e.versionNumber,changelog:e.changelog||"",created_at:e.createdAt,createdBy:r||{id:e.createdBy,username:"Unknown"}}}))})},Yr=Er.users.searchByUsername.use(_r).handler(async({input:e,context:r})=>{const{username:n,limit:i}=e,{db:a}=r;return await a.user.findMany({where:{username:{contains:n.toLowerCase()}},select:{id:!0,username:!0,email:!0},take:i,orderBy:{username:"asc"}})}),Xr=Er.users.getProfile.use(xr).handler(async({input:e,context:r})=>{const{username:n}=e,{db:a}=r,o=await a.user.findUnique({where:{username:n.toLowerCase()},select:{id:!0,email:!0,username:!0,emailVerified:!0,createdAt:!0,updatedAt:!0}});if(!o){throw new i("NOT_FOUND",{message:Dr.userNotFound("ja")})}const[s,u]=await Promise.all([a.rule.count({where:{userId:o.id,visibility:"public"}}),a.organizationMember.count({where:{userId:o.id}})]),d=await a.rule.findMany({where:{userId:o.id,visibility:"public"},select:{id:!0,name:!0,description:!0,visibility:!0,createdAt:!0,updatedAt:!0,organization:{select:{name:!0}}},orderBy:{updatedAt:"desc"},take:5});return{user:{id:o.id,username:o.username,email:o.email,emailVerified:o.emailVerified,createdAt:o.createdAt,updatedAt:o.updatedAt},stats:{rulesCount:s,organizationsCount:u},recentRules:d.map(e=>({...e,description:e.description||""}))}}),en=Er.users.profile.use(_r).handler(async({context:e})=>{const{db:r,user:n}=e,a=await r.user.findUnique({where:{id:n.id},select:{id:!0,email:!0,username:!0,createdAt:!0,updatedAt:!0}});if(!a)throw new i("NOT_FOUND",{message:"User not found"});return{id:a.id,email:a.email,username:a.username,created_at:a.createdAt,updated_at:a.updatedAt}}),tn=Er.users.updateProfile.use(_r).handler(async({input:e,context:r})=>{const{email:n,username:a}=e,{db:o,user:s}=r;if(n){if(await o.user.findFirst({where:{email:n.toLowerCase(),id:{not:s.id}}})){throw new i("CONFLICT",{message:Dr.emailAlreadyInUse("ja")})}}if(a){if(await o.user.findFirst({where:{username:a.toLowerCase(),id:{not:s.id}}})){throw new i("CONFLICT",{message:Dr.usernameAlreadyInUse("ja")})}}const u=await o.user.update({where:{id:s.id},data:{...n&&{email:n.toLowerCase(),emailVerified:!1},...a&&{username:a.toLowerCase()},updatedAt:Math.floor(Date.now()/1e3)}});if(n&&n.toLowerCase()!==s.email.toLowerCase()){const{EmailVerificationService:e}=await import("./emailVerification.mjs"),i=new e(o,r.env);await i.sendVerificationEmail(s.id,n.toLowerCase())}return{user:{id:u.id,email:u.email,username:u.username,emailVerified:u.emailVerified,createdAt:u.createdAt,updatedAt:u.updatedAt}}}),rn={searchByUsername:Yr,getProfile:Xr,profile:en,updateProfile:tn,changePassword:Er.users.changePassword.use(_r).handler(async({input:e,context:r})=>{const{currentPassword:n,newPassword:a}=e,{db:o,user:s}=r,u=await o.user.findUnique({where:{id:s.id},select:{passwordHash:!0}});if(!u||!u.passwordHash){throw new i("BAD_REQUEST",{message:Dr.passwordChangeNotAvailable("ja")})}const{verifyPassword:d,hashPassword:c}=await Promise.resolve().then(function(){return jr});if(!await d(n,u.passwordHash)){throw new i("UNAUTHORIZED",{message:Dr.invalidCurrentPassword("ja")})}const l=await c(a);return await o.user.update({where:{id:s.id},data:{passwordHash:l,updatedAt:Math.floor(Date.now()/1e3)}}),{success:!0}}),settings:Er.users.settings.use(_r).handler(async({context:e})=>{const{db:r,user:n}=e,a=await r.user.findUnique({where:{id:n.id},select:{id:!0,email:!0,username:!0,emailVerified:!0,createdAt:!0,updatedAt:!0}});if(!a)throw new i("NOT_FOUND",{message:"User not found"});return{id:a.id,email:a.email,username:a.username,email_verified:a.emailVerified,created_at:a.createdAt,updated_at:a.updatedAt}}),updateSettings:Er.users.updateSettings.use(_r).handler(async({input:e,context:r})=>{const{currentPassword:n,newPassword:a}=e,{db:o,user:s}=r;if(a){if(!n)throw new i("BAD_REQUEST",{message:"Current password is required"});const e=await o.user.findUnique({where:{id:s.id},select:{passwordHash:!0}});if(!e){throw new i("NOT_FOUND",{message:Dr.userNotFound("ja")})}if(!await verifyPassword(n,e.passwordHash||""))throw new i("UNAUTHORIZED",{message:"Invalid current password"});const r=await hashPassword(a);await o.user.update({where:{id:s.id},data:{passwordHash:r,updatedAt:Math.floor(Date.now()/1e3)}})}return{success:!0,message:"Settings updated successfully"}}),deleteAccount:Er.users.deleteAccount.use(_r).handler(async({input:e,context:r})=>{const{password:n,confirmation:a}=e,{db:o,user:s}=r;if("DELETE"!==a)throw new i("BAD_REQUEST",{message:"Invalid confirmation"});const u=await o.user.findUnique({where:{id:s.id},select:{passwordHash:!0,organizationMembers:{where:{role:"owner"},include:{organization:!0}}}});if(!u){throw new i("NOT_FOUND",{message:Dr.userNotFound("ja")})}if(!u.passwordHash)throw new i("BAD_REQUEST",{message:"Please use your OAuth provider to delete your account"});if(!await verifyPassword(n,u.passwordHash))throw new i("UNAUTHORIZED",{message:"Invalid password"});if(u.organizationMembers.length>0)for(const e of u.organizationMembers){if(await o.organizationMember.count({where:{organizationId:e.organizationId,role:"owner"}})<=1)throw new i("BAD_REQUEST",{message:"You must transfer ownership of your organizations before deleting your account"})}return await o.user.delete({where:{id:s.id}}),{success:!0,message:"Account deleted successfully"}})},nn=implement(Ir).$context().router({auth:Hr,rules:Qr,organizations:Kr,users:rn,health:Zr});export{EmailService as E,nn as a,registry as b,st as c,getLazyMeta as d,getRouter as e,fallbackContractConfig as f,getEventIteratorSchemaDetails as g,createContractedProcedure as h,isProcedure as i,createProcedureClient as j,t as k,Dr as l,generateId as m,resolveContractProcedures as r,traverseContractProcedures as t,unlazy as u,verifyJWT as v};
//# sourceMappingURL=router.mjs.map
