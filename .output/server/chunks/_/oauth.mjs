function encodeBase64_internal(e,t,s){let n="";for(let i=0;i<e.byteLength;i+=3){let o=0,c=0;for(let t=0;t<3&&i+t<e.byteLength;t++)o=o<<8|e[i+t],c+=8;for(let e=0;e<4;e++)c>=6?(n+=t[o>>c-6&63],c-=6):c>0?(n+=t[o<<6-c&63],c=0):s===r.Include&&(n+="=")}return n}const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";var r,s;!function(e){e[e.Include=0]="Include",e[e.None=1]="None"}(r||(r={})),function(e){e[e.Required=0]="Required",e[e.Ignore=1]="Ignore"}(s||(s={}));const n=new class{uint8(e,t){if(e.byteLength<t+1)throw new TypeError("Insufficient bytes");return e[t]}uint16(e,t){if(e.byteLength<t+2)throw new TypeError("Insufficient bytes");return e[t]<<8|e[t+1]}uint32(e,t){if(e.byteLength<t+4)throw new TypeError("Insufficient bytes");let r=0;for(let s=0;s<4;s++)r|=e[t+s]<<24-8*s;return r}uint64(e,t){if(e.byteLength<t+8)throw new TypeError("Insufficient bytes");let r=0n;for(let s=0;s<8;s++)r|=BigInt(e[t+s])<<BigInt(56-8*s);return r}putUint8(e,t,r){if(e.length<r+1)throw new TypeError("Not enough space");if(t<0||t>255)throw new TypeError("Invalid uint8 value");e[r]=t}putUint16(e,t,r){if(e.length<r+2)throw new TypeError("Not enough space");if(t<0||t>65535)throw new TypeError("Invalid uint16 value");e[r]=t>>8,e[r+1]=255&t}putUint32(e,t,r){if(e.length<r+4)throw new TypeError("Not enough space");if(t<0||t>4294967295)throw new TypeError("Invalid uint32 value");for(let s=0;s<4;s++)e[r+s]=t>>8*(3-s)&255}putUint64(e,t,r){if(e.length<r+8)throw new TypeError("Not enough space");if(t<0||t>18446744073709551615n)throw new TypeError("Invalid uint64 value");for(let s=0;s<8;s++)e[r+s]=Number(t>>BigInt(8*(7-s))&0xffn)}};function rotr32(e,t){return(e<<32-t|e>>>t)>>>0}class SHA256{blockSize=64;size=32;blocks=new Uint8Array(64);currentBlockSize=0;H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);l=0n;w=new Uint32Array(64);update(e){if(this.l+=8n*BigInt(e.byteLength),this.currentBlockSize+e.byteLength<64)return this.blocks.set(e,this.currentBlockSize),void(this.currentBlockSize+=e.byteLength);let t=0;if(this.currentBlockSize>0){const r=e.slice(0,64-this.currentBlockSize);this.blocks.set(r,this.currentBlockSize),this.process(),t+=r.byteLength,this.currentBlockSize=0}for(;t+64<=e.byteLength;){const r=e.slice(t,t+64);this.blocks.set(r),this.process(),t+=64}if(e.byteLength-t>0){const r=e.slice(t);this.blocks.set(r),this.currentBlockSize=r.byteLength}}digest(){this.blocks[this.currentBlockSize]=128,this.currentBlockSize+=1,64-this.currentBlockSize<8&&(this.blocks.fill(0,this.currentBlockSize),this.process(),this.currentBlockSize=0),this.blocks.fill(0,this.currentBlockSize),n.putUint64(this.blocks,this.l,this.blockSize-8),this.process();const e=new Uint8Array(32);for(let t=0;t<8;t++)n.putUint32(e,this.H[t],4*t);return e}process(){for(let e=0;e<16;e++)this.w[e]=(this.blocks[4*e]<<24|this.blocks[4*e+1]<<16|this.blocks[4*e+2]<<8|this.blocks[4*e+3])>>>0;for(let e=16;e<64;e++){const t=(rotr32(this.w[e-2],17)^rotr32(this.w[e-2],19)^this.w[e-2]>>>10)>>>0,r=(rotr32(this.w[e-15],7)^rotr32(this.w[e-15],18)^this.w[e-15]>>>3)>>>0;this.w[e]=t+this.w[e-7]+r+this.w[e-16]|0}let e=this.H[0],t=this.H[1],r=this.H[2],s=this.H[3],n=this.H[4],o=this.H[5],c=this.H[6],a=this.H[7];for(let h=0;h<64;h++){const l=a+((rotr32(n,6)^rotr32(n,11)^rotr32(n,25))>>>0)+((n&o^~n&c)>>>0)+i[h]+this.w[h]|0,u=(e&t^e&r^t&r)>>>0;a=c,c=o,o=n,n=s+l|0,s=r,r=t,t=e,e=l+(((rotr32(e,2)^rotr32(e,13)^rotr32(e,22))>>>0)+u|0)|0}this.H[0]=e+this.H[0]|0,this.H[1]=t+this.H[1]|0,this.H[2]=r+this.H[2]|0,this.H[3]=s+this.H[3]|0,this.H[4]=n+this.H[4]|0,this.H[5]=o+this.H[5]|0,this.H[6]=c+this.H[6]|0,this.H[7]=a+this.H[7]|0}}const i=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);class OAuth2Tokens{data;constructor(e){this.data=e}tokenType(){if("token_type"in this.data&&"string"==typeof this.data.token_type)return this.data.token_type;throw new Error("Missing or invalid 'token_type' field")}accessToken(){if("access_token"in this.data&&"string"==typeof this.data.access_token)return this.data.access_token;throw new Error("Missing or invalid 'access_token' field")}accessTokenExpiresInSeconds(){if("expires_in"in this.data&&"number"==typeof this.data.expires_in)return this.data.expires_in;throw new Error("Missing or invalid 'expires_in' field")}accessTokenExpiresAt(){return new Date(Date.now()+1e3*this.accessTokenExpiresInSeconds())}hasRefreshToken(){return"refresh_token"in this.data&&"string"==typeof this.data.refresh_token}refreshToken(){if("refresh_token"in this.data&&"string"==typeof this.data.refresh_token)return this.data.refresh_token;throw new Error("Missing or invalid 'refresh_token' field")}hasScopes(){return"scope"in this.data&&"string"==typeof this.data.scope}scopes(){if("scope"in this.data&&"string"==typeof this.data.scope)return this.data.scope.split(" ");throw new Error("Missing or invalid 'scope' field")}idToken(){if("id_token"in this.data&&"string"==typeof this.data.id_token)return this.data.id_token;throw new Error("Missing or invalid field 'id_token'")}}function createS256CodeChallenge(e){const s=function(e){const t=new SHA256;return t.update(e),t.digest()}((new TextEncoder).encode(e));return encodeBase64_internal(s,t,r.None)}function createOAuth2Request(e,t){const r=(new TextEncoder).encode(t.toString()),s=new Request(e,{method:"POST",body:r});return s.headers.set("Content-Type","application/x-www-form-urlencoded"),s.headers.set("Accept","application/json"),s.headers.set("User-Agent","arctic"),s.headers.set("Content-Length",r.byteLength.toString()),s}function encodeBasicCredentials(t,s){return function(t){return encodeBase64_internal(t,e,r.Include)}((new TextEncoder).encode(`${t}:${s}`))}async function sendTokenRequest$1(e){let t;try{t=await fetch(e)}catch(e){throw new ArcticFetchError(e)}if(400===t.status||401===t.status){let e,r;try{e=await t.json()}catch{throw new UnexpectedResponseError(t.status)}if("object"!=typeof e||null===e)throw new UnexpectedErrorResponseBodyError(t.status,e);try{r=createOAuth2RequestError(e)}catch{throw new UnexpectedErrorResponseBodyError(t.status,e)}throw r}if(200===t.status){let e;try{e=await t.json()}catch{throw new UnexpectedResponseError(t.status)}if("object"!=typeof e||null===e)throw new UnexpectedErrorResponseBodyError(t.status,e);return new OAuth2Tokens(e)}throw null!==t.body&&await t.body.cancel(),new UnexpectedResponseError(t.status)}function createOAuth2RequestError(e){let t;if(!("error"in e)||"string"!=typeof e.error)throw new Error("Invalid error response");t=e.error;let r=null,s=null,n=null;if("error_description"in e){if("string"!=typeof e.error_description)throw new Error("Invalid data");r=e.error_description}if("error_uri"in e){if("string"!=typeof e.error_uri)throw new Error("Invalid data");s=e.error_uri}if("state"in e){if("string"!=typeof e.state)throw new Error("Invalid data");n=e.state}return new OAuth2RequestError(t,r,s,n)}class ArcticFetchError extends Error{constructor(e){super("Failed to send request",{cause:e})}}class OAuth2RequestError extends Error{code;description;uri;state;constructor(e,t,r,s){super(`OAuth request error: ${e}`),this.code=e,this.description=t,this.uri=r,this.state=s}}class UnexpectedResponseError extends Error{status;constructor(e){super("Unexpected error response"),this.status=e}}class UnexpectedErrorResponseBodyError extends Error{status;data;constructor(e,t){super("Unexpected error response body"),this.status=e,this.data=t}}class OAuth2Client{clientId;clientPassword;redirectURI;constructor(e,t,r){this.clientId=e,this.clientPassword=t,this.redirectURI=r}createAuthorizationURL(e,t,r){const s=new URL(e);return s.searchParams.set("response_type","code"),s.searchParams.set("client_id",this.clientId),null!==this.redirectURI&&s.searchParams.set("redirect_uri",this.redirectURI),s.searchParams.set("state",t),r.length>0&&s.searchParams.set("scope",r.join(" ")),s}createAuthorizationURLWithPKCE(e,t,r,s,n){const i=new URL(e);if(i.searchParams.set("response_type","code"),i.searchParams.set("client_id",this.clientId),null!==this.redirectURI&&i.searchParams.set("redirect_uri",this.redirectURI),i.searchParams.set("state",t),r===o.S256){const e=createS256CodeChallenge(s);i.searchParams.set("code_challenge_method","S256"),i.searchParams.set("code_challenge",e)}else r===o.Plain&&(i.searchParams.set("code_challenge_method","plain"),i.searchParams.set("code_challenge",s));return n.length>0&&i.searchParams.set("scope",n.join(" ")),i}async validateAuthorizationCode(e,t,r){const s=new URLSearchParams;s.set("grant_type","authorization_code"),s.set("code",t),null!==this.redirectURI&&s.set("redirect_uri",this.redirectURI),null!==r&&s.set("code_verifier",r),null===this.clientPassword&&s.set("client_id",this.clientId);const n=createOAuth2Request(e,s);if(null!==this.clientPassword){const e=encodeBasicCredentials(this.clientId,this.clientPassword);n.headers.set("Authorization",`Basic ${e}`)}return await sendTokenRequest$1(n)}async refreshAccessToken(e,t,r){const s=new URLSearchParams;s.set("grant_type","refresh_token"),s.set("refresh_token",t),null===this.clientPassword&&s.set("client_id",this.clientId),r.length>0&&s.set("scope",r.join(" "));const n=createOAuth2Request(e,s);if(null!==this.clientPassword){const e=encodeBasicCredentials(this.clientId,this.clientPassword);n.headers.set("Authorization",`Basic ${e}`)}return await sendTokenRequest$1(n)}async revokeToken(e,t){const r=new URLSearchParams;r.set("token",t),null===this.clientPassword&&r.set("client_id",this.clientId);const s=createOAuth2Request(e,r);if(null!==this.clientPassword){const e=encodeBasicCredentials(this.clientId,this.clientPassword);s.headers.set("Authorization",`Basic ${e}`)}await async function(e){let t;try{t=await fetch(e)}catch(e){throw new ArcticFetchError(e)}if(400===t.status||401===t.status){let e,r;try{e=await t.json()}catch{throw new UnexpectedErrorResponseBodyError(t.status,null)}if("object"!=typeof e||null===e)throw new UnexpectedErrorResponseBodyError(t.status,e);try{r=createOAuth2RequestError(e)}catch{throw new UnexpectedErrorResponseBodyError(t.status,e)}throw r}if(200!==t.status)throw null!==t.body&&await t.body.cancel(),new UnexpectedResponseError(t.status);null!==t.body&&await t.body.cancel()}(s)}}var o;!function(e){e[e.S256=0]="S256",e[e.Plain=1]="Plain"}(o||(o={}));const c="https://github.com/login/oauth/access_token";class GitHub{clientId;clientSecret;redirectURI;constructor(e,t,r){this.clientId=e,this.clientSecret=t,this.redirectURI=r}createAuthorizationURL(e,t){const r=new URL("https://github.com/login/oauth/authorize");return r.searchParams.set("response_type","code"),r.searchParams.set("client_id",this.clientId),r.searchParams.set("state",e),t.length>0&&r.searchParams.set("scope",t.join(" ")),null!==this.redirectURI&&r.searchParams.set("redirect_uri",this.redirectURI),r}async validateAuthorizationCode(e){const t=new URLSearchParams;t.set("grant_type","authorization_code"),t.set("code",e),null!==this.redirectURI&&t.set("redirect_uri",this.redirectURI);const r=createOAuth2Request(c,t),s=encodeBasicCredentials(this.clientId,this.clientSecret);r.headers.set("Authorization",`Basic ${s}`);return await sendTokenRequest(r)}async refreshAccessToken(e){const t=new URLSearchParams;t.set("grant_type","refresh_token"),t.set("refresh_token",e);const r=createOAuth2Request(c,t),s=encodeBasicCredentials(this.clientId,this.clientSecret);r.headers.set("Authorization",`Basic ${s}`);return await sendTokenRequest(r)}}async function sendTokenRequest(e){let t,r;try{t=await fetch(e)}catch(e){throw new ArcticFetchError(e)}if(200!==t.status)throw null!==t.body&&await t.body.cancel(),new UnexpectedResponseError(t.status);try{r=await t.json()}catch{throw new UnexpectedResponseError(t.status)}if("object"!=typeof r||null===r)throw new UnexpectedErrorResponseBodyError(t.status,r);if("error"in r&&"string"==typeof r.error){let e;try{e=createOAuth2RequestError(r)}catch{throw new UnexpectedErrorResponseBodyError(t.status,r)}throw e}return new OAuth2Tokens(r)}const a="https://oauth2.googleapis.com/token";class Google{client;constructor(e,t,r){this.client=new OAuth2Client(e,t,r)}createAuthorizationURL(e,t,r){return this.client.createAuthorizationURLWithPKCE("https://accounts.google.com/o/oauth2/v2/auth",e,o.S256,t,r)}async validateAuthorizationCode(e,t){return await this.client.validateAuthorizationCode(a,e,t)}async refreshAccessToken(e){return await this.client.refreshAccessToken(a,e,[])}async revokeToken(e){await this.client.revokeToken("https://oauth2.googleapis.com/revoke",e)}}function createOAuthProviders(e){const t=e.APP_URL||"http://localhost:3000";return{google:new Google(e.GOOGLE_CLIENT_ID||"",e.GOOGLE_CLIENT_SECRET||"",`${t}/auth/callback/google`),github:new GitHub(e.GH_OAUTH_CLIENT_ID||"",e.GH_OAUTH_CLIENT_SECRET||"",`${t}/auth/callback/github`)}}function generateState(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}function generateCodeVerifier(){const e=new Uint8Array(32);return crypto.getRandomValues(e),btoa(String.fromCharCode(...e)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}export{createOAuthProviders,generateCodeVerifier,generateState};
//# sourceMappingURL=oauth.mjs.map
