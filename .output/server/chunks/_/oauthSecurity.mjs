import{k as e,l as r}from"./router.mjs";import{O as t}from"./client.DwfV9Oyl.mjs";import"node:buffer";import"../nitro/nitro.mjs";import"node:events";import"node:process";import"cloudflare:workers";import"node:timers";import"@prisma/client";import"node:util";const o={STATE_EXPIRATION:600,MAX_PENDING_STATES_PER_IP:5,OAUTH_RATE_LIMIT:{windowMs:9e5,maxRequests:10}};function validateRedirectUrl(e,r){try{const t=new URL(e);return!(!e.startsWith("/")||e.startsWith("//"))||r.some(e=>{if(e.startsWith("*.")){const r=e.slice(2);return t.hostname===r||t.hostname.endsWith(`.${r}`)}return t.hostname===e})}catch{return!1}}async function performOAuthSecurityChecks(e,s,a="ja"){if((await e.oAuthState.findMany({where:{clientIp:s,expiresAt:{gte:Math.floor(Date.now()/1e3)}}})).length>=o.MAX_PENDING_STATES_PER_IP)throw new t("TOO_MANY_REQUESTS",{message:r.tooManyOAuthAttempts(a)})}function generateNonce(){const e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}function validateOAuthResponse(r,o="ja"){if(r.error){const s={access_denied:"errors.oauth.accessDenied",invalid_request:"errors.oauth.invalidRequest",unauthorized_client:"errors.oauth.unauthorizedClient",unsupported_response_type:"errors.oauth.unsupportedResponseType",invalid_scope:"errors.oauth.invalidScope",server_error:"errors.oauth.serverError",temporarily_unavailable:"errors.oauth.temporarilyUnavailable"}[r.error],a=s?e(s,o):r.error_description||e("errors.oauth.authFailed",o);throw new t("BAD_REQUEST",{message:a})}if(!r.code||!r.state)throw new t("BAD_REQUEST",{message:e("errors.oauth.missingParams",o)});if(r.code.length<10||r.code.length>1024)throw new t("BAD_REQUEST",{message:e("errors.oauth.invalidCode",o)});if(r.state.length<10||r.state.length>1024)throw new t("BAD_REQUEST",{message:e("errors.oauth.invalidState",o)})}export{o as OAUTH_CONFIG,generateNonce,performOAuthSecurityChecks,validateOAuthResponse,validateRedirectUrl};
//# sourceMappingURL=oauthSecurity.mjs.map
