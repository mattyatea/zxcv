import{O as e}from"../../_/index2.mjs";import{g as o,v as s,O as r,o as t}from"../../_/client.DwfV9Oyl.mjs";import{e as n}from"../../_/index.mjs";import{d as a,r as i,s as l,a as c,g as d}from"../../nitro/nitro.mjs";import{v as h,a as p}from"../../_/router.mjs";import"../../_/index3.mjs";import"../../_/index4.mjs";import"../../_/openapi-client.D3eD5ojB.mjs";import"node:events";import"node:process";import"cloudflare:workers";import"node:buffer";import"node:timers";import"@prisma/client";import"node:util";const u=new e(p,{plugins:[new class{options;order=9e6;constructor(e={}){this.options={origin:e=>e,allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],...e}}init(e){e.rootInterceptors??=[],e.rootInterceptors.unshift(async e=>{if("OPTIONS"===e.request.method){const s={};void 0!==this.options.maxAge&&(s["access-control-max-age"]=this.options.maxAge.toString()),this.options.allowMethods?.length&&(s["access-control-allow-methods"]=o(this.options.allowMethods));const r=this.options.allowHeaders??e.request.headers["access-control-request-headers"];return("string"==typeof r||r?.length)&&(s["access-control-allow-headers"]=o(r)),{matched:!0,response:{status:204,headers:s,body:void 0}}}return e.next()}),e.rootInterceptors.unshift(async e=>{const r=await e.next();if(!r.matched)return r;const t=o(e.request.headers.origin)??"",n=await s(this.options.origin,t,e),a=Array.isArray(n)?n:[n];a.includes("*")?r.response.headers["access-control-allow-origin"]="*":(a.includes(t)&&(r.response.headers["access-control-allow-origin"]=t),r.response.headers.vary=e.request.headers.vary??"origin");const i=await s(this.options.timingOrigin,t,e),l=Array.isArray(i)?i:[i];return l.includes("*")?r.response.headers["timing-allow-origin"]="*":l.includes(t)&&(r.response.headers["timing-allow-origin"]=t),this.options.credentials&&(r.response.headers["access-control-allow-credentials"]="true"),this.options.exposeHeaders?.length&&(r.response.headers["access-control-expose-headers"]=o(this.options.exposeHeaders)),r})}},new n],interceptors:[t(e=>{throw console.log("oRPC onError interceptor:",{error:e,isORPCError:e instanceof r,code:null==e?void 0:e.code,message:null==e?void 0:e.message}),e})]}),m=a(async e=>{var o,s;console.log("API handler called:",{method:e.node.req.method,url:e.node.req.url,path:e.path});const t=e.context;if(!t.cloudflare){const e={DB:globalThis.DB||void 0,R2:globalThis.R2||void 0,EMAIL_SENDER:globalThis.EMAIL_SENDER||void 0,KV_CACHE:globalThis.KV_CACHE||void 0,JWT_SECRET:globalThis.JWT_SECRET||"test-secret",JWT_ALGORITHM:"HS256",JWT_EXPIRES_IN:"1h",EMAIL_FROM:"test@example.com",FRONTEND_URL:"http://localhost:3000",RATE_LIMIT_ANONYMOUS:"100",RATE_LIMIT_AUTHENTICATED:"1000",RATE_LIMIT_API_KEY:"5000"};t.cloudflare={env:e,context:{waitUntil:()=>{},passThroughOnException:()=>{},props:{}},request:new Request("http://localhost")}}try{const s=await async function(e){const o=d(e,"authorization");if(!(null==o?void 0:o.startsWith("Bearer ")))return;const s=o.substring(7),r=e.context.cloudflare.env;if(r)try{const e=await h(s,r);if(!e)return;return{id:e.sub,email:e.email,username:e.username,emailVerified:e.emailVerified||!1}}catch{return}}(e),n=new URL(e.node.req.url||"",`http://${e.node.req.headers.host||"localhost"}`),a=new Headers;for(const[o,s]of Object.entries(e.node.req.headers))s&&a.set(o,Array.isArray(s)?s.join(", "):String(s));const p="GET"!==e.node.req.method&&"HEAD"!==e.node.req.method?await i(e):void 0,m=new Request(n,{method:e.node.req.method,headers:a,body:p});let g;console.log("Request URL:",n.toString()),console.log("Request method:",e.node.req.method),console.log("User authenticated:",!!s);try{g=await u.handle(m,{prefix:"/api",context:{user:s,env:t.cloudflare.env,cloudflare:t.cloudflare}})}catch(e){throw console.error("Handler error details:",{error:e,message:null==e?void 0:e.message,code:null==e?void 0:e.code,stack:null==e?void 0:e.stack,isORPCError:e instanceof r}),e}if(console.log("Response matched:",g.matched),console.log("Response status:",null==(o=g.response)?void 0:o.status),!g.matched)return l(e,404,"Not Found"),{error:"Not found"};l(e,g.response.status),g.response.headers.forEach((o,s)=>{c(e,s,o)});const E=g.response.headers.get("content-type");return(null==E?void 0:E.includes("application/json"))?await g.response.json():await g.response.text()}catch(o){if(console.error("OpenAPI Handler Error:",o),console.error("Error type:",null==(s=null==o?void 0:o.constructor)?void 0:s.name),console.error("Is ORPCError:",o instanceof r),o&&"object"==typeof o&&"response"in o&&o.response instanceof Response){const s=o.response;console.log("Error has Response object, status:",s.status),l(e,s.status),s.headers.forEach((o,s)=>{c(e,s,o)});const r=s.headers.get("content-type");return(null==r?void 0:r.includes("application/json"))?await s.json():await s.text()}if(o instanceof r||o&&"object"==typeof o&&"code"in o&&"__isORPCError"in o){const s=o;console.log("Handling ORPCError:",{code:s.code,message:s.message});const r={UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,BAD_REQUEST:400,CONFLICT:409,INTERNAL_SERVER_ERROR:500}[s.code]||500;return l(e,r),{defined:!1,code:s.code,status:r,message:s.message||"An error occurred",data:s.data}}return console.error("Unhandled error type, returning 500"),l(e,500),{defined:!1,code:"INTERNAL_SERVER_ERROR",status:500,message:"Internal server error"}}});export{m as default};
//# sourceMappingURL=_..._.mjs.map
